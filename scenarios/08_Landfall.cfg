#textdomain wesnoth-Flight_Freedom

[scenario]
    name= _ "Landfall"
    {MAP 08}
    {TURNS 56 48 40}
    {SCENARIO_MUSIC loyalists.ogg}
    id=Landfall
    next_scenario="Drake_Escape"

    {STORY_LANDFALL}

    {DAWN}
    {MORNING}
    {AFTERNOON}
    {DUSK}
    {FIRST_WATCH}
    {SECOND_WATCH}

    [side]
        save_id=Malakar
        type=Pirate Galleon2
        id=Unforgiver
        name= _ "Unforgiver"
        side=1
        {FLAG_VARIANT drake}
        canrecruit=yes
        controller=human
        # Player is given additional gold upon landing, so it is okay that this is lower than the default of 100:
        {GOLD 90 50 10} # (plus there should be a carryover, anyways)
        # income is set later after we have landed
        recruit=Drake Hatchling,Drake Slave,Drake Burner,Drake Glider,Drake Fighter,Drake Clasher,Pirate Sloop
        unrenamable=yes
        team_name=good
        user_team_name= _ "Skullbone Pirates"
        fog=no
    [/side]
    [side]
        type=Orcish Warlord
        id=Skula-Teroa
        name= _ "Skula-Teroa"
        side=2
        {FLAG_VARIANT6 ragged}
        controller=ai
        canrecruit=yes
        {GOLD 100 250 300}
        recruit=Orcish Grunt,Orcish Archer,Orcish Assassin,Troll Whelp,Goblin Spearman,Goblin Knight
        team_name=evil
        user_team_name= _ "Local Orcish Tribe"
    [/side]
    [side]
        side=3
        {FLAG_VARIANT loyalist}
        controller=ai
        {GOLD 200 290 380}
        recruit=Spearman,Bowman,Cavalryman,Fencer,Mage
        team_name=evil2
        user_team_name= _ "Wesnoth Expeditionary Force"
        #keeps Jako from appearing until he lands
        no_leader=yes
        [ai]
            [goal]
                [criteria]
                    side=1
                    race=boat
                [/criteria]
                {QUANTITY value 3.6 3.9 4.2}
            [/goal]
        [/ai]
    [/side]
    #side of the Passing Wind
    [side]
        side=4
        {FLAG_VARIANT loyalist}
        controller=ai
        team_name=evil2
        gold=0
        recruit=
        #prevents movement
        [ai]
            ai_algorithm="idle_ai"
        [/ai]
        no_leader=yes
        user_team_name= _ "Wesnoth Royal Navy"
        color=green
    [/side]
    #side of the Thunder Spirits
    [side]
        side=5
        {FLAG_VARIANT6 ragged}
        controller=ai
        team_name=evil3
        gold=0
        recruit=
        no_leader=yes
        color=purple
        [ai]
            aggression=1.0
            leader_value=0
            village_value=0
            grouping=no
            caution=0.1
            simple_targeting=yes
        [/ai]
        user_team_name= _ "Monsters"
    [/side]

#ifdef EASY
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Orcish Assassin" 1}
#else
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Orcish Assassin" 2}
#endif

    {OBJECTIVES_HEADER_BEGIN}
        {CONDITION_WIN ( _ "Move the Unforgiver to the eastern pier")}
        {CONDITION_LOSE ( _ "Destruction of the Unforgiver")}
        {OBJECTIVES_LOSE}
        {GOLD_CARRYOVER_STANDARD}
    {OBJECTIVES_FOOTER_BEGIN}

    [item]
        x,y=42,45
        image=items/orcish-flag.png
    [/item]
    [item]
        x,y=43,33
        image=items/orcish-flag.png
    [/item]
    [item]
        x,y=47,34
        image=items/orcish-flag.png
    [/item]
    [item]
        x,y=31,44
        image=items/orcish-flag.png
    [/item]

    [event]
        name=prestart
        #moves the Unforgiver into position
        [teleport]
            [filter]
                id=Unforgiver
            [/filter]
            x=17
            y=1
        [/teleport]
        {RECALL_BOATS}
        {SCATTER_IMAGE (
            terrain=Gg
            #to keep flags off of the island
            x=1-50
            y=11-50
        ) 3 {RED_BANNER}}
        {VARIABLE spirit_last_turn no}
        [set_variable]
            name=passing_wind_moveto
            value=2
        [/set_variable]
        [set_variable]
            name=malakar_disembarked
            value=no
        [/set_variable]
        [set_variable]
            name=jako_disembarked
            value=0
        [/set_variable]
        {VARIABLE first_step_effects no}
    [/event]

    [event]
        name=start
        [lock_view]
        [/lock_view]
        [scroll_to_unit]
            id=Unforgiver
            immediate=yes
        [/scroll_to_unit]
        {HIGHLIGHT_IMAGE 44 17 items/gohere.png ()}
        [unlock_view]
        [/unlock_view]
    [/event]

    #moves Malakar out of the ship
    [event]
        name=moveto
        [filter]
            x=44
            y=17
            id=Unforgiver
        [/filter]
        [set_variable]
            name=malakar_disembarked
            value=yes
        [/set_variable]
        [remove_item]
            x,y=44,17
        [/remove_item]
        #makes Malakar the leader
        {VARIABLE malakar_store.canrecruit yes}
        #unstores Malakar
        [unstore_unit]
            variable=malakar_store
        [/unstore_unit]
        #wmllint: recognize Malakar
        #wmllint: recognize Kogw
        #moves Malakar into position
        [teleport]
            [filter]
                id=Malakar
            [/filter]
            x=45
            y=18
        [/teleport]
        #unstores Kogw
        [unstore_unit]
            placement=leader
            variable=kogw_store
        [/unstore_unit]
        #moves Kogw into position
        [teleport]
            [filter]
                id=Kogw
            [/filter]
            x=45
            y=19
        [/teleport]
        #cleans up the variables
        {CLEAR_VARIABLE malakar_store}
        {CLEAR_VARIABLE kogw_store}
        #removes leadership from the Unforgiver
        [store_unit]
            [filter]
                id=Unforgiver
            [/filter]
            variable=unforgiver_store
        [/store_unit]
        {VARIABLE unforgiver_store.canrecruit no}
        [unstore_unit]
            variable=unforgiver_store
        [/unstore_unit]
        {CLEAR_VARIABLE unforgiver_store}
        {MAKE_LOYAL_HERO Unforgiver} # (since its death will still cause defeat)
        [gold]
            side=1
            {QUANTITY amount 90 60 30}
        [/gold]
        [modify_side]
            side=1
            user_team_name= _ "Kakatar Tribe"
            {INCOME 9 5 1}
        [/modify_side]
        #refreshes the screen
        [redraw]
        [/redraw]
        [if]
            [variable]
                name=jako_disembarked
                numerical_not_equals=0
            [/variable]
            [then]
                {OBJECTIVES_HEADER}
                    {CONDITION_WIN ( _ "Defeat both enemy leaders")}
                    {CONDITION_LOSE ( _ "Destruction of the Unforgiver")}
                    {OBJECTIVES_LOSE}
                    {GOLD_CARRYOVER_STANDARD}
                {OBJECTIVES_FOOTER}
            [/then]
            [else]
                {OBJECTIVES_HEADER}
                    {CONDITION_WIN ( _ "Defeat enemy leader")}
                    {CONDITION_LOSE ( _ "Destruction of the Unforgiver")}
                    {OBJECTIVES_LOSE}
                    {GOLD_CARRYOVER_STANDARD}
                {OBJECTIVES_FOOTER}
            [/else]
        [/if]
        [event]
            name=enemies defeated
            [endlevel]
                result=victory
                bonus=yes
                carryover_percentage={ON_DIFFICULTY 80 70 60}
            [/endlevel]
        [/event]
    [/event]

    #bridge collapsing code
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x=13,14,15,16,17,18
            y=24,23,23,22,22,21
            side=1
            # cannot be set off by boats or flying units
            [not]
                type=Pirate Sloop,Pirate Cruiser,Pirate Galleon2,Drake Blademaster,Drake Burner,Drake Fighter,Fire Drake,Drake Flameheart,Drake Flare,Drake Glider,Hurricane Drake,Inferno Drake,Sky Drake,Drake Warrior,Drake Chieftain,Drake Lord,Drake Legend,Cave Drake
            [/not]
        [/filter]
        #waits until two units have moved to the bridge
        [set_variable]
            name=bridge_steps
            add=1
        [/set_variable]
        [if]
            [variable]
                name=bridge_steps
                numerical_equals=2
            [/variable]
            [then]
                [message]
                    speaker=unit
                    message= _ "Ieeeeee!" # wmllint: no spellcheck
                [/message]
                #brings the bridge down
                [sound]
                    name=gunshot.wav
                [/sound]
                [delay]
                    time=200
                [/delay]
                [sound]
                    name=gunshot.wav
                [/sound]
                [delay]
                    time=200
                [/delay]
                [sound]
                    name=gunshot.wav
                [/sound]
                [delay]
                    time=500
                [/delay]
                [sound]
                    name=fire.wav
                [/sound]
                [terrain]
                    x=13,14,15,16,17,18
                    y=24,23,23,22,22,21
                    terrain=Wwf^Dr #wmllint: ignore
                [/terrain]
                #kills the units on the bridge, including boats (presumably under it)
                [kill]
                    x=13,14,15,16,17,18
                    y=24,23,23,22,22,21
                    animate=no
                    #flying units unaffected
                    [not]
                        type=Drake Blademaster,Drake Burner,Drake Fighter,Fire Drake,Drake Flameheart,Drake Flare,Drake Glider,Hurricane Drake,Inferno Drake,Sky Drake,Drake Warrior,Drake Chieftain,Drake Lord,Cave Drake
                    [/not]
                [/kill]
                [redraw][/redraw]
                #checks to see if the main
                #characters were killed in the collapse
                [if]
                    [have_unit]
                        id=Malakar
                    [/have_unit]
                    [then]
                        [message]
                            speaker=Malakar
                            message= _ "The bridge collapsed!"
                        [/message]
                    [/then]
                    [else]
                        [message]
                            side=1
                            message= _ "The bridge collapsed!"
                        [/message]
                        [scroll_to]
                            x,y=$x1,$y1
                        [/scroll_to]
                        [endlevel]
                            result=defeat
                            music=defeat.ogg,defeat2.ogg
                        [/endlevel]
                        [break][/break]
                    [/else]
                [/if]
                [if]
                    [have_unit]
                        id=Kogw
                    [/have_unit]
                    [then]
                        [message]
                            speaker=Kogw
                            message= _ "Phew, good thing I wasn't standing on that rickety thing!"
                        [/message]
                    [/then]
                    [else]
                        [scroll_to]
                            x,y=$x1,$y1
                        [/scroll_to]
                        [endlevel]
                            result=defeat
                            music=defeat.ogg,defeat2.ogg
                        [/endlevel]
                        [break][/break]
                    [/else]
                [/if]
                [if]
                    [have_unit]
                        id=Unforgiver
                    [/have_unit]
                    [then]
                        [wml_message]
                            #po: debug message; ok to skip translating:
                            message= _ "The Unforgiver survived the bridge collapse!"
                            logger='debug'
                        [/wml_message]
                    [/then]
                    [else]
                        [message]
                            # We can assume we have him here since there was already a check for him previously:
                            speaker=Kogw
                            message= _ "Oh no, my ship!"
                        [/message]
                        [scroll_to]
                            x,y=$x1,$y1
                        [/scroll_to]
                        [endlevel]
                            result=defeat
                            music=defeat.ogg,defeat2.ogg
                        [/endlevel]
                        [break][/break]
                    [/else]
                [/if]
            [/then]
            [else]
                [if]
                    [variable]
                        name=first_step_effects
                        equals=no
                    [/variable]
                    [then]
                        {VARIABLE first_step_effects yes}
                        [sound]
                            name=gunshot.wav
                        [/sound]
                        [switch]
                            variable=unit.id
                            [case]
                                value="Malakar"
                                [message]
                                    speaker=unit
                                    message= _ "I do not trust this bridge!"
                                [/message]
                            [/case]
                            [case]
                                value="Kogw"
                                [message]
                                    speaker=unit
                                    message = _ "This bridge be rickety!"
                                [/message]
                            [/case]
                            [else]
                                [message]
                                    speaker=unit
                                    message= _ "I don't trust this bridge."
                                [/message]
                            [/else]
                        [/switch]
                    [/then]
                [/if]
                [allow_undo]
                [/allow_undo]
                [on_undo]
                    #fix exploit that would otherwise allow the player to bring it down on demand with one unit
                    [set_variable]
                        name=bridge_steps
                        sub=1
                    [/set_variable]
                [/on_undo]
            [/else]
        [/if]
    [/event]

    #humans appear
    [event]
        name=turn 3
        [unit]
            id=Passing Wind
            #po: This name is a pun:
            name= _ "Passing Wind"
            type=Dreadnought
            x=7
            y=1
            side=4
            animate=yes
            [modifications]
                {TRAIT_RESILIENT}
                {TRAIT_SLOW} # (since dreadnoughts are supposed to have MP of 7, but this is scripted to only move 6 spaces a turn)
            [/modifications]
        [/unit]
        {REPEAT {ON_DIFFICULTY 2 4 6} (
            [unit]
                type=Caravel
                x,y=1,1 # (a bit to the side of the Passing Wind, to keep them out of its way)
                side=3
                animate=yes
            [/unit]
        )}
        [store_unit]
            [filter]
                side=1
                race=boat
                level={ON_DIFFICULTY (1) (1,2) (1,2,3)}
                [filter_location]
                    terrain=Wo
                    x=11-50
                    y=1-16
                [/filter_location]
            [/filter]
            variable=drake_ships
        [/store_unit]
        [foreach]
            array=drake_ships
            variable=this_ship
            readonly=yes
            [do]
                [unit]
                    type=Caravel
                    x,y=2,2
                    side=3
                    placement=map
                    passable=yes
                    animate=yes
                [/unit]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE drake_ships}
        [scroll_to_unit]
            id=Passing Wind
        [/scroll_to_unit]
        [delay]
            time=150
        [/delay]
        [redraw][/redraw]
        [message]
            speaker=Unforgiver
            image=$malakar_image
            message= _ "(Malakar) Fie! The humans pursue us!"
        [/message]
        [message]
            speaker=Unforgiver
            image=$kogw_image
            message= _ "(Kogw) Blast! There's low wind and we're in the island's tide. Our best bet is to land and hope they hesitate long enough for us to ready our defense."
        [/message]
        [message]
            speaker=Unforgiver
            image=$malakar_image
            message= _ "(Malakar) There is an old fortress on the eastern horizon. We can make our stand there."
        [/message]
    [/event]

    #moves the Passing Wind south
#define MOVE_PWIND_SOUTH
    [if]
        [variable]
            name=passing_wind_moveto
            numerical_equals=18
        [/variable]
        [then]
            [if]
                [variable]
                    name=jako_disembarked
                    numerical_equals=0
                [/variable]
                [then]
                    #moves Jako off the ship
                    [move_unit_fake]
                        x=7,7,7,7,7
                        y=18,19,20,21,22
                        type=General
                        side=3
                    [/move_unit_fake]
                    [unit]
                        id=Jako
                        name= _ "Jako"
                        type=General
                        side=3
                        canrecruit=yes
                        x,y=7,22
                        [modifications]
                            {TRAIT_RESILIENT}
                            {TRAIT_SLOW}
                        [/modifications]
                        [status]
                            slowed=yes
                        [/status]
                    [/unit]
                    #to keep the orcs or spirits from killing Jako immediately
                    [unit]
                        generate_name=yes
                        type=Pikeman
                        side=3
                        x,y=7,22
                    [/unit]
                    [if]
                        [have_unit]
                            [filter_side]
                                [enemy_of]
                                    team_name=evil2
                                [/enemy_of]
                            [/filter_side]
                            x=3-10
                            y=20-25
                        [/have_unit]
                        [then]
                            [unit]
                                generate_name=yes
                                type=Swordsman
                                side=3
                                x,y=8,23
                            [/unit]
                        [/then]
                    [/if]
                    #so it is not moved again
                    [store_unit]
                        kill=yes
                        [filter]
                            id=Passing Wind
                        [/filter]
                        variable=pwind
                    [/store_unit]
                    #allies the Passing Wind with the humans
                    {VARIABLE pwind.side 3}
                    #keeps the graphic where it should be
                    [item]
                        x=7
                        y=17
                        image=units/boats/dreadnought.png~TC(3,magenta)
                    [/item]
                    [redraw]
                    [/redraw]
                    [set_variable]
                        name=jako_disembarked
                        value=1
                    [/set_variable]
                    [message]
                        speaker=Skula-Teroa
                        message= _ "Intruders! Die!"
                    [/message]
                    # Since Jako just disembarked, assume Skula-Teroa was referring to the humans as the intruders he wants to die:
                    [modify_side]
                        side=2 # orcs
                        [ai]
                            [goal]
                                [criteria]
                                    side=3 # humans
                                [/criteria]
                                # targeting humans less with difficulty means the orcs help you less as it gets harder:
                                {QUANTITY value 9.9 9.5 9.1}
                            [/goal]
                            [goal]
                                [criteria]
                                    id=Jako
                                [/criteria]
                                # likewise:
                                {QUANTITY value 9.8 9.4 9.0}
                            [/goal]
                            {QUANTITY leader_value 8.8 7.7 6.6}
                            grouping=offensive
                        [/ai]
                    [/modify_side]

                    [message]
                        speaker=Jako
                        message= _ "Men, be prepared for attacks from the South, but the Drakes remain our primary objective. Move out!"
                    [/message]
                    # update AI to reflect Jako's command:
                    [modify_side]
                        side=3 # humans
                        [ai]
                            [goal]
                                [criteria]
                                    side=1 # you (drakes)
                                [/criteria]
                                # I had this backwards previously; meant to start small and get bigger like this:
                                {QUANTITY value 4.4 5.5 6.6}
                            [/goal]
                            [goal]
                                [criteria]
                                    side=2 # orcs
                                [/criteria]
                                # likewise, I had this backwards previously; sure, it always stayed smaller than the value for drakes,
                                # but it was supposed to get smaller like this so they target you more than the orcs even more:
                                {QUANTITY value 0.3 0.2 0.1}
                            [/goal]
                            leader_aggression="-5.5"
                        [/ai]
                    [/modify_side]

                    [if]
                        [variable]
                            name=malakar_disembarked
                            equals=yes
                        [/variable]
                        [then]
                            {OBJECTIVES_HEADER}
                                {CONDITION_WIN ( _ "Defeat both enemy leaders")}
                                {CONDITION_LOSE ( _ "Destruction of the Unforgiver")}
                                {OBJECTIVES_LOSE}
                                {GOLD_CARRYOVER_STANDARD}
                            {OBJECTIVES_FOOTER}
                        [/then]
                    [/if]
                    [gold]
                        side=2 # orcs
                        {QUANTITY amount 50 60 70}
                    [/gold]
                    [count_units]
                        side=3
                        type=Caravel
                        variable=human_ships
                    [/count_units]
                    {VARIABLE gold_to_give {ON_DIFFICULTY 20 25 30}}
                    {VARIABLE_OP gold_to_give multiply $human_ships}
                    [gold]
                        side=3
                        amount=$gold_to_give
                    [/gold]
                    {CLEAR_VARIABLE human_ships}
                    {CLEAR_VARIABLE gold_to_give}
                [/then]
            [/if]
        [/then]
    [/if]
    [if]
        [have_unit]
            x=7
            y=$passing_wind_moveto
        [/have_unit]
        [then]
            [move_unit]
                x,y=7,$passing_wind_moveto
                dir=nw
                # (reminder: "If the target location is occupied, the nearest free location is chosen.")
            [/move_unit]
        [/then]
        [else]
            [if]
                [have_unit]
                    id=Passing Wind
                    side=4
                [/have_unit]
                [then]
                    [teleport]
                        [filter]
                            id=Passing Wind
                        [/filter]
                        x=7
                        y=$passing_wind_moveto
                    [/teleport]
                    [scroll_to_unit]
                        id=Passing Wind
                    [/scroll_to_unit]
                    [set_variable]
                        name=passing_wind_moveto
                        add=1
                    [/set_variable]
                [/then]
                [else]
                    [redraw][/redraw]
                [/else]
            [/if]
        [/else]
    [/if]
#enddef

    [event]
        name=new turn
        first_time_only=no
        [if]
            #so a spirit can't randomly spawn next to the orc leader on turn 1 or 2
            [variable]
                name=turn_number
                greater_than=2
            [/variable]
            [then]
                [if]
                    [variable]
                        name=spirit_last_turn
                        equals=no
                    [/variable]
                    [then]
                        [count_units]
                            type=Thunder Spirit
                            side=5
                            variable=spirit_count
                        [/count_units]
                        [if]
                            #no more than 3 at a time - we don't want them to do all the work if a bunch appear at once
                            [variable]
                                name=spirit_count
                                less_than_equal_to=3
                            [/variable]
                            [then]
                                #makes thunder spirits appear
                                #20% chance each turn
                                {RANDOM 1..5}
                                [if]
                                    [variable]
                                        name=random
                                        less_than=2
                                    [/variable]
                                    [then]
                                        {VARIABLE spirit_last_turn yes}
                                        [set_variable]
                                            name=thunderx
                                            rand=1..50
                                        [/set_variable]
                                        #prevents spirit from appearing in ocean
                                        [set_variable]
                                            name=thundery
                                            rand=21..50
                                        [/set_variable]
                                        [scroll_to]
                                            x=$thunderx
                                            y=$thundery
                                        [/scroll_to]
                                        [item]
                                            x=$thunderx
                                            y=$thundery
                                            halo=halo/shadow-mage-halo1.png,halo/shadow-mage-halo2.png,halo/shadow-mage-halo3.png,halo/shadow-mage-halo4.png,halo/shadow-mage-halo5.png,halo/shadow-mage-halo6.png,halo/shadow-mage-halo7.png,halo/shadow-mage-halo8.png,halo/shadow-mage-halo9.png,halo/shadow-mage-halo10.png
                                        [/item]
                                        #sound effects
                                        [sound]
                                            name=lightning.ogg
                                        [/sound]
                                        [sound]
                                            name=fire.wav
                                        [/sound]
                                        [color_adjust]
                                            red=100
                                            green=100
                                            blue=100
                                        [/color_adjust]
                                        #creates spirit
                                        [unit]
                                            x=$thunderx
                                            y=$thundery
                                            type=Thunder Spirit
                                            side=5
                                        [/unit]
                                        [delay]
                                            time=10
                                        [/delay]
                                        [color_adjust]
                                            red=0
                                            green=0
                                            blue=0
                                        [/color_adjust]
                                        [scroll_to]
                                            x=$thunderx
                                            y=$thundery
                                        [/scroll_to]
                                        [delay]
                                            time=150
                                        [/delay]
                                        [remove_item]
                                            x=$thunderx
                                            y=$thundery
                                        [/remove_item]
                                        [if]
                                            #checks whether Malakar is off the ship
                                            [have_unit]
                                                id=Malakar
                                            [/have_unit]
                                            [then]
                                                [message]
                                                    speaker=Kogw
                                                    message= _ "A spirit has attacked!"
                                                [/message]
                                            [/then]
                                            [else]
                                                [message]
                                                    image=$kogw_image
                                                    speaker=Unforgiver
                                                    message= _ "(Kogw) A spirit has attacked!"
                                                [/message]
                                            [/else]
                                        [/if]
                                        [if]
                                            [have_unit]
                                                id=Malakar
                                            [/have_unit]
                                            [then]
                                                [if]
                                                    [variable]
                                                        name=spirit_counter
                                                        numerical_equals=0
                                                    [/variable]
                                                    [then]
                                                        [message]
                                                            speaker=Malakar
                                                            message= _ "By the smoke of Gar-Alagar... a spirit!"
                                                        [/message]
                                                    [/then]
                                                    [else]
                                                        [if]
                                                            [variable]
                                                                name=spirit_counter
                                                                numerical_equals=1
                                                            [/variable]
                                                            [then]
                                                                [message]
                                                                    speaker=Malakar
                                                                    message= _ "It... it did not attack. It just appeared."
                                                                [/message]
                                                            [/then]
                                                            [else]
                                                                [if]
                                                                    [variable]
                                                                        name=spirit_counter
                                                                        numerical_equals=2
                                                                    [/variable]
                                                                    [then]
                                                                        [message]
                                                                            speaker=Malakar
                                                                            message= _ "Are you going to say that EVERY time?"
                                                                        [/message]
                                                                    [/then]
                                                                [/if]
                                                            [/else]
                                                        [/if]
                                                    [/else]
                                                [/if]
                                            [/then]
                                            [else]
                                                [if]
                                                    [variable]
                                                        name=spirit_counter
                                                        numerical_equals=0
                                                    [/variable]
                                                    [then]
                                                        [message]
                                                            image=$malakar_image
                                                            speaker=Unforgiver
                                                            message= _ "(Malakar) By the smoke of Gar-Alagar... a spirit!"
                                                        [/message]
                                                    [/then]
                                                    [else]
                                                        [if]
                                                            [variable]
                                                                name=spirit_counter
                                                                numerical_equals=1
                                                            [/variable]
                                                            [then]
                                                                [message]
                                                                    image=$malakar_image
                                                                    speaker=Unforgiver
                                                                    message= _ "(Malakar) It... it did not attack. It just appeared."
                                                                [/message]
                                                            [/then]
                                                            [else]
                                                                [message]
                                                                    image=$malakar_image
                                                                    speaker=Unforgiver
                                                                    message= _ "(Malakar) Are you going to say that EVERY time?"
                                                                [/message]
                                                            [/else]
                                                        [/if]
                                                    [/else]
                                                [/if]
                                            [/else]
                                        [/if]
                                        {VARIABLE_OP spirit_counter add 1}
                                        #cleans up variables
                                        {CLEAR_VARIABLE thunderx}
                                        {CLEAR_VARIABLE thundery}
                                    [/then]
                                [/if]
                                {CLEAR_VARIABLE random}
                            [/then]
                        [/if]
                        {CLEAR_VARIABLE spirit_count}
                    [/then]
                    [else]
                        {VARIABLE spirit_last_turn no}
                    [/else]
                [/if]
            [/then]
        [/if]
        #controls the Passing Wind
        [if]
            [variable]
                name=turn_number
                greater_than=3
            [/variable]
            [then]
                [if]
                    [variable]
                        name=jako_disembarked
                        numerical_equals=0
                    [/variable]
                    [then]
                        {MOVE_PWIND_SOUTH}
                        {MOVE_PWIND_SOUTH}
                        {MOVE_PWIND_SOUTH}
                        {MOVE_PWIND_SOUTH}
                        {MOVE_PWIND_SOUTH}
                        {MOVE_PWIND_SOUTH}
                    [/then]
                [/if]
            [/then]
        [/if]
        [if]
            [variable]
                name=jako_disembarked
                numerical_equals=1
            [/variable]
            [then]
                #prevents it from being activated again
                [set_variable]
                    name=jako_disembarked
                    value=2
                [/set_variable]
                #replaces the Passing Wind
                [remove_item]
                    x=7
                    y=17
                [/remove_item]
                [unstore_unit]
                    variable=pwind
                [/unstore_unit]
                {CLEAR_VARIABLE pwind}
            [/then]
        [/if]
        #redraws the screen
        [redraw]
        [/redraw]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            x,y=7,18
            id=Unforgiver
        [/filter]
        [if]
            [variable]
                name=malakar_disembarked
                equals=no
            [/variable]
            [then]
                [if]
                    [variable]
                        name=jako_disembarked
                        numerical_equals=2
                    [/variable]
                    [then]
                        #if you land in the humans' castle after they have landed, you lose!
                        [unstore_unit]
                            placement=leader
                            variable=malakar_store
                        [/unstore_unit]
                        #moves Malakar into position
                        [teleport]
                            [filter]
                                id=Malakar
                            [/filter]
                            x,y=7,19
                        [/teleport]
                        [unit]
                            generate_name=yes
                            x,y=6,19
                            side=3
                            type=Pikeman
                        [/unit]
                        [unit]
                            generate_name=yes
                            x,y=7,20
                            side=3
                            type=Pikeman
                        [/unit]
                        [unit]
                            generate_name=yes
                            x,y=8,19
                            side=3
                            type=Pikeman
                        [/unit]
                        [message]
                            speaker=Malakar
                            message= _ "What is this? Why have we landed here?"
                        [/message]
                        [message]
                            image=$kogw_image
                            speaker=Unforgiver
                            message= _ "(Kogw) I'm truly sorry, Mal, but I can't keep doing this. The drake is all yours, boyos."
                        [/message]
                        [endlevel]
                            result=defeat
                            music=defeat.ogg,defeat2.ogg
                        [/endlevel]
                    [/then]
                    #if you land in humans' castle before they land, you are chased away by an orc
                    [else]
                        [unstore_unit]
                            placement=leader
                            variable=malakar_store
                        [/unstore_unit]
                        #moves Malakar into position
                        [teleport]
                            [filter]
                                id=Malakar
                            [/filter]
                            x,y=7,19
                        [/teleport]
                        #wmllint: recognize slayer
                        [unit]
                            x,y=7,20
                            side=2
                            generate_name=yes
                            type=Orcish Slayer
                            id="slayer"
                        [/unit]
                        [redraw]
                        [/redraw]
                        [scroll_to_unit]
                            id=slayer
                        [/scroll_to_unit]
                        [message]
                            speaker=slayer
                            message= _ "RUARRAGH!" # wmllint: no spellcheck
                        [/message]
                        [message]
                            speaker=Malakar
                            message= _ "We need an EMPTY fortress, you fool!"
                        [/message]
                        [message]
                            speaker=Kogw
                            message= _ "Back on the boat!"
                        [/message]
                        #to keep him out of the humans' way
                        [kill]
                            id=slayer
                            animate=no
                        [/kill]
                        [kill]
                            id=Malakar
                            fire_event=no
                            animate=no
                        [/kill]
                        [redraw]
                        [/redraw]
                    [/else]
                [/if]
            [/then]
            [else]
                [allow_undo]
                [/allow_undo]
            [/else]
        [/if]
    [/event]

    {FREEDOM_DEATHS_UNFORGIVER}

    [event]
        name=victory
        {WESNOTH_THIRD_FLEET_APPEARANCE 7 1 3}
        [message]
            speaker=Malakar
            message= _ "They have summoned reinforcements! Burn down their ships!"
        [/message]
        [message]
            speaker=Kogw
            message= _ "By the Eyes... it's hopeless, Malakar! That's a whole fleet of their finest. We must retreat!"
        [/message]
        [if]
            #wmllint: recognize Theracar
            [have_unit]
                id=Theracar
            [/have_unit]
            [then]
                [message]
                    speaker=Theracar
                    image=$theracar_image
                    message= _ "Cowardly thinskin. We are drakes! We shall take to the skies at once and make pyres of their worthless boats!"
                [/message]
                [message]
                    speaker=Malakar
                    message= _ "No, Captain, I fear the pirate has the way of it. Our tribe has spent much of our strength on our journey, and we would not survive a mad charge into their arrows and ballista bolts. We must regroup farther inland."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Malakar
                    message= _ "Hmm. So be it. Regroup farther inland!"
                [/message]
            [/else]
        [/if]
        [message]
            speaker=Kogw
            message= _ "Forgive me, darling. I've never had the honor of captaining a finer ship."
        [/message]
        [message]
            speaker=Unforgiver
            message= _ "..."
        [/message]
        [message]
            speaker=Kogw
            message= _ "Haaarh. You must see, I have no choice. My hands are tied."
        [/message]
        [message]
            speaker=Unforgiver
            message= _ "..."
        [/message]
        [message]
            speaker=Malakar
            message= _ "Let us go!"
        [/message]
        #gets rid of your navy
        [kill]
            type=Pirate Sloop,Pirate Cruiser,Pirate Galleon2,Pirate Galley
            [not]
                id=Unforgiver
            [/not]
        [/kill]
        #in case you debugged your way through
        [if]
            [not]
                [have_unit]
                    id=Malakar
                [/have_unit]
            [/not]
            [then]
                [unstore_unit]
                    variable=malakar_store
                [/unstore_unit]
                [unstore_unit]
                    variable=kogw_store
                [/unstore_unit]
            [/then]
        [/if]
        {CLEAR_VARIABLE malakar_store}
        {CLEAR_VARIABLE kogw_store}
        [store_unit]
            [filter]
                id=Malakar
            [/filter]
            variable=temp_store
        [/store_unit]
        {VARIABLE temp_store.canrecruit yes}
        [unstore_unit]
            variable=temp_store
        [/unstore_unit]
        [store_unit]
            [filter]
                id=Unforgiver
            [/filter]
            variable=unforgiver_store
        [/store_unit]
        {VARIABLE unforgiver_store.canrecruit no}
        #cleans up variables
        {CLEAR_VARIABLE temp_store}
        {CLEAR_VARIABLE passing_wind_moveto}
        {CLEAR_VARIABLE bridge_steps}
        {CLEAR_VARIABLE malakar_disembarked}
        {CLEAR_VARIABLE jako_disembarked}
        {CLEAR_VARIABLE spirit_last_turn}
        {CLEAR_VARIABLE first_step_effects}
    [/event]

    [event]
        name=die
        [filter]
            id=Passing Wind
            #side 4 before Jako disembarks, side 3 after
            side=4
        [/filter]
        [filter_second]
            #avoid giving achievement in the rare instance a Thunder Spirit sinks it
            side=1
        [/filter_second]
        {CONDITIONAL_AWARD_ACHIEVEMENT ftf_davy_jones_locker}
    [/event]

    [event]
        name=time over
        {WESNOTH_THIRD_FLEET_APPEARANCE 7 1 3}
        [message]
            speaker=Malakar
            message= _ "They have summoned reinforcements!"
        [/message]
        [message]
            speaker=Kogw
            message= _ "It's hopeless, Malakar. That's a whole fleet of their finest, and we can't escape!"
        [/message]
        [endlevel]
            result=defeat
            music=defeat.ogg,defeat2.ogg
        [/endlevel]
    [/event]

    {FTF_COMMON}
[/scenario]
