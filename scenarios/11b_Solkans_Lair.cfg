#textdomain wesnoth-Flight_Freedom

[scenario]
    name= _ "Sol'kan's Lair"
    map_file=11b_Solkans_Lair_intro.map
    turns=-1
    {SCENARIO_MUSIC traveling_minstrels.ogg}
    id=Solkans_Lair
    next_scenario="Hordes_Undead"
    victory_when_enemies_defeated=no

    {MORNING}

    {STORY_SOLKANS_LAIR}

    [side]
        save_id=Malakar
        type=Drake Chieftain
        id=Malakar
        name= _ "Malakar"
        {FLAG_VARIANT drake}
        side=1
        canrecruit=yes
        controller=human
        recruit=Drake Hatchling,Drake Burner,Drake Glider,Drake Fighter,Drake Clasher
        unrenamable=yes
        team_name=good
        user_team_name= _ "Kakatar Tribe"
        {GOLD 120 110 100}
    [/side]
    [side]
        side=2
        {FLAG_VARIANT6 ragged}
        controller=ai
        team_name=evil
        gold=0
        recruit=
        no_leader=yes
        user_team_name= _ "Undead"
        hidden=yes
    [/side]
    [side]
        side=3
        {FLAG_VARIANT6 ragged}
        controller=ai
        team_name=evil
        gold=0
        recruit=
        no_leader=yes
        user_team_name= _ "Automata"
        hidden=yes
        [ai]
            aggression=1.0
            leader_value=0
            village_value=0
            protect_leader=0
        [/ai]
    [/side]

    [event]
        name=preload
        first_time_only=no
        [lua]
            code = <<
                wesnoth.dofile '~add-ons/Flight_Freedom/lua/s11b.lua'
                calc_difficulty_score()
                hide_ui_elements()
                wesnoth.game_config.do_healing = false
                wesnoth.game_config.rest_heal_amount = 0
                wesnoth.game_config.base_income = 0
                wesnoth.game_config.combat_experience = 0
                wesnoth.game_config.kill_experience = 0
            >>
        [/lua]
    [/event]

    [event]
        name=prestart
        #freeze player's gold during this scenario
        [store_gold]
            side=1
            variable=s11b_player_gold
        [/store_gold]
        {VARIABLE damage_glyphs_triggered 0}
        {VARIABLE engine_inst_gotten no}
        {VARIABLE viewed_console no}
        {VARIABLE auto_end_turn no}
        {VARIABLE alarms_triggered 0}
        {VARIABLE read_about_gate no}
        #1: first attacked by an automaton defender
        #2: subsequently activated an orb in the proper order
        {VARIABLE automata_notification_state 0}
        [store_unit]
            [filter]
                id=Malakar
            [/filter]
            variable=malakar_store
            kill=yes
        [/store_unit]
        {VARIABLE malakar_type $malakar_store.type}
        [item]
            x,y=19,29
            image="scenery/entrance-opened.png"
        [/item]
    [/event]

#define RANDOM_DRAKE_UNIT X Y
    [set_variable]
        name=spawn_type
        rand="Drake Clasher","Drake Fighter","Drake Glider","Drake Hatchling","Drake Slave","Drake Burner","Drake Clasher","Drake Fighter","Drake Glider","Drake Hatchling","Drake Slave","Drake Burner","Drake Thrasher","Drake Enforcer","Fire Drake","Drake Flare","Drake Warrior","Drake Worker"
    [/set_variable]
    [unit]
        x,y={X},{Y}
        side=1
        type=$spawn_type
    [/unit]
    {CLEAR_VARIABLE spawn_type}
#enddef

    [event]
        name=start
#ifndef S11_SKIP_INTRO_SEQUENCE
        [change_theme]
            theme=Cutscene
        [/change_theme]
        [scroll_to]
            x,y=21,21
            immediate=yes
        [/scroll_to]
        [move_units_fake]
            [fake_unit]
                x=30,18
                y=13,26
                side=1
                type=$malakar_type
            [/fake_unit]
            [fake_unit]
                x=29,16
                y=12,26
                side=1
                type=Drake Slave
            [/fake_unit]
            [fake_unit]
                x=30,17
                y=12,27
                side=1
                type=Drake Clasher
                skip_steps=1
            [/fake_unit]
            [fake_unit]
                x=29,17
                y=13,28
                side=1
                type=Hurricane Drake
            [/fake_unit]
            [fake_unit]
                x=29,15
                y=13,28
                side=1
                type=Drake Fighter
            [/fake_unit]
        [/move_units_fake]
        [unstore_unit]
            variable=malakar_store
            x,y=18,26
        [/unstore_unit]
        [unit]
            x,y=16,26
            side=1
            type=Drake Slave
        [/unit]
        [unit]
            x,y=17,27
            side=1
            type=Drake Clasher
        [/unit]
        [unit]
            x,y=15,28
            side=1
            type=Drake Fighter
        [/unit]
        [unit]
            x,y=17,28
            side=1
            type=Hurricane Drake
            id=s11b_scout
        [/unit]
        {RANDOM_DRAKE_UNIT 17 23}
        {RANDOM_DRAKE_UNIT 18 24}
        {RANDOM_DRAKE_UNIT 20 24}
        {RANDOM_DRAKE_UNIT 21 24}
        {RANDOM_DRAKE_UNIT 19 22}
        {RANDOM_DRAKE_UNIT 18 21}
        {RANDOM_DRAKE_UNIT 20 20}
        {RANDOM_DRAKE_UNIT 21 19}
        [lock_view]
        [/lock_view]
        [scroll_to_unit]
            id=s11b_scout
        [/scroll_to_unit]
        [message]
            speaker=s11b_scout
            message= _ "Chief, there is a hidden entrance in the mountain!"
        [/message]
        {MOVE_UNIT_DISPLACE_CURRENT 18 28 (id=Malakar)}
        [for]
            variable=i
            start=1
            end=3
            [do]
                [item]
                    x,y=18,28
                    halo="scenery/rune6.png"
                [/item]
                [redraw]
                [/redraw]
                [delay]
                    time=500
                [/delay]
                [remove_item]
                    x,y=18,28
                [/remove_item]
                [item]
                    x,y=18,28
                    halo="scenery/rune6-glow.png"
                [/item]
                [redraw]
                [/redraw]
                [delay]
                    time=500
                [/delay]
                [remove_item]
                    x,y=18,28
                [/remove_item]
            [/do]
        [/for]
        {QUAKE cave-in.ogg}
        {REPLACE_SCENARIO_MUSIC frantic-old.ogg}
        [delay]
            time=1000
            accelerate=yes
        [/delay]
        [terrain]
            x,y=16,27
            terrain="Aa"
        [/terrain]
        [delay]
            time=2000
            accelerate=yes
        [/delay]
        {QUAKE cave-in.ogg}
        [delay]
            time=2000
            accelerate=yes
        [/delay]
        [terrain]
            x=15,17
            y=28,27
            terrain="Aa"
        [/terrain]
        [message]
            speaker=Malakar
            message= _ "An avalanche! Drakes! Clear the area. NOW!"
        [/message]
        {MOVE_UNIT_DISPLACE_CURRENT 15 26 (x,y=16,26)}
        {MOVE_UNIT_DISPLACE_CURRENT 18 25 (x,y=17,27)}
        {MOVE_UNIT_DISPLACE_CURRENT 15 27 (x,y=17,28)}
        {MOVE_UNIT_DISPLACE_CURRENT 14 28 (x,y=15,28)}
        [terrain]
            x=15,16,17,18
            y=26,26,26,26
            terrain="Aa"
        [/terrain]
        [terrain]
            x=17,18,19
            y=28,28,28
            terrain="Mm"
        [/terrain]
        [redraw]
        [/redraw]
        [delay]
            time=1000
            accelerate=yes
        [/delay]
        {REPLACE_SCENARIO_MUSIC silence.ogg}
        [sound]
            name="embrace-of-shassagoth.ogg"
        [/sound]
        [for]
            start=216
            end=2160
            step=216
            [do]
                [item]
                    x,y=18,28
                    halo=halo/deadzone.png~GS~SCALE($i,$i)
                    name=pulse
                [/item]
                [delay]
                    time=50
                [/delay]
                [remove_item]
                    x,y=18,28
                    image=pulse
                [/remove_item]
            [/do]
        [/for]
        [item]
            x,y=18,28
            halo=halo/deadzone.png~GS~SCALE(2160,2160)
            name=pulse
        [/item]
        [petrify]
            side=1
            [not]
                id=Malakar
            [/not]
        [/petrify]
        [store_locations]
            terrain=Ww
            variable=water_tiles
        [/store_locations]
        [foreach]
            array=water_tiles
            variable=this_tile
            readonly=yes
            [do]
                [terrain]
                    x,y=$this_tile.x,$this_tile.y
                    terrain=WwY
                [/terrain]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE water_tiles}
        [redraw]
        [/redraw]
        [delay]
            time=5000
            accelerate=yes
        [/delay]
        [message]
            speaker=Malakar
            message= _ "What... what is this? All the tribe, frozen in place... even the leaves of the trees no longer sway to the wind. This door, maybe therein lie the answers to this curse that has befallen my tribe."
        [/message]
        {MOVE_UNIT_DISPLACE_CURRENT 19 29 (id=Malakar)}
        [store_unit]
            [filter]
                id=Malakar
            [/filter]
            variable=malakar_store
            kill=yes
        [/store_unit]
        [screen_fade]
            alpha=255
            duration=1500
        [/screen_fade]
        [kill]
            [not]
                x,y=recall,recall
            [/not]
        [/kill]
        #to unpetrify recall list so Theracar's not petrified in the end sequence
        [unpetrify]
            side=1
        [/unpetrify]
#endif
        [modify_side]
            side=1
            fog=yes
            shroud=yes
        [/modify_side]
        [remove_item]
            x,y=19,29
        [/remove_item]
        [remove_item]
            x,y=18,28
            image=pulse
        [/remove_item]
        [replace_map]
            map_file=11b_Solkans_Lair.map
            expand=yes
        [/replace_map]
        [replace_schedule]
            {UNDERGROUND}
        [/replace_schedule]
        [unstore_unit]
            variable=malakar_store
            x,y=1,1
        [/unstore_unit]
        [lua]
            code = <<
                randomize_scenario()
            >>
        [/lua]
        [hide_unit]
            id=Malakar
        [/hide_unit]
        [store_unit]
            [filter]
                side=2
            [/filter]
            variable=undead_store
        [/store_unit]
        [for]
            variable=i
            start=0
            end="$($undead_store.length-1)"
            [do]
                [micro_ai]
                    side=2
                    ai_type=return_guardian
                    action=add
                    [filter]
                        x = $undead_store[$i].x
                        y = $undead_store[$i].y
                    [/filter]
                    return_x = $undead_store[$i].x
                    return_y = $undead_store[$i].y
                [/micro_ai]
            [/do]
        [/for]
        {CLEAR_VARIABLE malakar_store}
        [scroll_to_unit]
            id=Malakar
            immediate=yes
        [/scroll_to_unit]
        [screen_fade]
            alpha=0
            duration=1500
        [/screen_fade]
        [redraw]
            side=1
            clear_shroud=yes
        [/redraw]
        [move_unit_fake]
            x=$malakar_run_x, $malakar_start_x
            y=$malakar_run_y, $malakar_start_y
            side=1
            type=$malakar_type
        [/move_unit_fake]
        {CLEAR_VARIABLE malakar_type}
        {CLEAR_VARIABLE malakar_start_x}
        {CLEAR_VARIABLE malakar_start_y}
        [unhide_unit]
            id=Malakar
        [/unhide_unit]
        [change_theme]
            theme=
        [/change_theme]
        [unlock_view]
        [/unlock_view]
        {REPLACE_SCENARIO_MUSIC into_the_shadows.ogg}
        {APPEND_MUSIC heroes_rite.ogg}
        {APPEND_MUSIC the_deep_path.ogg}
        [message]
            speaker=Malakar
            message= _ "This appears to be some sort of hidden base. I must find a way to lift the curse!"
        [/message]
        [message]
            speaker=narrator
            {NARRATOR_ICON}
            message= _ "NOTE: This scenario uses color-coded graphics. Those colors that are essential for scenario completion can be labeled for color-deficient players."
            # wmllint: no-icon
            [option]
                message= _ "Continue normally"
                default=yes
                [command]
                [/command]
            [/option]
            [option]
                message= _ "Continue with labeled colors"
                [command]
                    [label_orb_colors]
                    [/label_orb_colors]
                [/command]
            [/option]
        [/message]
        [fire_event]
            name=update_objectives
        [/fire_event]
        [message]
            speaker=narrator
            {NARRATOR_ICON}
            message="<span color='yellow' size='larger'><b>" + _ "NOTE: As each turn represents a short amount of time, rest healing is disabled. Additionally, your gold stockpile is frozen, and Malakar will not gain experience." + "</b></span>"
            # wmllint: no-icon
        [/message]
        [set_menu_item]
            id=enable_auto_end_turn
            description= _ "Enable automatic end turn"
            [show_if]
                [variable]
                    name=auto_end_turn
                    boolean_equals=no
                [/variable]
            [/show_if]
            [command]
                {VARIABLE auto_end_turn yes}
            [/command]
            synced=yes
        [/set_menu_item]
        [set_menu_item]
            id=e_disable_auto_end_turn
            description= _ "Disable automatic end turn"
            [show_if]
                [variable]
                    name=auto_end_turn
                    boolean_equals=yes
                [/variable]
            [/show_if]
            [command]
                {VARIABLE auto_end_turn no}
            [/command]
            synced=yes
        [/set_menu_item]
        #do this each turn so that save games don't show progressively climbing gold
        [event]
            name=new turn
            first_time_only=no
            [modify_side]
                side=1
                gold=$s11b_player_gold
            [/modify_side]
        [/event]
    [/event]

    [event]
        name=turn 2
        [message]
            speaker=narrator
            {NARRATOR_ICON}
            message= _ "If you wish for your turn to automatically end after Malakar is out of moves and attacks, right-click on the map and select “Enable automatic end turn”. This can be toggled on or off at any time."
        [/message]
    [/event]

    [event]
        name=moveto,attack
        first_time_only=no
        priority=-99
        [filter]
            side=1
        [/filter]
        [if]
            [variable]
                name=auto_end_turn
                boolean_equals=yes
            [/variable]
            [not]
                # wmllint: conditional tag has_possible_actions
                [has_possible_actions]
                    side=1
                [/has_possible_actions]
            [/not]
            [then]
                [end_turn]
                [/end_turn]
            [/then]
            [else]
                [allow_undo]
                [/allow_undo]
            [/else]
        [/if]
    [/event]

    [event]
        name=moveto
        # if player activates a guard this event is removed from lua
        id=guard_description
        [filter]
            x=$orb_guards_x
            y=$orb_guards_y
            side=1
        [/filter]
        [message]
            speaker=unit
            message= _ "This seems to be a machine fashioned into a statue."
        [/message]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            x=$orbs_x
            y=$orbs_y
            side=1
        [/filter]
        [get_orb_color]
            x,y=$x1,$y1
        [/get_orb_color]
        [switch]
            variable=orb_color
            #enumerated separately here so it could be more easily translatable
            [case]
                value="red"
                {VARIABLE unit_message ( _ "A red orb! Should I break it?")}
            [/case]
            [case]
                value="blue"
                {VARIABLE unit_message ( _ "A blue orb! Should I break it?")}
            [/case]
            [case]
                value="green"
                {VARIABLE unit_message ( _ "A green orb! Should I break it?")}
            [/case]
            [case]
                value="white"
                {VARIABLE unit_message ( _ "A white orb! Should I break it?")}
            [/case]
            [case]
                value="black"
                {VARIABLE unit_message ( _ "A black orb! Should I break it?")}
            [/case]
            [case]
                value="yellow"
                {VARIABLE unit_message ( _ "A yellow orb! Should I break it?")}
            [/case]
        [/switch]
        [message]
            speaker=unit
            message=$unit_message
            [option]
                label= _ "Yes."
                default=yes
                [command]
                    [handle_orb]
                        x,y=$x1,$y1
                    [/handle_orb]
                    [if]
                        [variable]
                            name=orb_colors
                            equals=""
                        [/variable]
                        [then]
                            [remove_item]
                                x,y=$machine_x,$machine_y
                                image="scenery/engine-shield.png"
                            [/remove_item]
                            # todo: effects, graphics, maybe boss unit, etc.
                            [if]
                                [variable]
                                    name=engine_inst_gotten
                                    boolean_equals=yes
                                [/variable]
                                [then]
                                    [message]
                                        speaker=Malakar
                                        message= _ "I believe that this is the last of the orbs. I can only hope that the curse on my tribe is now lifted. Now I must destroy this so-called Engine quickly before it can accomplish its evil task!"
                                    [/message]
                                    [fire_event]
                                        name=update_objectives
                                    [/fire_event]
                                [/then]
                                [else]
                                    [message]
                                        speaker=Malakar
                                        message= _ "I believe that this is the last of the orbs. I can only hope that the curse on my tribe is now lifted. Now I must find the source of this evil and destroy it!"
                                    [/message]
                                [/else]
                            [/if]
                        [/then]
                    [/if]
                [/command]
            [/option]
            [option]
                label= _ "No."
                [command]
                    [allow_undo]
                    [/allow_undo]
                [/command]
            [/option]
        [/message]
        {CLEAR_VARIABLE unit_message}
        {CLEAR_VARIABLE orb_color}
    [/event]

    [event]
        name=attack
        [filter]
            side=3
            type="Automaton Defender"
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [if]
            [variable]
                name=damage_glyphs_triggered
                numerical_equals=0
            [/variable]
            [then]
                [message]
                    speaker=second_unit
                    message= _ "I seem to have triggered some sort of trap!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=second_unit
                    message= _ "This must be another trap!"
                [/message]
            [/else]
        [/if]
        {VARIABLE automata_notification_state 1}
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            x=$healing_glyph_x
            y=$healing_glyph_y
            side=1
        [/filter]
        [if]
            # wmllint: conditional tag has_item
            [has_item]
                image="scenery/rune5.png"
                x,y=$x1,$y1
            [/has_item]
            [then]
                [sound]
                    name=magic-faeriefire.ogg
                [/sound]
                [heal_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    amount=full
                    restore_statuses=yes
                    animate=yes
                [/heal_unit]
                [remove_item]
                    name="scenery/rune5.png"
                    x,y=$x1,$y1
                [/remove_item]
            [/then]
            [else]
                [allow_undo]
                [/allow_undo]
            [/else]
        [/if]
    [/event]

    #damaging enemies is deliberate so player can lure enemies over them for an advantage
    [event]
        name=enter_hex
        first_time_only=no
        [filter]
            x=$damage_glyph_x
            y=$damage_glyph_y
        [/filter]
        [sound]
            name=magic-dark-big.ogg
        [/sound]
        [for]
            variable=i
            start=1
            end=8
            [do]
                [item]
                    x,y=$x1,$y1
                    halo=halo/flame-burst-$i|.png~SWAP(blue,green,red)
                    name=flame_burst
                [/item]
                [redraw]
                [/redraw]
                [delay]
                    time=200
                    accelerate=yes
                [/delay]
                [remove_item]
                    x,y=$x1,$y1
                    image=flame_burst
                [/remove_item]
            [/do]
        [/for]
        {CLEAR_VARIABLE i}
        [harm_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            amount=10
            kill=no
            animate=yes
        [/harm_unit]
        [if]
            [variable]
                name=unit.side
                numerical_equals=1
            [/variable]
            [then]
                [switch]
                    variable=damage_glyphs_triggered
                    [case]
                        value=0
                        [message]
                            speaker=unit
                            message= _ "These glyphs are a trap!"
                        [/message]
                    [/case]
                    [case]
                        value=1
                        [message]
                            speaker=unit
                            message= _ "I need to watch my steps more carefully. There may be other traps about."
                        [/message]
                    [/case]
                    [case]
                        value=2
                        [message]
                            speaker=unit
                            message= _ "Why must I keep running into these traps?"
                        [/message]
                    [/case]
                    [case]
                        value=3
                        [message]
                            speaker=unit
                            message= _ "This is becoming absurd..."
                        [/message]
                    [/case]
                [/switch]
                {VARIABLE_OP damage_glyphs_triggered add 1}
            [/then]
        [/if]
    [/event]

    [event]
        name=enter_hex
        [filter]
            x=$control_room_x
            y=$control_room_y
            side=1
        [/filter]
        [remove_shroud]
            side=1
            x,y=$machine_x,$machine_y
            radius=2
        [/remove_shroud]
        [lift_fog]
            side=1
            x,y=$machine_x,$machine_y
            radius=2
            multiturn=yes
        [/lift_fog]
        [scroll_to]
            x,y=$machine_x,$machine_y
        [/scroll_to]
        [delay]
            time=3000
            accelerate=yes
        [/delay]
        [message]
            speaker=unit
            message= _ "Some sort of strange contraption! Could this be the source of the curse?"
        [/message]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            x=$assistant_note_x
            y=$assistant_note_y
            side=1
        [/filter]
        [if]
            [has_item]
                image="help/topic.png"
                x,y=$x1,$y1
            [/has_item]
            [then]
                [display_assistant_note]
                    x,y=$x1,$y1
                [/display_assistant_note]
                [remove_item]
                    name="help/topic.png"
                    x,y=$x1,$y1
                [/remove_item]
            [/then]
            [else]
                [allow_undo]
                [/allow_undo]
            [/else]
        [/if]
    [/event]

    [event]
        name=moveto
        [filter]
            x=$engine_inst_x
            y=$engine_inst_y
            side=1
        [/filter]
        [message]
            speaker=unit
            message= _ "This appears to be a page torn out of another book."
        [/message]
        [show_journal_dialog]
            text= _ "At last! At last the Engine approaches completion! I stand at the precipice of the power of the void! As I have pursued the void, I now see that the void has pursued me. Whispering delightful and terrible secrets into my mind. Secrets which have helped to make the Engine a reality. Soon I shall activate the inner and outer containment fields and set the Engine to work!

The requisite energies are housed in crystal orbs. They can be released into the awaiting ritual altars by even my most dim-witted assistants, merely by the simple act of breaking them. When collected and precisely shaped by the artificial miracles of the Engine, they shall create a spatio-temporal-thaumic singularity that will bridge the barest sliver of our universe with the void. Only when the Engine is fully charged will the containment fields deactivate. The Engine will then release a modified teleportation charm derived from forbidden Silver lore to shunt me through the singularity into the void.

But my assistants are a jealous lot. They know not that I can sense their covetous eyes at my back, that the stench of their avarice billows from them like a cloak. Therefore I have set my Automata to guard the orbs. They have been programmed with a specific order in which the orbs are to be broken, known to myself and myself alone. If any of my assistants deign to initiate the activation sequence without my command, the Automata will reward their faithlessness with death."
        [/show_journal_dialog]
        [fire_event]
            name=malakar_void_quip
        [/fire_event]
        {VARIABLE engine_inst_gotten yes}
        [fire_event]
            name=update_objectives
        [/fire_event]
        [remove_item]
            x=$engine_inst_x
            y=$engine_inst_y
            image="items/book1.png"
        [/remove_item]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            x=$console_x
            y=$console_y
        [/filter]
        [if]
            [variable]
                name=viewed_console
                boolean_equals="no"
            [/variable]
            [then]
                [message]
                    speaker=unit
                    message= _ "This metal box has some sort of glass window with glowing words!"
                [/message]
                {VARIABLE viewed_console yes}
            [/then]
        [/if]
        [display_console_screen]
        [/display_console_screen]
    [/event]

    [event]
        name=enter_hex
        [filter]
            side=1
            [filter_location]
                [and]
                    x=$machine_x
                    y=$machine_y
                    radius=2
                [/and]
            [/filter_location]
        [/filter]
        [cancel_action]
        [/cancel_action]
        [engine_activation_sequence]
            x,y=$x1,$y1
        [/engine_activation_sequence]
        [recall]
            id=Theracar
            x,y=$malakar_run_x,$malakar_run_y
            show=no
        [/recall]
        [for]
            variable=i
            start=1
            end=3
            [do]
                [recall]
                    side=1
                    level=3,2,1
                    x,y=$malakar_run_x,$malakar_run_y
                    show=no
                [/recall]
            [/do]
        [/for]
        [modify_side]
            side=1
            fog=no
            shroud=no
        [/modify_side]
        [redraw]
        [/redraw]
        [message]
            speaker=Theracar
            image=$theracar_image
            message= _ "Chief! Malakar! Are you there? Malakar!"
        [/message]
        [message]
            speaker=Malakar
            message= _ "...Theracar... is that you..."
        [/message]
        [message]
            speaker=Theracar
            image=$theracar_image
            message= _ "Malakar! Thank the flame you are alive! You disappeared... what happened?"
        [/message]
        [message]
            speaker=Malakar
            message= _ "We triggered some sort of... machine. I saw all of you frozen in place. It appears disrupting the machine has restored the flow of time. How fares the tribe?"
        [/message]
        [message]
            speaker=Theracar
            image=$theracar_image
            message= _ "We are yet hale. To us, it was as if you suddenly vanished and the sun advanced in the sky. For a few moments we thought we were disoriented by the avalanche, but soon we realized that every drake in the valley was affected. Our scouts found this entrance so I took a war party to investigate."
        [/message]
        [if]
            [variable]
                name=alarms_triggered
                numerical_equals=0
            [/variable]
            [then]
                [message]
                    speaker=Malakar
                    message= _ "I am heartened to hear of your survival. This evil machine must never be rebuilt! Burn the library to ashes and all other writings you come across. Then bury the entrance. Afterwards we shall resume our journey."
                [/message]
                {CONDITIONAL_AWARD_ACHIEVEMENT ftf_stealthy_saboteur}
            [/then]
            [else]
                [message]
                    speaker=Malakar
                    message= _ "I am heartened to hear of your survival. This evil machine must never be rebuilt! Burn the library to ashes and all other writings you come across, but beware the moving statues. Then bury the entrance. Afterwards we shall resume our journey."
                [/message]
            [/else]
        [/if]
        [endlevel]
            result=victory
            linger_mode=yes
            carryover_percentage=100
            bonus=no
        [/endlevel]
    [/event]

    [event]
        name=moveto
        [filter]
            x=$journal_x
            y=$journal_y
            side=1
        [/filter]
        [message]
            speaker=Malakar
            message= _ "This appears to be a journal. Perhaps it can tell me more about whoever built this place."
        [/message]
        [show_journal_dialog]
            text=$journal_str
        [/show_journal_dialog]
        [fire_event]
            name=malakar_void_quip
        [/fire_event]
        [message]
            speaker=narrator
            {NARRATOR_ICON}
            message= _ "<span color='green'>You can view the journal at any time by right-clicking and selecting “Journal...”</span>"
            # wmllint: no-icon
        [/message]
        [set_menu_item]
            id=aa_show_journal
            image=buttons/scroll.png
            description= _ "Journal..."
            [command]
                [show_journal_dialog]
                    text=$journal_str
                [/show_journal_dialog]
            [/command]
            synced=no
        [/set_menu_item]
        [remove_item]
            x=$journal_x
            y=$journal_y
            image="items/book2.png"
        [/remove_item]
    [/event]

    [event]
        name=moveto
        [filter]
            x=$blueprint_x
            y=$blueprint_y
            side=1
        [/filter]
        [message]
            speaker=unit
            message= _ "These appear to be some sort of plans."
        [/message]
        [show_image_dialog]
            image="gui/s11b_engine.png"
        [/show_image_dialog]
        [remove_item]
            x=$blueprint_x
            y=$blueprint_y
            image="items/blueprints.png"
        [/remove_item]
    [/event]

    [event]
        name=moveto
        [filter]
            x=$isle_book_x
            y=$isle_book_y
            side=1
        [/filter]
        [show_text_box_dialog]
            text= _ "<span size='xx-large' stretch='semiexpanded'><u>The Isle of Storms</u></span>
<span size='large'><i>Mage Vonden of Aldril</i>

The Isle of Storms is located to the west of the Southwood, approximately a quarter of the way West of the Great Continent to the Old Continent. Its geography consists primary of coastal sub-tropical low-lands, with a central mountain ridge that buffers the high-lands from the otherwise-ubiquitous southern heat. Those explorers who have managed to return describe a resource-rich and fertile land. Doubtlessly the Crown of Wesnoth would have colonized the island long ago, but for the island's many dangers.

In the lands of the Great Continent, natural lightning only falls during thunderstorms. Not so on the Isle of Storms, as on occasion lightning strikes the ground from a clear blue sky. Worse still is that this unnatural lightning is known to at times coalesce into the elemental entities the locals term “Thunder Spirits”. These Thunder Spirits can call down lightning strikes of their own onto their unfortunate victims. None have been able to communicate with them, and they kill indiscriminately until they eventually dissipate into the air. Because of this ever-present threat, no permanent settlements have been established on the Isle. Concentrations of people seem to attract the Thunder Spirits, as attested to by the ruins dotted along the coast. Rather the locals tend to live in rude villages of wood and hides, which can be quickly rebuilt in the event of a Thunder Spirit attack.

Making matters worse for the inhabitants, the Isle is home to several tribes of orcs. These orcs are the real masters of the Isle, and rule over the humans with an iron fist. When they are not fighting each other, they frequently seek to challenge the Thunder Spirits. Most orcs who undertake this endeavor are presumably burned to a crisp. Those few who survive are renowned for their bravery and often rise to become chieftains of their tribes.

Surrounded by powerful ocean currents, the Isle is most notable as a maritime hazard given its many aforementioned dangers. However it remains of particular interest to wizards. The Isle is situated at the confluence of multiple ley lines, or currents of ambient magic. These currents serve to greatly lower the barriers to ritual magic. The Isle is also of interest to various pirates and criminals seeking a refuge from the Crown, most of whom fall prey to the Thunder Spirits or the orcs.

It is regrettable that the Isle will most likely remain far from the light of civilization for the foreseeable future.</span>"
        [/show_text_box_dialog]
        [remove_item]
            x=$isle_book_x
            y=$isle_book_y
            image="items/book3.png"
        [/remove_item]
    [/event]

    [event]
        name=moveto
        [filter]
            x=$lab_book_x
            y=$lab_book_y
            side=1
        [/filter]
        [show_text_box_dialog]
            text= _ "<span size='xx-large' stretch='semiexpanded'><u>On this Laboratory</u></span>
<span size='large'>Apprentices, many of you wonder why my acquaintances have called you to venture to this remote and perilous island. To leave behind your former lives, your friends, even your families. As you will learn, there is no growth, no knowledge, without sacrifice. But to the point of this island and my grand Laboratory.

You will, in time, come to further know of the great Engine and of the enormity of my genius. Building such a stupendous craft as the Engine here comes with several advantages. Few others can begin to comprehend the gravity of our quest, and of those who behold the slightest glimmer of my greatness the majority respond with fear. This remote island offers us security and isolation from those who would so foolishly seek to stand in our way. As a ley line nexus the island eases the practical application and investigation of magic. Even the Thunder Spirits have been made to serve us. Not only are they a powerful deterrent against any potential interloper, but by way of metal spires on the mountaintops we are able to harness the power of lightning itself to fuel our endeavors. Metal filaments have been woven into the walls of my Laboratory at regular intervals, creating a ward structure which neutralizes the energetic potential of any Thunder Spirits which attempt to manifest inside.

Perhaps you have learned about the Gate to the east of this island, termed by the ignorant who believe it to be the source of the Thunder Spirits as the 'Gate of Storms'. A similar gate was indeed used by Lord Jeyvan during his invasion of the Green Isle. But the Gate is older than Jeyvan. The ancients who built the Gate, along with its sister on the Green Isle, once built a network of gates across all of known Irdya. Jeyvan's Lich-Lords merely stumbled on the gate they used to pollute the Green Isle with orcs. Today, rather few gates have survived the passages of time, let alone the ravages of wars and empires. Most of those which are left remain concealed with magics beyond the ken of the common wizards of this age.

For my purposes, the Gate has been a valuable object of study as an example of bridging the planes. A crude microcosm of my ultimate objective, but nonetheless one which has provided many insights to the construction of the Engine. The orcs avoid the land near the Gate, which has become a testing ground for experiments too large to be conducted in the Laboratory. But know this: all of my servants are strictly forbidden from approaching the Gate without my express permission. Not only do the Thunder Spirits frequently manifest at the Gate, but the inadvertent activation of the Gate has the potential of untold consequences for the safe and efficient operation of the Engine.</span>"
        [/show_text_box_dialog]
        {VARIABLE read_about_gate yes}
        [remove_item]
            x=$lab_book_x
            y=$lab_book_y
            image="items/book4.png"
        [/remove_item]
    [/event]

    [event]
        name=moveto
        [filter]
            x=$automata_book_x
            y=$automata_book_y
            side=1
        [/filter]
        [show_text_box_dialog]
            text= _ "<span size='xx-large' stretch='semiexpanded'><u>Automata: Theory and Construction</u></span>
<span size='large'>The Engine shall forever be known throughout all of history. Not only as my greatest work, but as the apex of what can be accomplished by the human mind and hands. MY mind and MY hands. Yet I have produced an enormous variety of lesser wonders as well. Most awesome among these are the Automata. These serve in many ways. As manual laborers which never tire, never sleep, never cease in their labors. Laborers that can survive conditions that would break even the hardiest of my mortal servants. Also as sentinels, both to maintain security in the Laboratory and as an army should others dare to interfere with my plans.

Two inventions reside at the core of each Automaton; the Core Praxis Unifier (CPU) and the Regulator of Arcane Magic (RAM). Many lesser wizards have learned to animate various golems and familiars. But these suffer from the limitation of being bound to the task they were created. The CPU overcomes this by incorporating a variety of Praxis Routines which I have termed Programs, each of which utilizes derivatives of golem magic to encode a particular task. By way of miniscule pathways of metal and carefully modulated pulses of lightning the CPU can load various Programs as needed. Adding and removing Programs in this way becomes simple, with no need to renew enchantments or reconstruct the Automaton in question.

Automata require both magic and caged lightning to operate. Their magical source is derived from a bound soul, trapped in place by runes that some of the necromancers among us would find vaguely familiar. The RAM siphons energy from the soul to supply the various Programs along with a rotary magnetic armature which generates synthetic lightning. Such synthetic lightning can be far more easily channeled throughout the chassis of the Automation by way of metallic wires. When these wires are connected to another rotary magnetic armature the device functions in reverse, transforming synthetic lightning back into motion. Such armatures are built into various hard points in the chassis, and supply the Automaton with incredible amounts of motive force. All the while glyphs of holy magic sustain the strength of the empowering soul.

The Automata represent only an infintesimal fraction of the elegance and complexity of the Engine, though are by no means simple to craft. Indeed, the first Automaton was quite difficult even for a wizard of my unparalled talents. However I had yet another revelation. Most of the complexity of an Automaton is mechanical, and hence can be built by other Automata. By grafting specialized Automata to a rolling line with each Automaton performing a single construction sub-task, a great many Automata chassis can be built in a short period of time. The soul binding ritual and glyph crafting techniques have been refined to be within the talents of a sufficiently trained wizard of mere middling skill. As for the origin of these bespoke souls, that is a lesson for another time.</span>"
        [/show_text_box_dialog]
        [remove_item]
            x=$automata_book_x
            y=$automata_book_y
            image="items/book6.png"
        [/remove_item]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            x=$prison_levers_x
            y=$prison_levers_y
            side=1
        [/filter]
        [message]
            speaker=unit
            message= _ "A lever! Should I pull it?"
            [option]
                label= _ "Yes."
                default=yes
                [command]
                    [handle_prison_lever]
                        x,y=$x1,$y1
                    [/handle_prison_lever]
               [/command]
            [/option]
            [option]
                label= _ "No."
                [command]
                    [allow_undo]
                    [/allow_undo]
                [/command]
            [/option]
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            x=$resist_amulet_x
            y=$resist_amulet_y
            side=1
        [/filter]
        [message]
            speaker=unit
            message= _ "As I reach for this amulet I feel an odd sense of fortitude."
        [/message]
        [object]
            [filter]
                x,y=$x1,$y1
            [/filter]
            [effect]
                apply_to=resistance
                replace=no
                [resistance]
                    arcane=-30
                [/resistance]
            [/effect]
            duration=forever
            id=resist_amulet
            image="icons/ankh_necklace.png"
            name= _ "Spellcrafter's Wardstone"
            description= _ "This enchanted amulet provides 30% resistance to arcane attacks."
        [/object]
        [remove_item]
            x,y=$x1,$y1
        [/remove_item]
        [item]
            x,y=$x1,$y1
            image="items/bones.png~FL(horiz)"
        [/item]
    [/event]

    [event]
        name=malakar_void_quip
        [message]
            speaker=Malakar
            message= _ "Whoever wrote this is obsessed with some sort of 'void'. Whatever it is, this cannot be good."
        [/message]
    [/event]

    [event]
        name=update_objectives
        first_time_only=no
        [if]
            [variable]
                name=engine_inst_gotten
                boolean_equals=yes
            [/variable]
            [then]
                [if]
                    [variable]
                        name=orb_colors
                        equals=""
                    [/variable]
                    [then]
                        {OBJECTIVES_HEADER}
                            summary= _ "Find a way to free the tribe"
                            {CONDITION_WIN ( _ "Destroy the Engine!")}
                            {CONDITION_LOSE ( _ "Death of Malakar")}
                            [note]
                                red,blue,green=0,255,255
                                description="<b>" + _"Your gold stockpile is frozen during this scenario." + "</b>"
                            [/note]
                        {OBJECTIVES_FOOTER}
                    [/then]
                    [else]
                        {OBJECTIVES_HEADER}
                            summary= _ "Find a way to free the tribe"
                            {CONDITION_WIN ( _ "Destroy the colored orbs")}
                            {CONDITION_LOSE ( _ "Death of Malakar")}
                            [note]
                                red,blue,green=0,255,255
                                description="<b>" + _"Your gold stockpile is frozen during this scenario." + "</b>"
                            [/note]
                        {OBJECTIVES_FOOTER}
                    [/else]
                [/if]
            [/then]
            [else]
                {OBJECTIVES_HEADER}
                    summary= _ "Find a way to free the tribe"
                    {CONDITION_WIN ( _ "Explore the underground complex")}
                    {CONDITION_LOSE ( _ "Death of Malakar")}
                    [note]
                        red,blue,green=0,255,255
                        description="<b>" + _"Your gold stockpile is frozen during this scenario." + "</b>"
                    [/note]
                {OBJECTIVES_FOOTER}
            [/else]
        [/if]
    [/event]

    [event]
        name=moveto
        [filter]
            id=Malakar
            [filter_location]
                terrain="Uu"
                [and]
                    x,y=$malakar_run_x,$malakar_run_y
                    radius=5
                [/and]
            [/filter_location]
        [/filter]
        [message]
            id=Malakar
            message= _ "I must find a way to free the tribe before I leave!"
        [/message]
    [/event]

    [event]
        name=victory
        [clear_menu_item]
            id=aa_show_journal
        [/clear_menu_item]
        [clear_menu_item]
            id=enable_auto_end_turn
        [/clear_menu_item]
        [clear_menu_item]
            id=e_disable_auto_end_turn
        [/clear_menu_item]
        [modify_side]
            side=1
            gold=$s11b_player_gold
        [/modify_side]
        {CLEAR_VARIABLE s11b_player_gold}
        {CLEAR_VARIABLE malakar_run_x}
        {CLEAR_VARIABLE malakar_run_y}
        {CLEAR_VARIABLE healing_glyph_x}
        {CLEAR_VARIABLE healing_glyph_y}
        {CLEAR_VARIABLE damage_glyph_x}
        {CLEAR_VARIABLE damage_glyph_y}
        {CLEAR_VARIABLE assistant_note_x}
        {CLEAR_VARIABLE assistant_note_y}
        {CLEAR_VARIABLE journal_x}
        {CLEAR_VARIABLE journal_y}
        {CLEAR_VARIABLE orbs_x}
        {CLEAR_VARIABLE orbs_y}
        {CLEAR_VARIABLE orb_guards_x}
        {CLEAR_VARIABLE orb_guards_y}
        {CLEAR_VARIABLE machine_x}
        {CLEAR_VARIABLE machine_y}
        {CLEAR_VARIABLE console_x}
        {CLEAR_VARIABLE console_y}
        {CLEAR_VARIABLE viewed_console}
        {CLEAR_VARIABLE engine_inst_x}
        {CLEAR_VARIABLE engine_inst_y}
        {CLEAR_VARIABLE engine_inst_gotten}
        {CLEAR_VARIABLE control_room_x}
        {CLEAR_VARIABLE control_room_y}
        {CLEAR_VARIABLE prison_levers_x}
        {CLEAR_VARIABLE prison_levers_y}
        {CLEAR_VARIABLE prison_cell_idx}
        {CLEAR_VARIABLE resist_amulet_x}
        {CLEAR_VARIABLE resist_amulet_y}
        {CLEAR_VARIABLE blueprint_x}
        {CLEAR_VARIABLE blueprint_y}
        {CLEAR_VARIABLE isle_book_x}
        {CLEAR_VARIABLE isle_book_y}
        {CLEAR_VARIABLE lab_book_x}
        {CLEAR_VARIABLE lab_book_y}
        {CLEAR_VARIABLE automata_book_x}
        {CLEAR_VARIABLE automata_book_y}
        {CLEAR_VARIABLE orig_orb_colors}
        {CLEAR_VARIABLE orb_colors}
        {CLEAR_VARIABLE alarms_triggered}
        {CLEAR_VARIABLE automata_notification_state}
        {CLEAR_VARIABLE journal_str}
        {CLEAR_VARIABLE last_journal_date}
        {CLEAR_VARIABLE damage_glyphs_triggered}
        {CLEAR_VARIABLE difficulty_score}
        {CLEAR_VARIABLE auto_end_turn}
    [/event]

    {FREEDOM_DEATHS}

    {FTF_COMMON}

#undef RANDOM_DRAKE_UNIT
[/scenario]
