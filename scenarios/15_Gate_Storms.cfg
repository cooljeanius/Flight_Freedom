#textdomain wesnoth-Flight_Freedom

[scenario]
    name= _ "Gate of Storms"
    {MAP 15}
    {TURNS 52 51 50}
#ifdef HAVE_UMC10_MUSIC
    {SCENARIO_MUSIC acherontic.ogg}
#else
    {SCENARIO_MUSIC the_city_falls.ogg}
#endif
    id=Gate_Storms
    victory_when_enemies_defeated=no
    next_scenario="Exodus"

#ifdef HAVE_AWAS
    {DEFAULT_SCHEDULE}
#else
    {ADD_WEATHER_ASHFALL}
    {WEATHER_CONTROLLER}
    {DEFAULT_SCHEDULE_ASHFALL}
#endif

    [side]
        type=Drake Chieftain
        id=Malakar
        name= _ "Malakar"
        side=1
        {FLAG_VARIANT drake}
        canrecruit=yes
        controller=human
        recruit=Drake Hatchling,Drake Slave,Drake Burner,Drake Glider,Drake Fighter,Drake Clasher
        unrenamable=yes
        team_name=good
        user_team_name= _ "Kakatar Tribe"
        fog=no
        {GOLD 180 140 100}
        {INCOME 3 2 1}
    [/side]
    [side]
        id=s15_undead_leader
        type=Lich
        side=2
        {FLAG_VARIANT undead}
        controller=ai
        canrecruit=yes
        {GOLD 200 250 300}
        recruit=Skeleton,Skeleton Archer,Ghoul,Ghost,Skeleton Rider,Dark Adept,Minor Spirit
        team_name=evil
        user_team_name= _ "Gate Guardians"
        [ai]
            #force him to recruit at least one Minor Spirit on turn 1
            [aspect]
                id=recruitment_instructions
                [facet]
                    turns=1
                    [value]
                        [recruit]
                            type=Minor Spirit
                            number=1
                            total=yes
                            importance=1
                        [/recruit]
                        [recruit]
                            importance=0
                        [/recruit]
                    [/value]
                [/facet]
            [/aspect]
            passive_leader=yes
            passive_leader_shares_keep=yes
        [/ai]
        [ai]
            [avoid]
                x=38
                y=7
            [/avoid]
        [/ai]
    [/side]
    [side]
        side=3
        {FLAG_VARIANT6 ragged}
        controller=ai
        recruit=
        no_leader=yes
        team_name=evil
        user_team_name= _ "Gate Guardians"
    [/side]

    [label]
        x,y=43,4
        text= _ "Gate of Storms"
    [/label]

    {OBJECTIVES_HEADER_BEGIN}
        summary= _ "Destroy the Gate of Storms"
        {CONDITION_WIN ( _ "Move a unit onto the Gate of Storms")}
        {OBJECTIVES_LOSE}
        {GOLD_CARRYOVER_STANDARD}
    {OBJECTIVES_FOOTER_BEGIN}

#define GATE_ITEM
    [item]
        x=43
        y=4
        halo=scenery/gate-storms1.png,scenery/gate-storms2.png,scenery/gate-storms3.png,scenery/gate-storms2.png
        #in case halos are turned off
        image=scenery/gate-storms.png
    [/item]
#enddef

    #since he should mostly recruit undead
#ifdef EASY
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Minor Spirit" 2}
#else
    #when not easy, can only have one at a time since they're really not that great vs. drakes
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Minor Spirit" 1}
#endif

    [event]
        name=prestart
        [set_variable]
            name=spirit_counter
            value=0
        [/set_variable]
        #gate
        {GATE_ITEM}
        [item]
            x=34
            y=1
            halo=scenery/fire1.png,scenery/fire2.png,scenery/fire3.png,scenery/fire4.png,scenery/fire5.png,scenery/fire6.png,scenery/fire7.png,scenery/fire8.png
        [/item]
        [item]
            x=44
            y=8
            halo=scenery/fire2.png,scenery/fire3.png,scenery/fire4.png,scenery/fire5.png,scenery/fire6.png,scenery/fire7.png,scenery/fire8.png,scenery/fire1.png
        [/item]
        [item]
            x=42
            y=17
            halo=scenery/fire5.png,scenery/fire6.png,scenery/fire7.png,scenery/fire8.png,scenery/fire1.png,scenery/fire2.png,scenery/fire3.png,scenery/fire4.png
        [/item]
        [item]
            x=33
            y=9
            halo=scenery/fire7.png,scenery/fire8.png,scenery/fire1.png,scenery/fire2.png,scenery/fire3.png,scenery/fire4.png,scenery/fire5.png,scenery/fire6.png
        [/item]
        [sound_source]
            id=gate_wind
            x,y=38,7
            sounds=howling-wind-loop.ogg
            delay=0
            loop=-1
            check_fogged=no
            check_shrouded=no
        [/sound_source]
        [if]
            [variable]
                name=gave_up_kogw
                boolean_equals=no
            [/variable]
            [then]
                [recall]
                    id=Kogw
                    x,y=11,25
                [/recall]
            [/then]
            [else]
                [recall]
                    id=Theracar
                    x,y=11,25
                [/recall]
            [/else]
        [/if]
        [recall]
            id=Elealonna
            x,y=12,26
        [/recall]
        [unit]
            x,y=41,5
            side=3
            type=Major Spirit
            id=Thromor
            name= _ "Thromor"
        [/unit]
        [micro_ai]
            side=3
            ai_type=zone_guardian
            action=add
            id=Thromor
            [filter_location]
                [and]
                    x,y=43,4
                    radius=6
                [/and]
            [/filter_location]
        [/micro_ai]
        [set_variable]
            name=base_undead_income
            value={ON_DIFFICULTY 18 20 22}
        [/set_variable]
        #lower number corresponds to faster gold increase
        [set_variable]
            name=undead_income_ramp
            value={ON_DIFFICULTY 1.7 1.5 1.3}
        [/set_variable]
        #~50% of undead get this much exp per turn, the others get this much + 1 (to avoid large chunks of the enemy army leveling at once)
        [set_variable]
            name=undead_base_turn_exp
            value=4
        [/set_variable]
        [set_variable]
            name=malakar_creepy_chats
            value=0
        [/set_variable]
        {VARIABLE enemy_leader_killed 0}
#ifdef HAVE_AWAS
        [AWaS_Create_Basic_Scenery]
            id=ashfall
            Scenery_Type=ash_fall
            [filter_location]
            [/filter_location]
        [/AWaS_Create_Basic_Scenery]
#endif
    [/event]

    [event]
        name=start
#ifndef HAVE_AWAS
        {WEATHER_EXPLANATION_MESSAGE}
        [fire_event]
            name=update_weather
        [/fire_event]
#endif
        [if]
            [variable]
                name=gave_up_kogw
                boolean_equals=no
            [/variable]
            [then]
                [message]
                    speaker=Kogw
                    message= _ "There, beyond that castle! This is the Gate of Storms!"
                [/message]
                [message]
                    speaker=Malakar
                    message= _ "I want three scouts sent south and east. Find a safe path past the Gate. Hopefully, it will distract and slow any who would follow us."
                [/message]
                [message]
                    speaker=Kogw
                    message= _ "With respect, Malakar, the Gate is open. It probably doesn't matter what we do - in time, this island, Wesnoth and all of Morogor will be overrun and destroyed. You can run to the ends of the world, and rotting corpses will still hound your steps..."
                [/message]
                [message]
                    speaker=Malakar
                    sound=fire.wav
                    message= _ "<span size='large'>*<i>growls</i>*</span>"
                [/message]
                [message]
                    speaker=Kogw
                    message= _ "...never sleeping, never stopping, never tiring, hungering only for blood..."
                [/message]
                [message]
                    speaker=Malakar
                    message= _ "I have new orders. I want any available scouts to investigate the Gate. We will see if it has a weakness, and attempt to shut it before moving on."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Theracar
                    image=$theracar_image
                    message= _ "There, beyond that castle! This must be the Gate of Storms!"
                [/message]
                [message]
                    speaker=Malakar
                    message= _ "I want three scouts sent south and east. Hopefully, we can slip past the Gate and the undead will distract and slow any who would follow us."
                [/message]
                [message]
                    speaker=Theracar
                    image=$theracar_image
                    message= _ "The undead are seemingly without number and the thunder spirits have not ceased to assail us. I fear that there is no safe path, and that our only hope of escape is to destroy the Gate!"
                [/message]
                [message]
                    speaker=Malakar
                    message= _ "Your counsel is wise, captain. I have new orders. I want any available scouts to investigate the Gate. We will see if it has a weakness, and attempt to shut it before moving on."
                [/message]
            [/else]
        [/if]
        {VARIABLE gate_state 0}
    [/event]

    [event]
        name=recall
        #wmllint: recognize Morlin Ka
        [filter]
            id=Morlin Ka
        [/filter]
        [message]
            speaker=Morlin Ka
            message= _ "This gate is an abomination! Gar-Alagar wills its destruction. Forward, drakes!"
        [/message]
    [/event]

    [event]
        name=prerecruit,prerecall
        first_time_only=no
        [filter]
            side=2
            type=Minor Spirit
        [/filter]
        [remove_item]
            x=43
            y=4
        [/remove_item]
        [item]
            x=43
            y=4
            image=scenery/gate-storms4.png
            halo=halo/shadow-mage-halo1.png,halo/shadow-mage-halo2.png,halo/shadow-mage-halo3.png,halo/shadow-mage-halo4.png,halo/shadow-mage-halo5.png,halo/shadow-mage-halo6.png,halo/shadow-mage-halo7.png,halo/shadow-mage-halo8.png,halo/shadow-mage-halo9.png,halo/shadow-mage-halo10.png
        [/item]
        [delay]
            time=200
        [/delay]
        [remove_item]
            x=43
            y=4
        [/remove_item]
        {GATE_ITEM}
    [/event]

    {RECRUIT_RUN_FILTER 43 4 38 6 2 (type=Minor Spirit)}
    {RECRUIT_RUN_FILTER 43 4 37 7 2 (type=Minor Spirit)}
    {RECRUIT_RUN_FILTER 43 4 39 7 2 (type=Minor Spirit)}
    {RECRUIT_RUN_FILTER 43 4 37 8 2 (type=Minor Spirit)}
    {RECRUIT_RUN_FILTER 43 4 39 8 2 (type=Minor Spirit)}
    {RECRUIT_RUN_FILTER 43 4 38 8 2 (type=Minor Spirit)}

    [event]
        name=moveto
        [filter]
            x,y=43,4
            id=Malakar
        [/filter]
        [if]
            [variable]
                name=malakar_creepy_chats
                numerical_equals=4
            [/variable]
            [then]
                [message]
                    speaker=narrator
                    image=scenery/gate-storms4.png
                    sound=lich-die.ogg
                    message= _ "Join us... bring death to the humans... bring death to ALL!"
                [/message]
                [message]
                    speaker=Malakar
                    message= _ "..."
                    [option]
                        label= _ "I! Am! MALAKAR! And I reject your evil!"
                        [command]
                            [message]
                                speaker=narrator
                                image=scenery/gate-storms4.png
                                message= _ "Death shall find you... in the end..."
                            [/message]
                            [message]
                                speaker=Malakar
                                message= _ "Then I shall live on in the memory of my tribe. Begone!"
                            [/message]
                            [modify_unit]
                                [filter]
                                    id=Malakar
                                [/filter]
                                {TRAIT_FEARLESS}
                            [/modify_unit]
                            [message]
                                speaker=narrator
                                {NARRATOR_ICON}
                                message= _ "Malakar gains the Fearless trait!"
                                # wmllint: no-icon
                            [/message]
                        [/command]
                    [/option]
                    [option]
                        label= _ "I... I must submit... I surrender to you..."
                        #maybe add a secret scenario after this?
                        [command]
                            [remove_item]
                                x=43
                                y=4
                            [/remove_item]
                            [terrain]
                                x,y=43,4
                                terrain=Uu
                            [/terrain]
                            [label]
                                x,y=43,4
                                text=""
                            [/label]
                            [item]
                                x=43
                                y=4
                                image=scenery/gate-storms4.png
                            [/item]
                            [message]
                                speaker=narrator
                                image=scenery/gate-storms4.png
                                sound=dwarf-laugh.wav
                                message= _ "Then enter... embrace the End of all things!"
                            [/message]
                            [store_unit]
                                [filter]
                                    id=Malakar
                                [/filter]
                                variable=malakar_store
                            [/store_unit]
                            [kill]
                                id=Malakar
                                animate=no
                                fire_event=no
                            [/kill]
                            [if]
                                [variable]
                                    name=malakar_store.type
                                    equals="Drake Chieftain"
                                [/variable]
                                [then]
                                    [unit]
                                        x,y=43,4
                                        type=Drake Chieftain Silhouette
                                        facing=se
                                    [/unit]
                                [/then]
                                [else]
                                    [unit]
                                        x,y=43,4
                                        type=Drake Lord Silhouette
                                        facing=se
                                    [/unit]
                                [/else]
                            [/if]
                            {CLEAR_VARIABLE malakar_store}
                            [kill]
                                x,y=43,4
                                animate=yes
                                fire_event=no
                            [/kill]
                            [unit]
                                x,y=43,4
                                type=Avatar of Ending
                                unrenamable=yes
                                id=Malakar
                                name= _ "Malakar"
                                side=1
                                canrecruit=yes
                                facing=se
                            [/unit]
                            [delay]
                                time=500
                            [/delay]
                            #just in case a unit is here
                            [if]
                                [variable]
                                    name=gave_up_kogw
                                    boolean_equals=no
                                [/variable]
                                [then]
                                    {MOVE_UNIT_DISPLACE_CURRENT 42 4 (
                                        id=Kogw
                                        fire_event=no
                                    )}
                                [/then]
                                [else]
                                    {MOVE_UNIT_DISPLACE_CURRENT 42 4 (
                                        id=Theracar
                                        fire_event=no
                                    )}
                                [/else]
                            [/if]
                            [scroll_to_unit]
                                id=Malakar
                            [/scroll_to_unit]
                            [lock_view]
                            [/lock_view]
                            [store_unit]
                                [filter]
                                    side=2,3
                                [/filter]
                                variable=enemy_units
                            [/store_unit]
                            [foreach]
                                array=enemy_units
                                variable=this_item
                                readonly=no
                                [do]
                                    {VARIABLE this_item.side 1}
                                    {VARIABLE this_item.canrecruit no}
                                    [unstore_unit]
                                        variable=this_item
                                    [/unstore_unit]
                                [/do]
                            [/foreach]
                            {CLEAR_VARIABLE enemy_units}
                            [message]
                                speaker=Kogw
                                message= _ "Mal, what have you done???"
                            [/message]
                            [message]
                                speaker=Theracar
                                image=$theracar_image
                                message= _ "Malakar... you have betrayed the tribe and I shall strike you down!"
                            [/message]
                            [message]
                                speaker=Malakar
                                message= _ "<span color='purple' size='larger'><b><i>END.</i></b></span>"
                            [/message]
                            [animate_unit]
                                [filter]
                                    x,y=43,4
                                [/filter]
                                flag=attack
                                [primary_attack]
                                    range=ranged
                                [/primary_attack]
                                hits=kill
                                [facing]
                                    x,y=42,4
                                [/facing]
                            [/animate_unit]
                            [if]
                                [variable]
                                    name=gave_up_kogw
                                    boolean_equals=no
                                [/variable]
                                [then]
                                    [sound]
                                        name=scream.ogg
                                    [/sound]
                                    [delay]
                                        time=500
                                    [/delay]
                                    [kill]
                                        id=Kogw
                                        animate=yes
                                        fire_event=no
                                        [secondary_unit]
                                            id=Malakar
                                        [/secondary_unit]
                                        [primary_attack]
                                            range=ranged
                                        [/primary_attack]
                                    [/kill]
                                    {VARIABLE kogw_alive no}
                                [/then]
                                [else]
                                    [sound]
                                        name=fire.wav
                                    [/sound]
                                    [delay]
                                        time=500
                                    [/delay]
                                    [kill]
                                        id=Theracar
                                        animate=yes
                                        fire_event=no
                                        [secondary_unit]
                                            id=Malakar
                                        [/secondary_unit]
                                        [primary_attack]
                                            range=ranged
                                        [/primary_attack]
                                    [/kill]
                                    {VARIABLE theracar_alive no}
                                [/else]
                            [/if]
                            [unlock_view]
                            [/unlock_view]
                            [endlevel]
                                result=defeat
                                music=defeat.ogg,defeat2.ogg
                            [/endlevel]
                        [/command]
                    [/option]
                [/message]
            [/then]
        [/if]
    [/event]

    [event]
        name=moveto
        [filter]
            x,y=43,4
            side=1
            [not]
                type=Drake Burner,Fire Drake,Inferno Drake,Armageddon Drake
            [/not]
        [/filter]
        [if]
            [variable]
                name=gate_state
                numerical_equals=0
            [/variable]
            [then]
                [if]
                    [variable]
                        name=unit.id
                        not_equals="Malakar"
                    [/variable]
                    [or]
                        [variable]
                            name=malakar_creepy_chats
                            numerical_not_equals=4
                        [/variable]
                    [/or]
                    [then]
                        [message]
                            speaker=unit
                            message= _ "Such... strange... power. I cannot get close enough to touch the gate. Physical force is worthless here!"
                        [/message]
                        [message]
                            speaker=Malakar
                            message= _ "The spirits are redoubling their efforts! I need any remaining Burners to surround the Gate, getting as close as you can, and set it ablaze! Everyone else, cover for them."
                        [/message]
                    [/then]
                [/if]
                {OBJECTIVES_HEADER}
                    summary= _ "Destroy the Gate of Storms"
                    {CONDITION_WIN ( _ "Move a Drake Burner, Fire Drake, Inferno Drake, or Armageddon Drake onto the Gate of Storms")}
                    {OBJECTIVES_LOSE}
                    {GOLD_CARRYOVER_STANDARD}
                {OBJECTIVES_FOOTER}
            [/then]
            [else]
                [message]
                    speaker=narrator
                    {NARRATOR_ICON}
                    message= _ "A Fire, Inferno or Armageddon Drake is necessary to destroy the Gate of Storms."
                    # hey wmllint stop putting image=wesnoth-icon.png here; we already use {NARRATOR_ICON} above
                    # wmllint: no-icon
                [/message]
            [/else]
        [/if]
    [/event]

    #debating letting the player keep her after this scenario; it'd be cool to have an arch mage
    #(and likely level to great mage) along however would be very difficult to justify her
    #turning against Wesnoth
    [event]
        name=turn 3
        [message]
            speaker=Elealonna
            message= _ "I... I feel a coldness, a terrible, crushing coldness in my chest... I fear my time is coming to a close..."
        [/message]
    [/event]

    [event]
        name=turn 9
        [kill]
            id=Elealonna
            animate=yes
            fire_event=yes
        [/kill]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Elealonna
        [/filter]
        [message]
            speaker=Elealonna
            message= _ "And so it ends... grant final rest to my companions, I beg you..."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            x,y=43,4
            side=1
            type=Drake Burner
        [/filter]
        [message]
            speaker=unit
            # wmllint: general spelling firebreather
            message= _ "My fire is too weak. We need a stronger firebreather!"
        [/message]
        {OBJECTIVES_HEADER}
            summary= _ "Destroy the Gate of Storms"
            {CONDITION_WIN ( _ "Move a Fire, Inferno or Armageddon Drake onto the Gate of Storms")}
            {OBJECTIVES_LOSE}
            {GOLD_CARRYOVER_STANDARD}
        {OBJECTIVES_FOOTER}
        {VARIABLE gate_state 1}
    [/event]

    [event]
        name=moveto
        [filter]
            x,y=43,4
            type=Fire Drake,Inferno Drake,Armageddon Drake
        [/filter]
        [message]
            speaker=unit
            message= _ "I call upon Gar-Hagar, god of all that is burning and favored child of Gar-Alagar, to destroy this portal of evil!"
        [/message]
        [remove_item]
            x,y=43,4
        [/remove_item]
        [item]
            x=43
            y=4
            image=scenery/gate-storms.png
        [/item]
        [remove_sound_source]
            id=gate_wind
        [/remove_sound_source]
        [if]
            [variable]
                name=unit.type
                equals="Armageddon Drake"
            [/variable]
            [then]
                {CONDITIONAL_AWARD_ACHIEVEMENT ftf_kill_fire}
            [/then]
            [else]
                [message]
                    speaker=Kogw
                    message= _ "Wow, that was quite the fiery display! I just wonder if it could have been even more fiery..."
                [/message]
                [message]
                    speaker=Theracar
                    image=$theracar_image
                    message= _ "The portal seems to have closed. We must hope it remains closed for the foreseeable future... perhaps with a hotter flame."
                [/message]
            [/else]
        [/if]
        [if]
            [have_unit]
                id=Elealonna
            [/have_unit]
            [then]
                [message]
                    speaker=Elealonna
                    message= _ "Noble drakes... you have my gratitude. Now I can die in peace..."
                [/message]
            [/then]
        [/if]
        [endlevel]
            result=victory
            bonus=yes
            carryover_percentage={ON_DIFFICULTY 80 70 60}
        [/endlevel]
    [/event]

    [event]
        name=victory
        {CLEAR_VARIABLE gate_state}
        {CLEAR_VARIABLE spirit_counter}
        {CLEAR_VARIABLE malakar_creepy_chats}
        {CLEAR_VARIABLE enemy_leader_killed}
        {CLEAR_VARIABLE base_undead_income}
        {CLEAR_VARIABLE undead_income_ramp}
        {CLEAR_VARIABLE undead_base_turn_exp}
    [/event]

    [event]
        name=die
        [filter]
            id=Thromor
        [/filter]
        [message]
            speaker=Malakar
            message= _ "The Gate is still open! Close it quickly before any more monsters come through!"
        [/message]
    [/event]

    {FREEDOM_DEATHS}

    [event]
        name=turn 2
        [message]
            speaker=Kogw
            message= _ "I feel a growing sensation of evil. As if the undead are growing stronger before our eyes!"
        [/message]
        [message]
            speaker=Theracar
            image=$theracar_image
            message= _ "I feel a growing sensation of evil. As if the undead are growing stronger before our eyes!"
        [/message]
        [if]
            [have_unit]
                id=Elealonna
            [/have_unit]
            [then]
                #part of the reward for keeping her alive is the hint a fire-breather is needed
                [message]
                    speaker=Elealonna
                    # wmllint: local spelling thaumic
                    message= _ "Indeed the dark magic in the air thickens... we must stop the thaumic flow at its source... destabilize the planar vortex... asymmetric local perturbation of entropy should initiate cascading harmonic failure and interrupt transdimensional flux..."
                [/message]
                [message]
                    speaker=Malakar
                    message= _ "Speak plainly, human!"
                [/message]
                [message]
                    speaker=Elealonna
                    message= _ "Apologies... we must set the gate on fire... that should close it..."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Malakar
                    message= _ "I too feel the undead menace growing. We must close the gate quickly. Onward!"
                [/message]
            [/else]
        [/if]
        [event]
            name=new turn
            first_time_only=no
            #20% chance, however they're more likely than before since we no longer restrict them to nonconsecutive turns or a maximum number
            {RANDOM 1..5}
            [if]
                [variable]
                    name=random
                    numerical_equals=1
                [/variable]
                [then]
                    [set_variable]
                        name=thunderx
                        rand=1..45
                    [/set_variable]
                    [set_variable]
                        name=thundery
                        rand=1..30
                    [/set_variable]
                    [scroll_to]
                        x=$thunderx
                        y=$thundery
                    [/scroll_to]
                    [item]
                        x=$thunderx
                        y=$thundery
                        halo=halo/shadow-mage-halo1.png,halo/shadow-mage-halo2.png,halo/shadow-mage-halo3.png,halo/shadow-mage-halo4.png,halo/shadow-mage-halo5.png,halo/shadow-mage-halo6.png,halo/shadow-mage-halo7.png,halo/shadow-mage-halo8.png,halo/shadow-mage-halo9.png,halo/shadow-mage-halo10.png
                    [/item]
                    [sound]
                        name=lightning.ogg
                    [/sound]
                    [sound]
                        name=fire.wav
                    [/sound]
                    [color_adjust]
                        red=100
                        green=100
                        blue=100
                    [/color_adjust]
                    [unit]
                        x=$thunderx
                        y=$thundery
                        type=Thunder Spirit
                        side=3
                    [/unit]
                    [delay]
                        time=10
                    [/delay]
                    [color_adjust]
                        red=0
                        green=0
                        blue=0
                    [/color_adjust]
                    [scroll_to]
                        x=$thunderx
                        y=$thundery
                    [/scroll_to]
                    [delay]
                        time=200
                    [/delay]
                    [remove_item]
                        x=$thunderx
                        y=$thundery
                    [/remove_item]
                    [message]
                        speaker=Kogw
                        message= _ "A spirit has attacked!"
                    [/message]
                    [if]
                        [variable]
                            name=spirit_counter
                            numerical_equals=2
                        [/variable]
                        [then]
                            [message]
                                speaker=Malakar
                                message= _ "Focus on the gate!"
                            [/message]
                        [/then]
                    [/if]
                    {VARIABLE_OP spirit_counter add 1}
                    {CLEAR_VARIABLE thunderx}
                    {CLEAR_VARIABLE thundery}
                [/then]
            [/if]
            {CLEAR_VARIABLE random}
        [/event]

        #undead grow in strength with free experience each turn
        [event]
            name=side 2 turn
            first_time_only=no
            [store_unit]
                [filter]
                    side=2
                [/filter]
                variable=side2units
                [not]
                    type=Minor Spirit,Thunder Spirit,Major Spirit
                [/not]
            [/store_unit]
            [foreach]
                array=side2units
                variable=this_item
                readonly=no
                [do]
                    [lua]
                        code = <<
                            local new_exp = wml.variables["this_item.experience"] + wml.variables["undead_base_turn_exp"]
                            local bonus_exp = string.byte(wml.variables["this_item.id"], -1, -1) % 2
                            wml.variables["this_item.experience"] = new_exp + bonus_exp
                        >>
                    [/lua]
                    [unstore_unit]
                        variable=this_item
                    [/unstore_unit]
                [/do]
            [/foreach]
            {CLEAR_VARIABLE side2units}
        [/event]

        #so the evilgrams don't stay on screen the whole scenario
        #we don't start clearing until turn 2 to avoid suppressing any warnings/errors on start while debugging
        [event]
            name=new turn
            first_time_only=no
            [clear_chat]
            [/clear_chat]
        [/event]
    [/event]

    #undead also get increasing income
    [event]
        name=new turn
        first_time_only=no
        {VARIABLE current_undead_income 0}
        [lua]
            code = <<
                local addl_gold = math.floor(wesnoth.current.turn / wml.variables["undead_income_ramp"])
                local undead_income = wml.variables["base_undead_income"] + addl_gold
                wml.variables["current_undead_income"] = undead_income
            >>
        [/lua]
        [modify_side]
            side=2
            income=$current_undead_income
        [/modify_side]
        {CLEAR_VARIABLE current_undead_income}
    [/event]

    [event]
        name=time over
        [message]
            speaker=Malakar
            message= _ "The Gate... it's glowing..."
        [/message]
        [delay]
            time=500
        [/delay]
        {THUNDER (
            [kill]
                side=1
                animate=yes
                fire_event=no
            [/kill]
            [delay]
                time=500
                accelerate=yes
            [/delay]
        )}
        [endlevel]
            result=defeat
            music=defeat.ogg,defeat2.ogg
        [/endlevel]
    [/event]

    #creepy text as the player gets closer to the Gate
#define CREEPY_CHAT RADIUS MESSAGE
    [event]
        name=enter_hex
        [filter]
            side=1
            [filter_location]
                [and]
                    x,y=43,4
                    radius={RADIUS}
                [/and]
            [/filter_location]
        [/filter]
        [chat]
            speaker={MESSAGE}
            observable=yes
            side=1
            message=""
        [/chat]
        [sound]
            name=lich-die.ogg
            repeat=2
        [/sound]
        [delay]
            time=4000
            accelerate=no
        [/delay]
        [if]
            [variable]
                name=unit.id
                equals="Malakar"
            [/variable]
            [then]
                {VARIABLE_OP malakar_creepy_chats add 1}
                [switch]
                    variable=malakar_creepy_chats
                    [case]
                        value=3
                        [message]
                            speaker=Malakar
                            message= _ "Get... out... of... my... HEAD!"
                        [/message]
                    [/case]
                    [case]
                        value=4
                        #will still make sense even if Morlin's not here
                        [message]
                            speaker=Malakar
                            message= _ "No... these voices compel me... must obey... no... no... NO!"
                        [/message]
                        [message]
                            speaker=Morlin Ka
                            message= _ "Malakar, hold fast! You must not let this evil overtake you!"
                        [/message]
                    [/case]
                [/switch]
            [/then]
        [/if]
        [cancel_action]
        [/cancel_action]
        #undo->redo after this event causes OOS. Yes, somehow OOS error in singleplayer...
#ifdef __ALLOW_OOS_IN_SINGLE_PLAYER__
        [allow_undo]
        [/allow_undo]
#endif
    [/event]
#enddef

    #a little worried this may be triggering to people struggling with suicidal ideation; if so could add trigger warning or just make it more 'take over the world muhahaha' instead of 'existential nihilism'
    {CREEPY_CHAT 14 (_ "doom to all turn back TURN BACK nightmare of ending doom destruction desolation death DEATH to the world")}
    {CREEPY_CHAT 10 (_ "darkness awaits all YOU CANNOT PREVAIL failure despair empty death void hatred misery enmity black HATE")}
    {CREEPY_CHAT 6 (_ "evil will NOT BE DENIED all must die ALL MUST END torture PAIN agony terror suffering why fight the inevitable")}
    {CREEPY_CHAT 3 (_ "all must die YOU WILL DIE DARKNESS OBLIVION give up GIVE UP ALL IS DEATH death awaits you DIE DIE DIE")}

    [event]
        name=enter_hex
        first_time_only=no
        [filter]
            side=1
            [filter_location]
                x,y=38,7
            [/filter_location]
        [/filter]
        [message]
            speaker=unit
            message= _ "Some sort of barrier is keeping me from approaching the lich!"
        [/message]
        [cancel_action]
        [/cancel_action]
        [store_unit]
            [filter]
                x,y=38,7
            [/filter]
            variable=tempstore
            kill=yes
        [/store_unit]
        [unit]
            side=1
            type=Invisible
            id=blocker
            x,y=38,7
        [/unit]
        [unstore_unit]
            x,y=$x2,$y2
            variable=tempstore
            find_vacant=yes
        [/unstore_unit]
        [kill]
            id=blocker
        [/kill]
        [redraw]
        [/redraw]
        {CLEAR_VARIABLE tempstore}
    [/event]

    [event]
        name=die
        first_time_only=no
        [filter]
            id=s15_undead_leader
        [/filter]
        {VARIABLE_OP enemy_leader_killed add 1}
        [item]
            x,y=38,7
            image=misc/bones-cloth.png~RC(magenta>blue)
        [/item]
    [/event]

    [event]
        name=new turn
        first_time_only=no
        [if]
            [not]
                [have_unit]
                    id=s15_undead_leader
                [/have_unit]
            [/not]
            [then]
                [scroll_to]
                    x,y=38,7
                [/scroll_to]
                [animate_path]
                    hex_x=43,38
                    hex_y=4,7
                    image=halo/shadow-mage-halo5.png
                    frames=20
                    frame_length=14
                [/animate_path]
                [remove_item]
                    x,y=38,7
                [/remove_item]
                [unit]
                    id=s15_undead_leader
                    type=Lich
                    side=2
                    canrecruit=yes
                    x,y=38,7
                    show=yes
                [/unit]
                [if]
                    [variable]
                        name=enemy_leader_killed
                        equals=1
                    [/variable]
                    [then]
                        [message]
                            speaker=Malakar
                            message= _ "We must destroy the Gate!"
                        [/message]
                    [/then]
                [/if]
            [/then]
        [/if]
    [/event]

#ifndef HAVE_AWAS
    [event]
        name=update_weather
        first_time_only=no
        {VARIABLE current_time $turn_number}
        {VARIABLE_OP current_time sub 1}
        {VARIABLE_OP current_time modulo 6}
        [if]
            [variable]
                name=weather_enabled
                boolean_equals=yes
            [/variable]
            [then]
                [replace_schedule]
                    {DEFAULT_SCHEDULE_ASHFALL}
                    current_time=$current_time
                [/replace_schedule]
            [/then]
            [else]
                [replace_schedule]
                    {DEFAULT_SCHEDULE}
                    current_time=$current_time
                [/replace_schedule]
            [/else]
        [/if]
        {CLEAR_VARIABLE current_time}
    [/event]
#endif

    {FTF_COMMON}

#undef GATE_ITEM
[/scenario]
