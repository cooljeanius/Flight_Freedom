#textdomain wesnoth-Flight_Freedom

[scenario]
    name= _ "Liberation"
    {MAP 19}
    {TURNS 99 69 59}
    {SCENARIO_MUSIC knalgan_theme.ogg}
    id=Liberation
    next_scenario="Battle_Temple"

    {STORY_LIBERATION}

    {UNDERGROUND}

    {BIGMAP_LIBERATION}

    #illumination from brazier
    [time_area]
        x=7-9  ,8
        y=13-14,12
        [time]
            #textdomain wesnoth
            id=underground_illumb
            name= _ "Underground"
            image=misc/time-schedules/schedule-underground-illum.png
        [/time]
    [/time_area]
    #textdomain wesnoth-Flight_Freedom

    [side]
        type=Drake Chieftain
        id=Malakar
        name= _ "Malakar"
        side=1
        {FLAG_VARIANT drake}
        canrecruit=yes
        controller=human
        recruit=Drake Hatchling,Drake Slave,Drake Burner,Drake Glider,Drake Fighter,Drake Clasher
        unrenamable=yes
        team_name=good
        shroud=yes
        fog=yes
        share_vision=all
        user_team_name= _ "Kakatar Tribe"
        {GOLD 360 240 120}
    [/side]
    #NW humans
    [side]
        type=General
        id=Cicyn
        name= _ "Cicyn"
        side=2
        {FLAG_VARIANT loyalist}
        controller=ai
        canrecruit=yes
        {GOLD 100 130 160}
        {INCOME 2 5 8}
        recruit=Swordsman,Spearman,Bowman,Javelineer
        team_name=evil
        [ai]
            grouping=no
#ifdef EASY
            simple_targeting=yes
#endif
            [aspect]
                id=attacks
                [facet]
                    invalidate_on_gamestate_change=yes
                    [filter_enemy]
                        [not]
                            side=6
                        [/not]
                    [/filter_enemy]
                [/facet]
            [/aspect]
        [/ai]
        user_team_name= _ "Wesnoth Occupation Force"
    [/side]
    #W humans
    [side]
        type=Lieutenant
        id=Yreddyn
        name= _ "Yreddyn"
        side=3
        {FLAG_VARIANT loyalist}
        controller=ai
        canrecruit=yes
        {GOLD 100 125 150}
        {INCOME 2 5 8}
        recruit=Spearman,Bowman,Longbowman
        team_name=evil
        [ai]
            #to keep him in front of the torture room gate
            passive_leader=yes
            grouping=no
#ifdef EASY
            simple_targeting=yes
#endif
            [aspect]
                id=attacks
                [facet]
                    invalidate_on_gamestate_change=yes
                    [filter_enemy]
                        [not]
                            side=6
                        [/not]
                    [/filter_enemy]
                [/facet]
            [/aspect]
        [/ai]
        color=blue
        user_team_name= _ "Wesnoth Occupation Force"
    [/side]
    #side of human guardians
    [side]
        side=4 #wmllint: ignore
        {FLAG_VARIANT loyalist}
        controller=ai
        team_name=evil
        gold=0
        income=-2
        recruit=
        no_leader=yes
        color=blue
        user_team_name= _ "Slave Guards"
        [ai]
            grouping=no
#ifdef EASY
            simple_targeting=yes
#endif
            [aspect]
                id=attacks
                [facet]
                    invalidate_on_gamestate_change=yes
                    [filter_enemy]
                        [not]
                            side=6
                        [/not]
                    [/filter_enemy]
                [/facet]
            [/aspect]
        [/ai]
    [/side]
    [side]
        type=Drake Priest
        id=Kamalar
        name= _ "Kamalar"
        side=5
        {FLAG_VARIANT drake}
        controller=ai
        canrecruit=yes
        gold=0 # Kamalar gets gold when you meet him; no need for it until then
        # Clashers would be worthless until the bridge is repaired, and Burners are too slow:
        recruit=Drake Glider,Drake Fighter,Cave Drake
        team_name=good2
        persistent=0
        shroud=yes
        fog=yes
        share_vision=all
        color=green
        [ai]
            passive_leader=yes
        [/ai]
        user_team_name= _ "Kamalar's Guard"
    [/side]
    #side of obedient slaves
    [side]
        side=6 #wmllint: ignore
        {FLAG_VARIANT drake}
        controller=ai
        team_name=good
        gold=0
        income=-2
        recruit=
        no_leader=yes
        color=purple
        [ai]
            ai_algorithm=idle_ai
        [/ai]
        user_team_name= _ "Drake Slaves"
    [/side]
    #side of rebelling slaves
    [side]
        side=7 #wmllint: ignore
        {FLAG_VARIANT drake}
        controller=ai
        team_name=good
        gold=0
        income=-2
        recruit=
        no_leader=yes
        color=purple
        shroud=yes
        fog=yes
        #so that the player can see their fighting
        share_vision=all
        [ai]
            [goal]
                [criteria]
                    side=4 # guards
                [/criteria]
                value=50
            [/goal]
            [aspect]
                id=attacks
                [facet]
                    invalidate_on_gamestate_change=yes
                    [filter_enemy]
                        [not]
                            side=6
                        [/not]
                    [/filter_enemy]
                [/facet]
                [facet]
                    invalidate_on_gamestate_change=yes
                    [filter_enemy]
                        [not]
                            side=9
                        [/not]
                    [/filter_enemy]
                [/facet]
            [/aspect]
        [/ai]
        user_team_name= _ "Drake Rebels"
    [/side]
    #side of monsters
    [side]
        side=8 #wmllint: ignore
        controller=ai
        team_name=evil2
        gold=0
        income=-2
        recruit=
        no_leader=yes
        color=orange
        [ai]
            aggression=1.0
            caution=0.0
            [aspect]
                id=attacks
                [facet]
                    invalidate_on_gamestate_change=yes
                    [filter_enemy]
                        [not]
                            side=6
                        [/not]
                    [/filter_enemy]
                [/facet]
                [facet]
                    invalidate_on_gamestate_change=yes
                    [filter_enemy]
                        [not]
                            side=9
                        [/not]
                    [/filter_enemy]
                [/facet]
            [/aspect]
        [/ai]
        user_team_name= _ "Monsters"
    [/side]
    [side]
        side=9
        controller=ai
        team_name=evil
        no_leader=yes
        color=white
        [ai]
            ai_algorithm=idle_ai
        [/ai]
        hidden=yes
    [/side]

    {OBJECTIVES_HEADER_BEGIN}
        {CONDITION_WIN ( _ "Liberate the mine")}
        {OBJECTIVES_LOSE}
        {GOLD_CARRYOVER_STANDARD}
    {OBJECTIVES_FOOTER_BEGIN}

    [item]
        image=scenery/trackNE.png
        x,y=2,31
        visible_in_fog=yes
    [/item]

    [item]
        x,y=8,13
        image=items/brazier-lit1.png
        visible_in_fog=yes
    [/item]

    #a hack to keep tracks from being displayed above gates
    [item]
        x,y=1,31
        image=scenery/gate-rusty-sw.png
        visible_in_fog=yes
    [/item]
    [item]
        x,y=2,31
        image=scenery/gate-rusty-sw.png
        visible_in_fog=yes
    [/item]

    [item]
        x,y=27,20
        image=items/bonestack.png
        visible_in_fog=yes
    [/item]

    [item]
        x,y=30,7
        image=items/grave-bones-treasure.png
    [/item]

    #torture chamber
    [item]
        x,y=15,27
        image=scenery/gallows.png
        visible_in_fog=yes
    [/item]
    [item]
        x,y=13,28
        image=items/cage.png
        visible_in_fog=yes
    [/item]
    [item]
        x,y=14,27
        image=items/cage.png
        visible_in_fog=yes
    [/item]
    [item]
        x,y=17,28
        image=items/potion-poison.png
        visible_in_fog=no
    [/item]
    [item]
        x,y=16,27
        image=items/axe.png
        visible_in_fog=no
    [/item]

    {DELIVERY_ITEM 47 11 keyx keyy (items/chest-plain-closed.png) (misc/key-overlay.png) keyguy}
    {DELIVERY_ITEM 14 31 bridgex bridgey (items/wood-pickup.png) (items/wood-pickup.png) bridgeguy}

    [event]
        name=prestart
        {VARIABLE trapdoor_open no}
        {VARIABLE bridge_built no}
        {VARIABLE garrison_notified no}
        [unit]
            x,y=18,29
            type=Spearman
            id="Torture Chamber Guard"
            side=4
            ai_special=guardian
            random_traits=yes
            generate_name=yes
        [/unit]
        [if]
            [variable]
                name=gave_up_kogw
                boolean_equals=no
            [/variable]
            [then]
                [recall]
                    id=Kogw
                [/recall]
            [/then]
            [else]
                [recall]
                    id=Theracar
                [/recall]
            [/else]
        [/if]
        {VARIABLE humans_asleep yes}
        {VARIABLE kamalar_introduced no}
        {VARIABLE slaves_seen no}
        {VARIABLE slave_message no}
        {VARIABLE keyguy null}
        {VARIABLE bridgeguy null}
        {SPIDERWEB 46 7}
        {SPIDERWEB 46 8}
        {SPIDERWEB 47 8}
        {SPIDERWEB 47 9}
        {SCATTER_IMAGE (
            terrain=Uu
            x=27-50
            y=1-20
        ) 4 scenery/rubble.png}
        [unit]
            x,y=2,22
            type=Cave Drake
            side=1
            generate_name=yes
            random_traits=no
            #I don't want it getting quick
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]
        {CAPTURE_VILLAGES 5 22 11 4} # Kamalar's side
        [set_menu_item]
            id=control_slaves
            description= _ "Manual control"
            [show_if]
                [variable]
                    name=side_number
                    numerical_equals=5
                [/variable]
                [and]
                    [have_unit]
                        side=7
                        x,y=$x1,$y1
                    [/have_unit]
                [/and]
            [/show_if]
            [command]
                [store_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    variable=tempstore
                [/store_unit]
                {VARIABLE tempstore.side 5}
                [unstore_unit]
                    variable=tempstore
                [/unstore_unit]
                {CLEAR_VARIABLE tempstore}
            [/command]
        [/set_menu_item]
        #wmllint: recognize Quemar
        [if]
            [have_unit]
                id=Quemar
                search_recall_list=yes
            [/have_unit]
            [then]
                {VARIABLE have_quemar yes}
                [store_unit]
                    [filter]
                        id=Quemar
                    [/filter]
                    variable=quemar_store
                    kill=yes
                [/store_unit]
            [/then]
        [/if]
    [/event]

    [event]
        name=slave_message_check
        first_time_only=no
        [if]
            [variable]
                name=slaves_seen
                boolean_equals=yes
            [/variable]
            [variable]
                name=kamalar_introduced
                boolean_equals=yes
            [/variable]
            [variable]
                name=slave_message
                boolean_equals=no
            [/variable]
            [then]
                [message]
                    speaker=narrator
                    {NARRATOR_ICON}
                    message= _"<span color='green'>Kamalar can take command of rebelling mine slaves during his turn. To do so, right-click on the slave and select “Manual control”.</span>"
                [/message]
                {VARIABLE slave_message yes}
            [/then]
        [/if]
    [/event]

    #WARNING: Be very careful about the distances between the slaves to keep them
    #from revealing each other!
#define RESCUABLE_UNIT X Y TYPE
    [event]
        name=prestart
        [unit]
            x,y={X},{Y}
            side=6
            type={TYPE}
            random_traits=yes
            generate_name=yes
        [/unit]
    [/event]

    [event]
        name=sighted
        [filter]
            x,y={X},{Y}
        [/filter]
        [filter_second]
            side=1,5,7
        [/filter_second]
        [set_variable]
            name=facing
            rand=se,sw
        [/set_variable]
        {VARIABLE unit.side 7}
        {VARIABLE_OP unit.facing to_variable facing}
        {CLEAR_VARIABLE facing}
        [unstore_unit]
            variable=unit
        [/unstore_unit]
        [redraw]
        [/redraw]
    [/event]
#enddef

    {RESCUABLE_UNIT 37 18 (Drake Slave)}
    {RESCUABLE_UNIT 33 10 (Drake Slave)}
    {RESCUABLE_UNIT 44 11 (Drake Slave)}
    {RESCUABLE_UNIT 49 8 (Drake Slave)}
    {RESCUABLE_UNIT 30 3 (Drake Slave)}
    {RESCUABLE_UNIT 41 14 (Drake Slave)}
    {RESCUABLE_UNIT 43 6 (Drake Worker)}
    {RESCUABLE_UNIT 49 4 (Drake Worker)}
#ifdef HARD
    {RESCUABLE_UNIT 38 5 (Drake Slave)}
#else
    {RESCUABLE_UNIT 38 5 (Drake Worker)}
#endif

    [event]
        name=prestart
        [unit]
            x,y=34,16
            side=6
            type=Drake Worker
            random_traits=yes
            generate_name=yes
        [/unit]
    [/event]

    [event]
        name=sighted
        [filter]
            x,y=34,16
        [/filter]
        [filter_second]
            side=1,5,7
        [/filter_second]
        [set_variable]
            name=facing
            rand=se,sw
        [/set_variable]
        {VARIABLE unit.side 7}
        {VARIABLE_OP unit.facing to_variable facing}
        {CLEAR_VARIABLE facing}
        [unstore_unit]
            variable=unit
        [/unstore_unit]
        [redraw]
        [/redraw]
        # I don't care what the original author says; this is too generic of a message to be a reference to anything:
        [message]
            speaker=unit
            message= _ "We're free! The oppressors must die!"
        [/message]
        {VARIABLE slaves_seen yes}
        [fire_event]
            name=slave_message_check
        [/fire_event]
    [/event]

    #monster is not actually created until its hex is revealed
#define DISCOVERABLE_MONSTER_CUSTOM X Y TYPE CUSTOM_ACTION
    [event]
        name=prestart
        [unit]
            type=Invisible
            x,y={X},{Y}
            side=9
        [/unit]
    [/event]

    [event]
        name=sighted
        [filter]
            x,y={X},{Y}
        [/filter]
        [filter_second]
            side=1,5,7
        [/filter_second]
        [kill]
            x,y={X},{Y}
        [/kill]
        [set_variable]
            name=facing
            rand=se,sw
        [/set_variable]
        [unit]
            x,y={X},{Y}
            side=8
            type={TYPE}
            facing=$facing
            ellipse=none
        [/unit]
        {CLEAR_VARIABLE facing}
        [redraw]
        [/redraw]
        [scroll_to_unit]
            x,y={X},{Y}
        [/scroll_to_unit]
        {CUSTOM_ACTION}
    [/event]
#enddef

#define DISCOVERABLE_MONSTER X Y TYPE
    {DISCOVERABLE_MONSTER_CUSTOM ({X}) ({Y}) ({TYPE}) ()}
#enddef

    {DISCOVERABLE_MONSTER_CUSTOM 35 12 (Lesser Giant Spider) (
        {MESSAGE_ON_SECOND_UNIT ( _ "This mine is infested with monsters!")}
    )}
    {DISCOVERABLE_MONSTER 38 8 (Cave Ant)}
    {DISCOVERABLE_MONSTER 38 7 (Cave Ant)}
    {DISCOVERABLE_MONSTER 38 13 (Blood Bat)}
    {DISCOVERABLE_MONSTER 46 8 (Giant Spider)}

#define DISCOVERABLE_GUARDIAN X Y TYPE
    [event]
        name=prestart
        [unit]
            type=Invisible
            x,y={X},{Y}
            side=9
        [/unit]
    [/event]

    [event]
        name=sighted
        [filter]
            x,y={X},{Y}
        [/filter]
        [filter_second]
            side=1,5,7
        [/filter_second]
        [kill]
            x,y={X},{Y}
        [/kill]
        [set_variable]
            name=facing
            rand=se,sw
        [/set_variable]
        [unit]
            x,y={X},{Y}
            side=4
            type={TYPE}
            facing=$facing
        [/unit]
        {CLEAR_VARIABLE facing}
        [redraw]
        [/redraw]
        [scroll_to_unit]
            x,y={X},{Y}
        [/scroll_to_unit]
    [/event]
#enddef

    {DISCOVERABLE_GUARDIAN 40 8 (Spearman)}
    {DISCOVERABLE_GUARDIAN 46 5 (Taskmaster)}
    {DISCOVERABLE_GUARDIAN 33 9 (Taskmaster)}
    {DISCOVERABLE_GUARDIAN 31 15 (Swordsman)}
    {DISCOVERABLE_GUARDIAN 34 21 (Swordsman)}
    {DISCOVERABLE_GUARDIAN 27 31 (Spearman)}

    [event]
        name=start
        [message]
            speaker=narrator
            {NARRATOR_ICON}
            message= _ "The drakes split into three forces. Malakar led the smallest, a hand-picked team tasked with liberating the former Drakkar Quarry, now known as Bosun's Mine."
            # wmllint: no-icon
        [/message]
        [if]
            [variable]
                name=gave_up_kogw
                boolean_equals=no
            [/variable]
            [then]
                [message]
                    speaker=Kogw
                    message= _ "Couldn't we have led the scouting? I mean, do you really want us in more caves, Mal? Don't you remember the last ones?"
                [/message]
                [message]
                    speaker=Malakar
                    message= _ "I do remember them. Of all the drakes, we are the most experienced fighting below ground. An inexperienced fighter tripping over his own wings in the dark might be enough to destroy us all."
                [/message]
                [if]
                    [variable]
                        name=have_quemar
                        boolean_equals=yes
                    [/variable]
                    [then]
                        [message]
                            speaker=Kogw
                            message= _ "Not to be insensitive, but couldn't we have still used a few of the wing-tripping ones? Come to think of it, it's a pity your dragon friend couldn't fit down here. There's not many of us left, Mal."
                        [/message]
                    [/then]
                    [else]
                        [message]
                            speaker=Kogw
                            message= _ "Not to be insensitive, but couldn't we have still used a few of the wing-tripping ones? There's not many of us left, Mal."
                        [/message]
                    [/else]
                [/if]
                [message]
                    speaker=Malakar
                    message= _ "Indeed, we have lost a great many. So many that we cannot hope to retake this island by ourselves. Here, we can liberate others, to join our cause."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Theracar
                    image=$theracar_image
                    message= _ "Chief, I must again inquire: why must we be the drakes to delve into these caves? We were fortunate to have avoided the caves of the Isle of Storms."
                [/message]
                [message]
                    speaker=Malakar
                    message= _ "We have lost a great many drakes. So many that we cannot hope to retake this island by ourselves. The humans have enslaved drakes of every tribe, many forced to toil in mines such as these. They but require the direction of a Chief to rise up against the thinskins and help us drive them away for good!"
                [/message]
                [if]
                    [variable]
                        name=have_quemar
                        boolean_equals=yes
                    [/variable]
                    [then]
                        [message]
                            speaker=Theracar
                            image=$theracar_image
                            message= _ "I am only concerned as a strategist that we are needlessly endangering ourselves, especially since Quemar cannot fit down here. Should we fall our uprising falls with us."
                        [/message]
                    [/then]
                    [else]
                        [message]
                            speaker=Theracar
                            image=$theracar_image
                            message= _ "I am only concerned as a strategist that we are needlessly endangering ourselves. Should we fall our uprising falls with us."
                        [/message]
                    [/else]
                [/if]
                [message]
                    speaker=Malakar
                    message= _ "Then we cannot afford to fall. I have decided. Drakes, move out!"
                [/message]
            [/else]
        [/if]
        [message]
            speaker=narrator
            {NARRATOR_ICON}
            message= _ "NOTE: Your encampment will disappear on turn 2, and your recall list will cease to be available for this scenario."
            # hey wmllint stop putting image=wesnoth-icon.png here; we already use {NARRATOR_ICON} above
            # wmllint: no-icon
        [/message]
    [/event]

    [event]
        name=turn 2
        [terrain]
            x=1-2  ,3 ,4
            y=23-24,24,23-24
            terrain=Re
        [/terrain]
        #a hack to keep the northwest humans from moving after turn 2
        [petrify]
            side=2
        [/petrify]
        [store_unit]
            [filter]
                side=1
                x,y=recall,recall
            [/filter]
            variable=recall_list
            kill=yes
        [/store_unit]
        [store_side]
            side=1
            variable=side1vars
        [/store_side]
        {VARIABLE recruit_list $side1vars.recruit}
        {CLEAR_VARIABLE side1vars}
        [set_recruit]
            side=1
            recruit=
        [/set_recruit]
    [/event]

    [event]
        {HEX_SIGHTED_EVENT 10 21 1}
        [scroll_to]
            x,y=10,21
        [/scroll_to]
        [delay]
            time=500
        [/delay]
        {MESSAGE_ON_FIRST_UNIT ( _ "The invaders must have dug this tunnel very hastily; it falls apart already.")}
        [message]
            speaker=Malakar
            message= _ "It seems that the humans have expanded this mine. They even pillage the very foundations of Morogor itself."
        [/message]
    [/event]

    [event]
        {HEX_SIGHTED_EVENT 16 17 1}
        [scroll_to]
            x,y=15,18
        [/scroll_to]
        [delay]
            time=500
        [/delay]
        {MESSAGE_ON_FIRST_UNIT ( _ "This bridge is shattered.")}
    [/event]

    [event]
        {HEX_SIGHTED_EVENT_TWOSIDES 10 15 1 5}
        [scroll_to]
            x,y=10,15
        [/scroll_to]
        [delay]
            time=500
        [/delay]
        {MESSAGE_ON_FIRST_UNIT ( _ "There is a gate here. Although it may be unwise to open it, I can look through it if I get closer.")}
    [/event]

    [event]
        {HEX_SIGHTED_EVENT_TWOSIDES 27 20 1 5}
        [scroll_to]
            x,y=27,20
        [/scroll_to]
        [delay]
            time=500
        [/delay]
        [if]
            [variable]
                name=unit.race
                equals="drake"
            [/variable]
            [then]
                {MESSAGE_ON_FIRST_UNIT ( _ "The thinskins defile even our dead. This is no place for bones!")}
            [/then]
            [else]
                [message]
                    speaker=Malakar
                    message= _ "The thinskins defile even our dead. This is no place for bones!"
                [/message]
            [/else]
        [/if]
        [if]
            [variable]
                name=gave_up_kogw
                boolean_equals=no
            [/variable]
            [then]
                [message]
                    speaker=Kogw
                    message= _ "Bones? I thought you guys, you know, went up in smoke."
                [/message]
                [message]
                    speaker=Malakar
                    message= _ "Only those who die in battle. These drakes have been starved, or worked to death. As well to spit on our ashes as to keep bones on display."
                [/message]
            [/then]
        [/if]
    [/event]

    [event]
        {HEX_SIGHTED_EVENT_TWOSIDES 23 32 1 5}
        [scroll_to]
            x,y=23,32
        [/scroll_to]
        {MESSAGE_ON_FIRST_UNIT ( _ "These appear to be living quarters for the slaves. They must all be at work now.")}
    [/event]

    [event]
        name=sighted
        [filter]
            side=3
        [/filter]
        [filter_second]
            side=1,5
        [/filter_second]
        [scroll_to_unit]
            id=unit
        [/scroll_to_unit]
        {MESSAGE_ON_SECOND_UNIT ( _ "There is a human garrison in the lower tunnels!")}
    [/event]

    [event]
        name=introduce_kamalar
        [modify_side]
            side=5
            team_name=good
            user_team_name= _ "Kamalar's Guard"
        [/modify_side]
        [redraw]
            side=1
        [/redraw]
        [message]
            speaker=Kamalar
            message= _ "Hello, my brothers."
        [/message]
        [message]
            speaker=Malakar
            message= _ "Kamalar, is it you?"
        [/message]
        [if]
            [variable]
                name=gave_up_kogw
                boolean_equals=no
            [/variable]
            [then]
                [message]
                    speaker=Kogw
                    message= _ "Who's this, now?"
                [/message]
                [message]
                    speaker=Kamalar
                    # wmllint: local spelling Dalgar-El
                    message= _ "I am the high priest of Dalgar-El, the Murderer. I led a small band of warriors into this mine, but we were outnumbered and forced into this cavern. We are safe here, beyond the chasm, and there are sufficient mushrooms here to live on, but the humans have been repairing the bridge we broke, and it seems to come closer with each hour."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Theracar
                    image=$theracar_image
                    # wmllint: local spelling Dalgar-El
                    message= _ "Hail, Kamalar, high-priest of Dalgar-El the Murderer!"
                [/message]
                [message]
                    speaker=Kamalar
                    message= _ "I am heartened to learn that the Kakatars yet live. I led a small band of warriors into this mine, but we were outnumbered and forced into this cavern. We are safe here, beyond the chasm, and there are sufficient mushrooms here to live on, but the humans have been repairing the bridge we broke, and it seems to come closer with each hour."
                [/message]
            [/else]
        [/if]
        [message]
            speaker=Malakar
            message= _ "I request your assistance, brother, in driving the humans from our island."
        [/message]
        [message]
            speaker=Kamalar
            message= _ "Very well. We too have borne their yoke, and your arrival brings hope. Malakar, if you can kill my besiegers, the slaves can revolt and my force can aid them."
        [/message]
        [terrain]
            x,y=22,11
            terrain=Ke
        [/terrain]
        [terrain]
            x,y=21,11
            terrain=Ce
        [/terrain]
        [terrain]
            x,y=22,12
            terrain=Ce
        [/terrain]
        [modify_side]
            side=5
            controller=human
            income={ON_DIFFICULTY 2 1 0}
            user_team_name= _ "Kamalar's Guard"
        [/modify_side]
        [gold]
            side=5 # Kamalar's side
            amount={ON_DIFFICULTY 70 60 50}
        [/gold]
    [/event]

    [event]
        name=kamalar_objectives_update
        [message]
            speaker=narrator
            {NARRATOR_ICON}
            message= _ "You now control Kamalar's team as well as your own."
            # wmllint: no-icon
        [/message]
        [objectives]
            side=1
            {CONDITION_WIN ( _ "Defeat all human leaders")}
            {CONDITION_LOSE ( _ "Death of Malakar")}
            [objective]
                description= _ "Death of Kogw"
                condition=lose
                [show_if]
                    [variable]
                        name=kogw_alive
                        equals="essential"
                    [/variable]
                [/show_if]
            [/objective]
            [objective]
                description= _ "Death of Theracar"
                condition=lose
                [show_if]
                    [variable]
                        name=theracar_alive
                        equals="essential"
                    [/variable]
                [/show_if]
            [/objective]
            {CONDITION_LOSE ( _ "Death of Kamalar")}
            {TURNS_RUN_OUT}
        [/objectives]
        [objectives]
            side=5
            {CONDITION_WIN ( _ "Defeat all human leaders")}
            {CONDITION_LOSE ( _ "Death of Malakar")}
            [objective]
                description= _ "Death of Kogw"
                condition=lose
                [show_if]
                    [variable]
                        name=kogw_alive
                        equals="essential"
                    [/variable]
                [/show_if]
            [/objective]
            [objective]
                description= _ "Death of Theracar"
                condition=lose
                [show_if]
                    [variable]
                        name=theracar_alive
                        equals="essential"
                    [/variable]
                [/show_if]
            [/objective]
            {CONDITION_LOSE ( _ "Death of Kamalar")}
            {TURNS_RUN_OUT}
        [/objectives]
    [/event]

    [event]
        name=sighted
        [filter]
            id=Kamalar
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [if]
            [variable]
                name=kamalar_introduced
                boolean_equals=no
            [/variable]
            [then]
                {VARIABLE kamalar_introduced yes}
                [fire_event]
                    name=introduce_kamalar
                [/fire_event]
                [fire_event]
                    name=kamalar_objectives_update
                [/fire_event]
                [fire_event]
                    name=slave_message_check
                [/fire_event]
            [/then]
        [/if]
    [/event]

    [event]
        name=turn 20
        [if]
            [variable]
                name=kamalar_introduced
                boolean_equals=no
            [/variable]
            [then]
                {VARIABLE kamalar_introduced yes}
                [fire_event]
                    name=introduce_kamalar
                [/fire_event]
                [fire_event]
                    name=kamalar_objectives_update
                [/fire_event]
                [fire_event]
                    name=slave_message_check
                [/fire_event]
            [/then]
        [/if]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1,5
            x,y=30,7
        [/filter]
        [sound]
            name=gold.ogg
        [/sound]
        {MESSAGE_ON_FIRST_UNIT ( _ "This... uh... skeleton had 180 pieces of gold!")}
        [if]
            [variable]
                name=unit.side
                numerical_equals=5
            [/variable]
            [then]
                [message]
                    speaker=Kamalar
                    message= _ "Malakar, you need this gold more than I do. You are a chieftain, and I am a priest."
                [/message]
            [/then]
        [/if]
        [gold]
            side=1
            amount=180
        [/gold]
        [remove_item]
            x,y=30,7
            image=items/grave-bones-treasure.png
        [/remove_item]
    [/event]

    [event]
        name=die
        [filter]
            id=Yreddyn
            side=3
        [/filter]
        {MESSAGE_ON_SECOND_UNIT ( _ "He was guarding a gate!")}
        [terrain]
            x,y=20,29
            terrain=Uu
        [/terrain]
        [redraw]
            clear_shroud=yes
        [/redraw]
    [/event]

    [event]
        name=die
        [filter]
            id=Torture Chamber Guard
            side=4
        [/filter]
        {MESSAGE_ON_SECOND_UNIT ( _ "He dropped a book!")}
        [item]
            x,y=$unit.x,$unit.y
            image=items/book2.png
        [/item]
        {VARIABLE bookx $unit.x}
        {VARIABLE booky $unit.y}
        [event]
            name=moveto
            delayed_variable_substitution=yes
            [filter]
                x=$bookx
                y=$booky
                side=1,5
            [/filter]
            [if]
                [variable]
                    name=unit.id
                    equals=Malakar
                [/variable]
                [then]
                    {MESSAGE_ON_FIRST_UNIT ( _ "It is a collection of orders and messages. They all appear to have been written by the same hand.")}
                [/then]
                [else]
                    {MESSAGE_ON_FIRST_UNIT ( _ "It's a collection of orders and messages. They look like they've been written by the same hand.")}
                [/else]
            [/if]
            [remove_item]
                x=$bookx
                y=$booky
                image=items/book2.png
            [/remove_item]
            {CLEAR_VARIABLE bookx}
            {CLEAR_VARIABLE booky}
            [message]
                speaker=narrator
                message= _ "First, gentlemen, I would like to congratulate you on your ingenuity in sparing our citizens. If Prax did not pay for drakes, he no doubt would not have paid what he promised for humans, either. In light of his breach of contract, I am transferring an additional squad of archers to your control. Your orders are to kill Prax and bring back any gold he possesses. Be wary of his magics, but let nothing stop you."
                image=portraits/wt_books.png
            [/message]
            [message]
                speaker=narrator
                message= _ "General Omandro, I received your message that little remained of value in the Baron's estate. We were lucky that the drakes finished him off, but we will be ruined without immediate funds in the royal coffers. Your orders are to find the drakes and see if they took anything of value in their escape. Avoid engaging them unless they cause trouble."
                image=portraits/wt_books.png
            [/message]
            [if]
                [variable]
                    name=last_b_scenario
                    greater_than=2
                [/variable]
                [then]
                    [message]
                        speaker=narrator
                        message= _ "Your Highness, reports from the field indicate that our dealings with Prax were a dead end. He does not have, and perhaps never had, enough gold to save the kingdom. It pleases me to report that he is now dead and his lands placed under our control. Our only financial hope is our new colony in Morogor. We have our hands on a fortune's worth of their unique stone, yet the first shipments are still months away. We were only able to take Morogor because the natives were divided against each other. We cannot risk Prax's escaped slaves rallying our new Drakish subjects."
                        image=portraits/wt_books.png
                    [/message]
                [/then]
                [else]
                    [message]
                        speaker=narrator
                        # wmllint: local spelling Oddryn
                        message= _ "Your Highness, reports from the field indicate that our dealings with Prax were a dead end. He does not have, and perhaps never had, enough gold to save the kingdom. It pleases me to report that he is now dead and his lands placed under our control. Although things look bad, I propose a bold new plan: Grand Marshal Oddryn revealed that it is possible to assault Morogor when the local drakes are taken by surprise. If we claim the island for our own, then we put our hands on a fortune's worth of their unique stone. Wizards and mages from across the land have always paid dearly for even pebbles from Morogor. If we move quickly, the only real obstacle in our way is the danger of Prax's escaped slaves returning home and raising a warning. We could never take Morogor after their defenses have been raised."
                        image=portraits/wt_books.png
                    [/message]
                [/else]
            [/if]
            [message]
                speaker=narrator
                message= _ "Attention - Omandro and all coastal forces. Your new top priority is to find the escaped Drakish slaves and destroy them. They must not return to Morogor. Pursue over the ocean, if need be. Further instruction will be coming."
                image=portraits/wt_books.png
            [/message]
            #reference to Northern Alliance removed - the Northern Alliance wasn't founded until 535 YW, and this
            #campaign is set c. 300 YW during the Golden Age of Wesnoth. At this time, with Wesnoth politically
            #stable and militarily secure, 1) less risk of lore conflicts with others' campaigns, 2) Wesnoth would
            #plausibly be able to spare a quarter of its army to chase down drakes and 3) Wesnoth likely needs
            #capital for the "great public works" referenced in the wiki timeline.
            [message]
                speaker=narrator
                message= _ "This message is merely an expression of the King's gratitude for your efforts. The kingdom, so long poised on the brink of fiscal collapse, is saved. A few more months' worth of shipments, and we'll not only be financially secure for generations, but we will have the resources to conquer the Northlands and claim the bulk of the continent for ourselves. You have done well, and the King himself thanks you all."
                image=portraits/wt_books.png
            [/message]
        [/event]
    [/event]

    [event]
        {HEX_SIGHTED_EVENT_TWOSIDES 14 27 1 5}
        [scroll_to]
            x,y=14,27
        [/scroll_to]
        [delay]
            time=500
        [/delay]
        [if]
            [variable]
                name=unit.race
                equals="drake"
            [/variable]
            [then]
                {MESSAGE_ON_FIRST_UNIT ( _ "By Gar-Alagar... this is a torture chamber! The humans shall pay tenfold for this!")}
            [/then]
            [else]
                [message]
                    speaker=Malakar
                    message= _ "By Gar-Alagar... this is a torture chamber! The humans shall pay tenfold for this!"
                [/message]
            [/else]
        [/if]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1,5
            x,y=16,27
        [/filter]
        {MESSAGE_ON_FIRST_UNIT ( _ "An axe... used to dismember drakes. How could anyone do this?")}
    [/event]

    [event]
        name=moveto
        [filter]
            side=1,5
            x,y=17,28
        [/filter]
        {MESSAGE_ON_FIRST_UNIT ( _ "This is some type of wicked poison, forced down captives' throats.")}
    [/event]

    [event]
        name=moveto
        [filter]
            side=1,5
            x,y=15,27
        [/filter]
        {MESSAGE_ON_FIRST_UNIT ( _ "Gallows, to kill drakes after their ordeals.")}
        [if]
            [have_unit]
                x,y=$x1,$y1
                race=drake
            [/have_unit]
            [then]
                [sound]
                    name=flame-big.ogg
                [/sound]
                {FIREBALL_IMPACT 15 27}
                [remove_item]
                    x,y=15,27
                    image=scenery/gallows.png
                [/remove_item]
            [/then]
        [/if]
    [/event]

    {SPIDERWEB_SLOWING (46,47) (7-8,8-9) (1,5)}

    {FREEDOM_DEATHS}

    [event]
        name=last breath
        [filter]
            id=Kamalar
        [/filter]
        [message]
            speaker=Malakar
            message= _ "Brother!"
        [/message]
        [message]
            speaker=Kamalar
            message= _ "I am gone!"
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            id=Kamalar
        [/filter]
        [message]
            speaker=Malakar
            message= _ "Without him, we will be unable to continue. All is lost!"
        [/message]
        [endlevel]
            result=defeat
            music=defeat.ogg,defeat2.ogg
        [/endlevel]
    [/event]

    [event]
        name=enemies defeated
        {CLEAR_FOG $side_number 22 12 3}
        {CLEAR_SHROUD $side_number 22 12 3}
        #just in case the player 1) finished in less than 20 turns and 2) never discovered Kamalar. Not currently possible since he's still an enemy until he's found, therefore enemies_defeated wouldn't fire until then.
        [if]
            [variable]
                name=kamalar_introduced
                boolean_equals=no
            [/variable]
            [then]
                {VARIABLE kamalar_introduced yes}
                [fire_event]
                    name=introduce_kamalar
                [/fire_event]
                [message]
                    speaker=Malakar
                    message= _ "We have done so. Quickly, we must leave for the Temple at once, before the humans learn of their defeat today!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Malakar
                    message= _ "We continue!"
                [/message]
            [/else]
        [/if]
        [message]
            speaker=Kamalar
            message= _ "Don't be so hasty, brother. I bring friends."
        [/message]
        [message]
            speaker=Kamalar
            message= _ "Kzzklk, show yourself!"
        [/message]
        #wmllint: recognize Kzzklk
        [unit]
            side=5
            x,y=21,12
            type=Saurian Margrave
            name= _ "Kzzklk"
            id=Kzzklk
            profile=portraits/kzzklk.png
            [modifications]
                {TRAIT_LOYAL_HERO}
            [/modifications]
        [/unit]
        [sound]
            name=hiss-big.wav
        [/sound]
        [unit]
            side=5
            x,y=21,13
            type=Saurian Skirmisher
        [/unit]
        [unit]
            side=5
            x,y=21,13
            type=Saurian Headhunter
        [/unit]
        [scroll_to_unit]
            x,y=21,12
        [/scroll_to_unit]
        [delay]
            time=350
        [/delay]
        [message]
            speaker=Malakar
            message= _ "Saurians? In a cave?"
        [/message]
        [message]
            speaker=Kamalar
            message= _ "I found a small group of them. Refugees from the humans, just like us. They have allied with me against our enslavers."
        [/message]
        [message]
            speaker=Kamalar
            message= _ "However, once the humans came to Morogor, we had to take refuge here. With their help, I was able to avoid their patrols, and I sustained them with my flame."
        [/message]
        [message]
            speaker=Kamalar
            message= _ "Now, with your arrival, we can emerge from these caverns, and they can thaw in the open sun. Kzzklk, will you assist us once again, in the liberation of our capital?"
        [/message]
        [message]
            speaker=Kzzklk
            message= _ "Yesss! My axxxxe iss reaaaddy!" #wmllint: no spellcheck
        [/message]
        [message]
            speaker=Malakar
            message= _ "How should the saurians be fielded in battle?"
        [/message]
        [message]
            speaker=Kamalar
            message= _ "The saurians are elusive and deft of foot, but weak at arms. I propose that while we attack the humans head-on, the saurians sneak behind the enemy lines and kill their leaders."
        [/message]
        [message]
            speaker=Kamalar
            message= _ "Or, I can place the saurians under your command, to add to your army."
        [/message]
        [message]
            speaker=Malakar
            message= _ "How many do you have?"
        [/message]
        [message]
            speaker=Kamalar
            message= _ "That will be ready for battle? I have around ten. Fifteen at most."
        [/message]
        [delay]
            time=500
            accelerate=yes
        [/delay]
        [message]
            speaker=Malakar
            message= _ "Then there will be a tough fight ahead of us. I must decide what I will do with the saurians."
            [option]
                label= _ "I will take command of the saurians."
                [command]
                    [message]
                        speaker=Kamalar
                        message= _ "Use them well."
                    [/message]
                    [set_variable]
                        name=saurian_state
                        value=1
                    [/set_variable]
                [/command]
            [/option]
            [option]
                label= _ "The saurians will try to outflank the humans."
                [command]
                    [message]
                        speaker=Kamalar
                        message= _ "Very well. They will arrive at the third dawn."
                    [/message]
                    [set_variable]
                        name=saurian_state
                        value=2
                    [/set_variable]
                [/command]
            [/option]
        [/message]
        [if]
            [variable]
                name=saurian_state
                numerical_equals=1
            [/variable]
            [then]
                [allow_recruit]
                    side=1
                    type=Saurian Skirmisher
                [/allow_recruit]
                [allow_recruit]
                    side=1
                    type=Saurian Augur
                [/allow_recruit]
                [allow_recruit]
                    side=1
                    type=Saurian Headhunter
                [/allow_recruit]
                [allow_recruit]
                    side=1
                    type=Saurian Skald
                [/allow_recruit]
                [allow_recruit]
                    side=1
                    type=Saurian Assassin
                [/allow_recruit]
                [store_unit]
                    [filter]
                        id=Kzzklk
                    [/filter]
                    variable=kzzklk_store
                [/store_unit]
                {VARIABLE kzzklk_store.side 1}
                [unstore_unit]
                    variable=kzzklk_store
                [/unstore_unit]
                {CLEAR_VARIABLE kzzklk_store}
            [/then]
            [else]
                [kill]
                    type=Saurian Margrave
                    fire_event=no
                    animate=no
                [/kill]
            [/else]
        [/if]
        [kill]
            type=Saurian Skirmisher
            fire_event=no
            animate=no
        [/kill]
        [kill]
            type=Saurian Headhunter
            fire_event=no
            animate=no
        [/kill]
        [endlevel]
            result=victory
            bonus=yes
            carryover_percentage={ON_DIFFICULTY 80 70 60}
        [/endlevel]
    [/event]

    [event]
        name=victory
        [heal_unit]
            [filter]
                side=5
            [/filter]
            amount=full
            restore_statuses=yes
            animate=no
        [/heal_unit]
        [store_unit]
            [filter]
                id=Kamalar
            [/filter]
            variable=kamalar_store
            kill=yes
        [/store_unit]
        {VARIABLE kamalar_store.canrecruit yes}
        {VARIABLE kamalar_store.side 2}
        {VARIABLE kamalar_store.x 24}
        {VARIABLE kamalar_store.y 41}
        {VARIABLE kamalar_has_recall_list no}
        [if]
            [have_unit]
                side=5
                [not]
                    type=Cave Drake
                [/not]
            [/have_unit]
            [then]
                {VARIABLE kamalar_has_recall_list yes}
                [store_unit]
                    [filter]
                        side=5
                        [not]
                            type=Cave Drake
                        [/not]
                    [/filter]
                    variable=kamalar_recall
                [/store_unit]
                [foreach]
                    array=kamalar_recall
                    variable=this_item
                    readonly=no
                    [do]
                        {VARIABLE this_item.x recall}
                        {VARIABLE this_item.y recall}
                    [/do]
                [/foreach]
            [/then]
        [/if]
        [if]
            [variable]
                name=bridge_built
                boolean_equals=no
            [/variable]
            [variable]
                name=bridgeguy
                not_equals=null
            [/variable]
            [then]
                [remove_unit_overlay]
                    id=$bridgeguy
                    image=items/wood-pickup.png
                [/remove_unit_overlay]
            [/then]
        [/if]
        {UNCLEAR_FOG}
        {CLEAR_VARIABLE bridge_built}
        {CLEAR_VARIABLE trapdoor_open}
        {CLEAR_VARIABLE humans_asleep}
        {CLEAR_VARIABLE bridgex}
        {CLEAR_VARIABLE bridgey}
        {CLEAR_VARIABLE bridgeguy}
        {CLEAR_VARIABLE keyguy}
        {CLEAR_VARIABLE key_found}
        {CLEAR_VARIABLE keyx}
        {CLEAR_VARIABLE keyy}
        #in case the player didn't pick it up
        {CLEAR_VARIABLE bookx}
        {CLEAR_VARIABLE booky}
        {CLEAR_VARIABLE garrison_notified}
        [clear_menu_item]
            id=control_slaves
        [/clear_menu_item]
        {UNSTORE_ALL_UNITS recall_list}
        {CLEAR_VARIABLE recall_list}
        #not set_recruit - we don't want to override the new saurian recruits if the player chose them
        [allow_recruit]
            side=1
            type=$recruit_list
        [/allow_recruit]
        {CLEAR_VARIABLE recruit_list}
        {CLEAR_VARIABLE kamalar_introduced}
        {CLEAR_VARIABLE slaves_seen}
        {CLEAR_VARIABLE slave_message}
        [if]
            [variable]
                name=have_quemar
                boolean_equals=yes
            [/variable]
            [then]
                [unstore_unit]
                    variable=quemar_store
                [/unstore_unit]
                {CLEAR_VARIABLE quemar_store}
            [/then]
        [/if]
        {CLEAR_VARIABLE have_quemar}
    [/event]

    [event]
        name=time over
        [terrain]
            x=1
            y=31
            terrain=Uu^Pr\o
        [/terrain]
        [terrain]
            x=2
            y=31
            terrain=Uu^Pr\o
        [/terrain]
        [unit]
            x,y=3,30
            type=Grand Knight
            side=4
            random_traits=yes
            generate_name=yes
        [/unit]
        [unit]
            x,y=2,30
            type=Iron Mauler
            side=4
            random_traits=yes
            generate_name=yes
        [/unit]
        [unit]
            x,y=3,31
            type=Royal Guard
            side=4
            random_traits=yes
            generate_name=yes
        [/unit]
        [unit]
            x,y=1,31
            type=Royal Guard
            side=4
            random_traits=yes
            generate_name=yes
        [/unit]
        [unit]
            x,y=2,31
            type=Master Bowman
            side=4
            random_traits=yes
            generate_name=yes
        [/unit]
        {CLEAR_FOG 1 4 30 3}
        {CLEAR_SHROUD 1 4 30 3}
        [redraw]
        [/redraw]
        [scroll_to]
            x,y=3,30
        [/scroll_to]
        [message]
            x,y=3,30
            message= _ "Slaves! By order of Grand Marshal Yrynyc, you are to be executed for your treason, to the last drake!"
        [/message]
        [endlevel]
            result=defeat
            music=defeat.ogg,defeat2.ogg
        [/endlevel]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=29,20
            side=1,5
        [/filter]
        [lift_fog]
            [filter_side]
                side=$side_number
            [/filter_side]
            x,y=31,21
            radius=1
            multiturn=no
        [/lift_fog]
        {CLEAR_SHROUD $side_number 31 21 1}
        [redraw]
        [/redraw]
    [/event]

    [event]
        name=moveto
        [filter]
            x,y=47,11
            side=1,5
        [/filter]
        [sound]
            name=open-chest.wav
        [/sound]
        {VARIABLE key_found yes}
        [message]
            speaker=unit
            message= _ "There was a key in this box!"
        [/message]
    [/event]

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            x,y=$bridgex,$bridgey
            side=1,5
        [/filter]
        [if]
            [variable]
                name=unit.id
                equals=Malakar
            [/variable]
            [then]
                [message]
                    speaker=unit
                    message= _ "There is enough wood here to finish the bridge."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    message= _ "There's enough wood here to finish the bridge."
                [/message]
                [message]
                    speaker=unit
                    message= _ "It's awkward to carry, but surprisingly light."
                [/message]
            [/else]
        [/if]
    [/event]

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            x,y=15,18
            side=1,5
        [/filter]
        [if]
            [have_unit]
                x,y=15,18
                type=Drake Blademaster,Drake Burner,Drake Fighter,Fire Drake,Drake Flameheart,Drake Flare,Drake Glider,Hurricane Drake,Inferno Drake,Sky Drake,Drake Warrior,Drake Chieftain,Drake Lord,Cave Drake
            [/have_unit]
            [then]
                #doesn't make sense for a flyer to jump
                [message]
                    speaker=unit
                    message= _ "The bridge is almost finished -- one could almost jump across."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    message= _ "The bridge is almost finished -- I could almost jump across."
                [/message]
            [/else]
        [/if]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            x=15,16
            y=18,17
            side=1,5
        [/filter]
        [if]
            [variable]
                name=bridge_built
                boolean_equals=no
            [/variable]
            [then]
                [if]
                    [variable]
                        name=bridgeguy
                        equals=$unit.id
                    [/variable]
                    [then]
                        [remove_unit_overlay]
                            x,y=$x1,$y1
                            image=items/wood-pickup.png
                        [/remove_unit_overlay]
                        {VARIABLE bridge_built yes}
                        {VARIABLE bridgeguy null}
                        [terrain]
                            x,y=16,17
                            terrain=Qxu^Bp/
                        [/terrain]
                        [message]
                            speaker=unit
                            message= _ "The bridge is complete!"
                        [/message]
                        {CONDITIONAL_AWARD_ACHIEVEMENT ftf_family_reunion}
                    [/then]
                [/if]
            [/then]
        [/if]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=11,16
            side=1,5
        [/filter]
        [if]
            [variable]
                name=trapdoor_open
                boolean_equals=no
            [/variable]
            [then]
                [if]
                    [variable]
                        name=keyguy
                        equals=$unit.id
                    [/variable]
                    [then]
                        [remove_unit_overlay]
                            x,y=11,16
                            image=misc/key-overlay.png
                        [/remove_unit_overlay]
                        {VARIABLE trapdoor_open yes}
                        {VARIABLE keyguy null}
                        [unpetrify]
                            side=2
                        [/unpetrify]
                        [terrain]
                            x,y=10,15
                            terrain=Rd^Pr/o
                        [/terrain]
                        {CLEAR_FOG $side_number 8 12 3}
                        {CLEAR_FOG $side_number 7 12 3}
                        {CLEAR_FOG $side_number 10 10 3}
                        {CLEAR_SHROUD $side_number 8 12 3}
                        {CLEAR_SHROUD $side_number 7 12 3}
                        {CLEAR_SHROUD $side_number 10 10 3}
                        [redraw]
                        [/redraw]
                        [remove_item]
                            x,y=8,13
                        [/remove_item]
                        [item]
                            x,y=8,13
                            image=items/brazier-lit1.png
                            halo=halo/fire-aura.png
                            visible_in_fog=yes
                        [/item]
                        [message]
                            speaker=Cicyn
                            message= _ "Wake up! Wake up, you fools! The slaves have rebelled!"
                        [/message]
                        {UNCLEAR_FOG}
                    [/then]
                    [else]
                        [lock_view]
                        [/lock_view]
                        {CLEAR_FOG $side_number 8 12 3}
                        {CLEAR_FOG $side_number 7 12 3}
                        {CLEAR_FOG $side_number 10 10 3}
                        {CLEAR_SHROUD $side_number 8 12 3}
                        {CLEAR_SHROUD $side_number 7 12 3}
                        {CLEAR_SHROUD $side_number 10 10 3}
                        [redraw]
                        [/redraw]
                        [scroll_to]
                            x,y=8,12
                        [/scroll_to]
                        [if]
                            [variable]
                                name=garrison_notified
                                boolean_equals=no
                            [/variable]
                            [then]
                                [message]
                                    speaker=unit
                                    message= _ "There is a large human garrison sleeping here. We could attack them in their sleep, but the door is locked from the inside."
                                [/message]
                                {VARIABLE garrison_notified yes}
                            [/then]
                            [else]
                                [delay]
                                    time=1000
                                [/delay]
                            [/else]
                        [/if]
                        {UNCLEAR_FOG}
                        [unlock_view]
                        [/unlock_view]
                    [/else]
                [/if]
            [/then]
        [/if]
    [/event]

    {FTF_COMMON}

    {RESTORE_RECALL_AFTER_DISMISS_BRANCH_A}

#undef RESCUABLE_UNIT
#undef DISCOVERABLE_MONSTER
#undef DISCOVERABLE_MONSTER_CUSTOM
#undef DISCOVERABLE_GUARDIAN
[/scenario]
