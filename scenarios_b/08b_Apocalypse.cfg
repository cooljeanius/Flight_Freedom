#textdomain wesnoth-Flight_Freedom

[scenario]
    name= _ "Apocalypse"
    {MAPB 08b}
    turns=-1

    id=Apocalypse
    next_scenario="Drake_Epilogue_B"

    victory_when_enemies_defeated=no

    {STORY_APOCALYPSE}

    {BIGMAP_APOCALYPSE}

    {DAWN}
    {MORNING}
    {AFTERNOON}
    {DUSK}
    {FIRST_WATCH}
    {SECOND_WATCH}

#ifdef HAVE_UMC10_MUSIC
    {SCENARIO_MUSIC Flight_of_the_Drakes.ogg}
#else
    {SCENARIO_MUSIC battle-epic.ogg}
#endif

    {MAGI 1 (2,3,4)}

    [side]
        type=Drake Chieftain
        id=Malakar
        name= _ "Malakar"
        side=1
        {FLAG_VARIANT drake}
        canrecruit=yes
        controller=human
        recruit=Drake Hatchling,Drake Burner,Drake Glider,Drake Fighter,Drake Clasher
        unrenameable=yes
        team_name=good
        user_team_name= _ "Kakatar Tribe"
        {GOLD 120 110 100}
    [/side]
    [side]
        side=2
        {FLAG_VARIANT loyalist}
        controller=ai
        no_leader=yes
        {GOLD 175 225 275}
        recruit=Spearman,Bowman,Cavalryman,Fencer,Heavy Infantryman,Horseman,Mage
        team_name=evil
        user_team_name= _ "Wesnoth Expeditionary Force"
        hidden=yes
    [/side]
    [side]
        side=3
        {FLAG_VARIANT loyalist}
        controller=ai
        no_leader=yes
        {GOLD 225 275 325}
        recruit=Spearman,Bowman,Cavalryman,Fencer,Heavy Infantryman,Horseman,Mage,Knight,Lancer,Swordsman,White Mage
        team_name=evil
        user_team_name= _ "Wesnoth Expeditionary Force"
        hidden=yes
    [/side]
    [side]
        side=4
        {FLAG_VARIANT loyalist}
        controller=ai
        no_leader=yes
        {GOLD 225 275 325}
        recruit=Spearman,Bowman,Cavalryman,Fencer,Heavy Infantryman,Horseman,Mage,Longbowman,Lieutenant,Pikeman,Javelineer,Duelist,Shock Trooper
        team_name=evil
        user_team_name= _ "Wesnoth Expeditionary Force"
        hidden=yes
    [/side]

#define SMOKE_GFX X Y
    [item]
        x={X}
        y=$({Y}-1)
        halo=terrain/misc/smoke-A[01~12].png~CROP(0,0,72,72):100
    [/item]
    [item]
        x={X}
        y={Y}
        halo=terrain/misc/smoke-A[01~12].png~CROP(0,72,72,72):100
    [/item]
#enddef

    [event]
        name=prestart
        [recall]
            id=Hartholar
            x,y=24,42
        [/recall]
        [recall]
            id=Quemar
            x,y=25,41
        [/recall]
        [recall]
            id=Quahgakar
            x,y=26,41
        [/recall]
        {TEAM_COLOR_OVERRIDE (id="Quahgakar") yellow}
        #wmllint: recognize Morlin Ka
        [if]
            [have_unit]
                id=Morlin Ka
                search_recall_list=yes
            [/have_unit]
            [then]
                [recall]
                    id=Morlin Ka
                    x,y=26,42
                [/recall]
            [/then]
        [/if]
        [unit_overlay]
            id=Quemar
            image=misc/mage-charged.png
            duration=scenario
        [/unit_overlay]
        [unit_overlay]
            id=Quahgakar
            image=misc/mage-charged.png
            duration=scenario
        [/unit_overlay]
        {SMOKE_GFX 24 25}
        {SMOKE_GFX 25 25}
        {SMOKE_GFX 25 26}
        [item]
            x,y=24,39
            image=scenery/drake-banner.png
        [/item]
        [item]
            x,y=26,39
            image=scenery/drake-banner.png
        [/item]
        {VARIABLE num_turns_to_survive 12}
        {VARIABLE last_b_scenario 8}
    [/event]

    [event]
        name=start
        {VARIABLE disable_flashing no}
        [message]
            image=storyline/warning-icon.png
            speaker=narrator
            message= _ "<b>EPILEPSY WARNING</b>: this scenario contains flashing lights which may potentially trigger seizures for people with photosensitive epilepsy."
            [option]
                message= _ "Continue normally"
                [command]
                [/command]
            [/option]
            [option]
                message= _ "Continue without flashing lights"
                [command]
                    {VARIABLE disable_flashing yes}
                [/command]
            [/option]
        [/message]
        [message]
            speaker=Malakar
            message= _ "Mount Morogor... as majestic as the day of my ascension to Chief of my tribe..."
        [/message]
        [message]
            speaker=Hartholar
            message= _ "I recall my ascension as well. It is a true shame that war beckons at this most sacred place."
        [/message]
        [if]
            [have_unit]
                id=Morlin Ka
            [/have_unit]
            [then]
                [message]
                    speaker=Morlin Ka
                    message= _ "Blasphemy! Blasphemy! You seek to claim the mantle of Gar-Alagar himself!"
                [/message]
                [message]
                    speaker=Malakar
                    message= _ "Silence! The future of our entire race rests on our shoulders!"
                [/message]
            [/then]
        [/if]
        [message]
            speaker=Quahgakar
            message= _ "Quemar, are you prepared?"
        [/message]
        [message]
            speaker=Quemar
            message= _ "I will fulfill my duty, until my end and beyond."
        [/message]
        [message]
            speaker=Quahgakar
            message= _ "Very well. Quemar, I shall accompany you to the mouth of the volcano. Apprentices, set forth to take your places."
        [/message]
        [store_unit]
            [filter]
                id=Quemar
            [/filter]
            variable=quemar_store
            kill=yes
        [/store_unit]
        [store_unit]
            [filter]
                id=Quahgakar
            [/filter]
            variable=quahgakar_store
            kill=yes
        [/store_unit]
        [move_units_fake]
            [fake_unit]
                x=25,25,25,25,25,25,25,25,25,25
                y=41,40,39,38,37,36,35,34,33,32
                type=Drake High Magus
                side=1
            [/fake_unit]
            [fake_unit]
                x=26,25,25,25,25,25,25,25,25,25
                y=41,41,40,39,38,37,36,35,34,33
                type=Drake High Magus
                side=1
            [/fake_unit]
        [/move_units_fake]
        [unstore_unit]
            variable=quemar_store
            x,y=25,32
        [/unstore_unit]
        [unstore_unit]
            variable=quahgakar_store
            x,y=25,33
        [/unstore_unit]
        {CLEAR_VARIABLE quemar_store}
        {CLEAR_VARIABLE quahgakar_store}
        [move_unit_fake]
            x=25,23
            y=42,41
            type=Drake Magus
            side=1
        [/move_unit_fake]
        {MAGUS 23 41 1
        (
            [+variables]
                is_apprentice=yes
            [/variables]
            name=_"Apprentice"
            id=apprentice_1
            [modifications]
                {TRAIT_INTELLIGENT}
                {TRAIT_RESILIENT}
            [/modifications]
        )}
        {MAKE_LOYAL_NORMAL apprentice_1}
        [move_unit_fake]
            x=25,24
            y=42,40
            type=Drake Magus
            side=1
        [/move_unit_fake]
        {MAGUS 24 40 1
        (
            [+variables]
                is_apprentice=yes
            [/variables]
            name=_"Apprentice"
            id=apprentice_2
            [modifications]
                {TRAIT_INTELLIGENT}
                {TRAIT_RESILIENT}
            [/modifications]
        )}
        {MAKE_LOYAL_NORMAL apprentice_2}
        [move_unit_fake]
            x=25,26
            y=42,40
            type=Drake Magus
            side=1
        [/move_unit_fake]
        {MAGUS 26 40 1
        (
            [+variables]
                is_apprentice=yes
            [/variables]
            name=_"Apprentice"
            id=apprentice_3
            [modifications]
                {TRAIT_INTELLIGENT}
                {TRAIT_RESILIENT}
            [/modifications]
        )}
        {MAKE_LOYAL_NORMAL apprentice_3}
        [move_unit_fake]
            x=25,27
            y=42,41
            type=Drake Magus
            side=1
        [/move_unit_fake]
        {MAGUS 27 41 1
        (
            [+variables]
                is_apprentice=yes
            [/variables]
            name=_"Apprentice"
            id=apprentice_4
            [modifications]
                {TRAIT_INTELLIGENT}
                {TRAIT_RESILIENT}
            [/modifications]
        )}
        {MAKE_LOYAL_NORMAL apprentice_4}
        [lock_view]
        [/lock_view]
        {HIGHLIGHT_IMAGE 19 19 items/gohere.png ()}
        {HIGHLIGHT_IMAGE 31 19 items/gohere.png ()}
        {HIGHLIGHT_IMAGE 19 32 items/gohere.png ()}
        {HIGHLIGHT_IMAGE 31 32 items/gohere.png ()}
        [unlock_view]
        [/unlock_view]
        {OBJECTIVES_HEADER}
        {CONDITION_WIN ( _ "Move all four apprentices to the platforms")}
        {CONDITION_LOSE ( _ "Death of Malakar")}
        {CONDITION_LOSE ( _ "Death of an apprentice")}
        {CONDITION_LOSE ( _ "Death of Quemar")}
        {CONDITION_LOSE ( _ "Death of Quahgakar")}
        {CONDITION_LOSE ( _ "Turns run out")}
        {GOLD_CARRYOVER_STANDARD}
        {OBJECTIVES_FOOTER}
    [/event]

    [event]
        name=side 1 turn refresh
        first_time_only=no
        {MODIFY_UNIT id=Quemar moves 0}
        {MODIFY_UNIT id=Quahgakar moves 0}
    [/event]

    [event]
        name=turn 2
        [move_unit_fake]
            x=1,23
            y=36,41
            type=Hurricane Drake
        [/move_unit_fake]
        [unit]
            x,y=23,41
            side=1
            random_traits=yes
            generate_name=yes
            id=messenger_08b
            type=Hurricane Drake
        [/unit]
        {MAKE_LOYAL_NORMAL messenger_08b}
        [message]
            speaker=messenger_08b
            message= _ "The humans are closing in on Mount Morogor! Doubtless they know that to conquer its slopes would break the spirit of every drake on the island."
        [/message]
        [message]
            speaker=Quahgakar
            message= _ "Then we must make haste!"
        [/message]
    [/event]

    [event]
        name=side 1 turn 2 end
        [modify_side]
            side=2
            hidden=no
        [/modify_side]
        [move_unit_fake]
            type=Lieutenant
            side=2
            x=1,8
            y=16,15
        [/move_unit_fake]
        [unit]
            x,y=8,15
            id=NW_leader
            name=_ "Urien"
            type=Lieutenant
            canrecruit=yes
            side=2
        [/unit]
        {PLOP_ENCAMPMENT 7 15}
        [message]
            speaker=NW_leader
            message= _ "In the name of the King, Morogor shall be ours! Long live Wesnoth!"
        [/message]
    [/event]

    [event]
        name=side 2 turn 5 end
        [modify_side]
            side=3
            hidden=no
        [/modify_side]
        [move_unit_fake]
            type=General
            side=2
            x=46,47
            y=1,6
        [/move_unit_fake]
        [unit]
            x,y=47,6
            id=NE_leader
            name=_ "Galeran"
            type=General
            canrecruit=yes
            side=3
        [/unit]
        {PLOP_ENCAMPMENT 46 5}
        [message]
            speaker=NE_leader
            message= _ "Soldiers of Wesnoth! Our conquest of this island is nearly complete. Soon its riches shall be ours for the taking!"
        [/message]
    [/event]

    [event]
        name=side 3 turn 9 end
        [modify_side]
            side=4
            hidden=no
        [/modify_side]
        [move_unit_fake]
            type=Grand Marshal
            side=2
            x=50,47
            y=46,45
        [/move_unit_fake]
        [unit]
            x,y=47,45
            id=SE_leader
            name=_ "Emeric"
            type=Grand Marshal
            canrecruit=yes
            side=4
        [/unit]
        {PLOP_ENCAMPMENT 46 44}
        [message]
            speaker=SE_leader
            message= _ "We have them surrounded! Onward!"
        [/message]
    [/event]

#TODO: merge these into a single halo image since these image path functions
#are really performance-intensive
#define PLACE_LIFEFORCE_BEAMS
    [item]
        x,y=24,24
        halo=halo/lifeforce-beams/lifeforce-beam-[1~7,6~2].png~SCALE(0,960)~ROTATE(-34.22):100
        name=lifeforce_nw
    [/item]
    [item]
        x,y=26,24
        halo=halo/lifeforce-beams/lifeforce-beam-[1~7,6~2].png~SCALE(0,960)~ROTATE(34.22):100
        name=lifeforce_ne
    [/item]
    [item]
        x,y=24,25
        halo=halo/lifeforce-beams/lifeforce-beam-[1~7,6~2].png~SCALE(0,1079)~ROTATE(-149.97):100
        name=lifeforce_sw
    [/item]
    [item]
        x,y=26,25
        halo=halo/lifeforce-beams/lifeforce-beam-[1~7,6~2].png~SCALE(0,1079)~ROTATE(149.97):100
        name=lifeforce_se
    [/item]
#enddef

#define REMOVE_LIFEFORCE_BEAMS
    [remove_item]
        x,y=24,24
        image=lifeforce_nw
    [/remove_item]
    [remove_item]
        x,y=26,24
        image=lifeforce_ne
    [/remove_item]
    [remove_item]
        x,y=24,25
        image=lifeforce_sw
    [/remove_item]
    [remove_item]
        x,y=26,25
        image=lifeforce_se
    [/remove_item]
#enddef

    [event]
        name=moveto
        first_time_only=no
        [filter]
            type=Drake Magus,Drake High Magus
            side=1
            x=19,19,31,31
            y=19,32,19,32
            [filter_wml]
                [variables]
                    is_apprentice=yes
                [/variables]
            [/filter_wml]
        [/filter]
        [if]
            [have_unit]
                x=19
                y=32
                [filter_wml]
                    [variables]
                        is_apprentice=yes
                    [/variables]
                [/filter_wml]
            [/have_unit]
            [and]
                [have_unit]
                    x=19
                    y=19
                    [filter_wml]
                        [variables]
                            is_apprentice=yes
                        [/variables]
                    [/filter_wml]
                [/have_unit]
            [/and]
            [and]
                [have_unit]
                    x=31
                    y=19
                    [filter_wml]
                        [variables]
                            is_apprentice=yes
                        [/variables]
                    [/filter_wml]
                [/have_unit]
            [/and]
            [and]
                [have_unit]
                    x=31
                    y=32
                    [filter_wml]
                        [variables]
                            is_apprentice=yes
                        [/variables]
                    [/filter_wml]
                [/have_unit]
            [/and]
            [then]
                {MODIFY_UNIT id=apprentice_1 moves 0}
                {MODIFY_UNIT id=apprentice_2 moves 0}
                {MODIFY_UNIT id=apprentice_3 moves 0}
                {MODIFY_UNIT id=apprentice_4 moves 0}
                [remove_item]
                    x,y=19,19
                [/remove_item]
                [remove_item]
                    x,y=19,32
                [/remove_item]
                [remove_item]
                    x,y=31,19
                [/remove_item]
                [remove_item]
                    x,y=31,32
                [/remove_item]
                [message]
                    speaker=Quahgakar
                    message= _ "We are all in place! Let us begin the convocation at once!"
                [/message]
                #{PLACE_LIFEFORCE_BEAMS}
                [scroll_to]
                    x,y=25,25
                [/scroll_to]
                {VARIABLE survival_start_turn $turn_number}
                {VARIABLE new_turn_limit $num_turns_to_survive}
                {VARIABLE_OP new_turn_limit add $turn_number}
                [modify_turns]
                    value=$new_turn_limit
                [/modify_turns]
                {CLEAR_VARIABLE new_turn_limit}
                [objectives]
                    side=1
                    delayed_variable_substitution=yes
                    {CONDITION_WIN ( _ "Survive for $num_turns_to_survive turns ($($turn_number - $survival_start_turn) / $num_turns_to_survive)")}
                    {CONDITION_LOSE ( _ "Death of Malakar")}
                    {CONDITION_LOSE ( _ "Death of an apprentice")}
                    {CONDITION_LOSE ( _ "Death of Quemar")}
                    {CONDITION_LOSE ( _ "Death of Quahgakar")}
                    {CONDITION_LOSE ( _ "Turns run out")}
                    {GOLD_CARRYOVER_STANDARD}
                [/objectives]
                [event]
                    name=side 1 turn refresh
                    first_time_only=no
                    {MODIFY_UNIT id=apprentice_1 moves 0}
                    {MODIFY_UNIT id=apprentice_2 moves 0}
                    {MODIFY_UNIT id=apprentice_3 moves 0}
                    {MODIFY_UNIT id=apprentice_4 moves 0}
                    {MODIFY_UNIT (x,y=19,19) facing se}
                    {MODIFY_UNIT (x,y=19,32) facing ne}
                    {MODIFY_UNIT (x,y=31,19) facing sw}
                    {MODIFY_UNIT (x,y=31,32) facing nw}
                [/event]
                [event]
                    name=new turn
                    first_time_only=no
                    {VARIABLE adjusted_turn $turn_number}
                    {VARIABLE_OP adjusted_turn sub $survival_start_turn}
                    [remove_item]
                        x,y=25,25
                        image=egg
                    [/remove_item]
                    {VARIABLE turn_ratio $adjusted_turn}
                    {VARIABLE_OP turn_ratio divide $num_turns_to_survive}
                    [item]
                        x,y=25,25
                        halo=halo/blitz-shield-halo-100pct.png~O($turn_ratio)
                        name=egg
                    [/item]
                    [if]
                        [variable]
                            name=adjusted_turn
                            numerical_equals=1
                        [/variable]
                        [then]
                            [role]
                                role=concerned_human
                                type=Grand Marshal,General,Lieutenant
                                side=2,3,4
                            [/role]
                            [message]
                                role=concerned_human
                                message= _ "The lizards are conducting some strange ritual! We must stop them immediately!"
                            [/message]
                            [modify_side]
                                side=2
                                {INCOME 14 17 20}
                                [ai]
                                    [goal]
                                        [criteria]
                                            side=1
                                            type=Drake Magus,Drake High Magus
                                        [/criteria]
                                        {QUANTITY value 4 5 6}
                                    [/goal]
                                [/ai]
                            [/modify_side]
                            [modify_side]
                                side=3
                                {INCOME 14 17 20}
                                [ai]
                                    [goal]
                                        [criteria]
                                            side=1
                                            type=Drake Magus,Drake High Magus
                                        [/criteria]
                                        {QUANTITY value 4 5 6}
                                    [/goal]
                                [/ai]
                            [/modify_side]
                            [modify_side]
                                side=4
                                {INCOME 14 17 20}
                                [ai]
                                    [goal]
                                        [criteria]
                                            side=1
                                            type=Drake Magus,Drake High Magus
                                        [/criteria]
                                        {QUANTITY value 4 5 6}
                                    [/goal]
                                [/ai]
                            [/modify_side]
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=adjusted_turn
                            numerical_equals=$(floor($num_turns_to_survive / 3))
                        [/variable]
                        [then]
                            [message]
                                speaker=Malakar
                                message= _ "The humans are redoubling their efforts! Quahgakar, is there any way we can finish this ritual faster?"
                            [/message]
                            [message]
                                speaker=Quahgakar
                                message= _ "Not unless you wish to condemn all of us to a fate worse than death. But there may be an alternative..."
                            [/message]
                            [message]
                                speaker=Quemar
                                message= _ "No... not that... please..."
                            [/message]
                            [message]
                                speaker=Quahgakar
                                message= _ "It would involve the darkest of magicks, but we can force Mount Morogor to erupt. The lava flows would sweep the thinskins from our lands! And it could be done at a moment's notice."
                            [/message]
                            [message]
                                speaker=Hartholar
                                message= _ "Malakar, if we do this, Morogor will never be the same. I implore you to think carefully!"
                            [/message]
                            [message]
                                speaker=Malakar
                                message= _ "..."
                                [option]
                                    label= _ "We continue with our original plan to awaken Quemar as a dragon!"
                                    [command]
                                        [message]
                                            speaker=Hartholar
                                            message= _ "Drakes! We must hold the line just a while longer while the magi finish their work!"
                                        [/message]
                                    [/command]
                                [/option]
                                [option]
                                    label= _ "There is no time! We must purge the humans before they slaughter us all!"
                                    [command]
                                        [if]
                                            [have_unit]
                                                id=Morlin Ka
                                            [/have_unit]
                                            [then]
                                                [message]
                                                    speaker=Morlin Ka
                                                    message= _ "Turn back at once! Gar-Alagar will never forgive this!"
                                                [/message]
                                                [message]
                                                    speaker=Malakar
                                                    message= _ "My will is set. The thinskins are closing in. Either Mount Morogor erupts or we all die!"
                                                [/message]
                                            [/then]
                                        [/if]
                                        [message]
                                            speaker=Hartholar
                                            message= _ "Very well, Malakar. Drakes! Take flight at once!"
                                        [/message]
                                        [fire_event]
                                            name=lava_ending
                                        [/fire_event]
                                    [/command]
                                [/option]
                            [/message]
                        [/then]
                    [/if]
                    {CLEAR_VARIABLE adjusted_turn}
                    {CLEAR_VARIABLE turn_ratio}
                [/event]
                [event]
                    name=time over
                    [fire_event]
                        name=dragon_ending
                    [/fire_event]
                [/event]
            [/then]
            [else]
                [allow_undo]
                [/allow_undo]
            [/else]
        [/if]
    [/event]

#define ERUPTION_STEP I
    {QUAKE_NOSOUND}
    [terrain_mask]
        x,y=18,19
        alignment=even
        mask="{~add-ons/Flight_Freedom/maps_b/drake08b/eruption{I}_mask.mask}"
    [/terrain_mask]
    [redraw]
    [/redraw]
    [delay]
        time=1000
    [/delay]
#enddef

#define Q_HIT_Q_BASE ANIMATE AMOUNT
    [animate_unit]
        [filter]
            id=Quahgakar
        [/filter]
        flag=attack
        [primary_attack]
            name="staff"
        [/primary_attack]
        hits=hit
        [facing]
            x,y=25,32
        [/facing]
    [/animate_unit]
    [harm_unit]
        [filter]
            id=Quemar
        [/filter]
        [filter_second]
            id=Quahgakar
        [/filter_second]
        amount={AMOUNT}
        fire_event=no
        animate={ANIMATE}
        experience=no
    [/harm_unit]
#enddef

#"accept" ie. Quemar stoically accepts being tortured to an inch of his life to become a dragon
#define Q_HIT_Q_ACCEPT AMOUNT
    {Q_HIT_Q_BASE "no" {AMOUNT}}
#enddef

#but he's not quite as accepting of being outright sacrificed to the volcano
#define Q_HIT_Q AMOUNT
    {Q_HIT_Q_BASE "defender" {AMOUNT}}
#enddef

#define MAGIC_FLASHING
    [if]
        [variable]
            name=disable_flashing
            boolean_equals=no
        [/variable]
        [then]
            {COLOR_ADJUST 66 135 245}
            [delay]
                time=100
            [/delay]
            {COLOR_ADJUST 245 199 91}
            [delay]
                time=100
            [/delay]
            {COLOR_ADJUST 191 48 139}
            [delay]
                time=100
            [/delay]
            {COLOR_ADJUST 174 232 218}
            [delay]
                time=100
            [/delay]
            {COLOR_ADJUST 200 224 16}
            [delay]
                time=100
            [/delay]
            {COLOR_ADJUST 0 0 0}
        [/then]
    [/if]
#enddef

    [event]
        name=lava_ending
#ifdef HAVE_UMC10_MUSIC
        [music]
            name=Trite_And_Wrong.ogg
            immediate=yes
        [/music]
        [music]
            name=silence.ogg
        [/music]
#endif
        #{REMOVE_LIFEFORCE_BEAMS}
        [lock_view]
        [/lock_view]
        [change_theme]
            theme=Cutscene
        [/change_theme]
        [remove_item]
            x,y=25,25
            image=egg
        [/remove_item]
        [scroll_to_unit]
            id=Quahgakar
        [/scroll_to_unit]
        [fading_message]
            id=Quahgakar
            message= _ "Powers below, hear me! Powers above, fear me!"
            time=4000
            [time_lang]
                ja=5000
            [/time_lang]
        [/fading_message]
        [delay]
            time=1000
        [/delay]
        [fading_message]
            id=Quahgakar
            message= _ "I call upon your wrath! Accept our life force, so that your fires may be quickened!"
            time=5000
            [time_lang]
                ja=5000
            [/time_lang]
        [/fading_message]
        [scroll_to]
            x,y=19,19
        [/scroll_to]
        [animate_path]
            hex_x=19,25
            hex_y=19,25
            image=projectiles/life-force.png
            frames=40
            frame_length=20
        [/animate_path]
        [kill]
            x,y=19,19
            animate=yes
            fire_event=no
        [/kill]
        [scroll_to]
            x,y=31,19
        [/scroll_to]
        [animate_path]
            hex_x=31,25
            hex_y=19,25
            image=projectiles/life-force.png
            frames=40
            frame_length=20
        [/animate_path]
        [kill]
            x,y=31,19
            animate=yes
            fire_event=no
        [/kill]
        [scroll_to]
            x,y=19,32
        [/scroll_to]
        [animate_path]
            hex_x=19,25
            hex_y=32,26
            image=projectiles/life-force.png
            frames=40
            frame_length=20
        [/animate_path]
        [kill]
            x,y=19,32
            animate=yes
            fire_event=no
        [/kill]
        [scroll_to]
            x,y=31,32
        [/scroll_to]
        [animate_path]
            hex_x=31,25
            hex_y=32,26
            image=projectiles/life-force.png
            frames=40
            frame_length=20
        [/animate_path]
        [kill]
            x,y=31,32
            animate=yes
            fire_event=no
        [/kill]
        [scroll_to_unit]
            id=Quahgakar
        [/scroll_to_unit]
        [fading_message]
            id=Quahgakar
            message= _ "Accept my sacrifice of blood, so that your hatred may surge forth!"
            time=5000
            [time_lang]
                ja=5000
            [/time_lang]
        [/fading_message]
        [store_unit]
            [filter]
                id=Quemar
            [/filter]
            variable=quemar_store
        [/store_unit]
        {VARIABLE damage_amt $quemar_store.hitpoints}
        {CLEAR_VARIABLE quemar_store}
        {VARIABLE_OP damage_amt sub 30}
        {Q_HIT_Q ($damage_amt)}
        {Q_HIT_Q 10}
        {Q_HIT_Q 10}
        {Q_HIT_Q 10}
        {CLEAR_VARIABLE damage_amt}
        [fading_message]
            id=Quahgakar
            message= _ "And now I offer myself to the flames."
            time=4000
            [time_lang]
                ja=4000
            [/time_lang]
        [/fading_message]
        [store_unit]
            [filter]
                id=Quahgakar
            [/filter]
            variable=quahgakar_store
            kill=yes
        [/store_unit]
        [move_unit_fake]
            x=25,25
            y=33,32
            side=1
            type=Drake High Magus
        [/move_unit_fake]
        [unstore_unit]
            variable=quahgakar_store
            x,y=25,32
        [/unstore_unit]
        [delay]
            time=750
        [/delay]
        [kill]
            id=Quahgakar
            animate=no
            fire_event=no
        [/kill]
        [move_unit_fake]
            x=25,25
            y=32,31
            side=1
            type=Drake High Magus
        [/move_unit_fake]
        [unstore_unit]
            variable=quahgakar_store
            x,y=25,31
        [/unstore_unit]
        [kill]
            id=Quahgakar
            animate=yes
            fire_event=no
        [/kill]
        {CLEAR_VARIABLE quahgakar_store}
        [delay]
            time=1000
        [/delay]
        {QUAKE rumble.ogg}
        [delay]
            time=1000
        [/delay]
        {QUAKE rumble.ogg}
        [delay]
            time=1500
        [/delay]
        {COLOR_ADJUST 70 -20 -20}
        {QUAKE_BIG rumble.ogg}
        [delay]
            time=1500
        [/delay]
        [scroll_to_unit]
            id=Malakar
        [/scroll_to_unit]
        [fading_message]
            id=Malakar
            message= _ "What... what have we done..."
            time=4000
            [time_lang]
                ja=4000
            [/time_lang]
        [/fading_message]
        [remove_item]
            x,y=24,24
        [/remove_item]
        [remove_item]
            x,y=24,25
        [/remove_item]
        [remove_item]
            x,y=25,24
        [/remove_item]
        [remove_item]
            x,y=25,25
        [/remove_item]
        [remove_item]
            x,y=25,26
        [/remove_item]
        [scroll_to]
            x,y=25,25
        [/scroll_to]
        {ERUPTION_STEP 1}
        {ERUPTION_STEP 2}
        {ERUPTION_STEP 3}
        {ERUPTION_STEP 4}
        {ERUPTION_STEP 5}
        [delay]
            time=1000
        [/delay]
        {QUAKE_BIG rumble.ogg}
        {COLOR_ADJUST 200 0 0}
        [delay]
            time=250
        [/delay]
        [terrain_mask]
            x,y=0,0
            alignment=even
            mask="{~add-ons/Flight_Freedom/maps_b/drake08b/erupted_final_mask.mask}"
        [/terrain_mask]
        [delay]
            time=250
        [/delay]
        {COLOR_ADJUST 70 -20 -20}
        [remove_item]
            x,y=24,39
        [/remove_item]
        [redraw]
        [/redraw]
        [delay]
            time=1000
        [/delay]
        [unlock_view]
        [/unlock_view]
        [store_unit]
            [filter]
                [not]
                    formula=self.flying
                [/not]
                #since drake movetypes don't have flying=yes
                [not]
                    {FLYING_DRAKES_FILTER_KEY}
                [/not]
                [filter_location]
                    terrain=Qlf
                [/filter_location]
            [/filter]
            variable=victims_store
            kill=no
        [/store_unit]
        [shuffle_list]
            variable=victims_store
        [/shuffle_list]
        [for]
            variable=i
            start=0
            end="$($victims_store.length-1)"
            [do]
                [kill]
                    x=$victims_store[$i].x
                    y=$victims_store[$i].y
                    animate=yes
                    fire_event=no
                    [primary_attack]
                        name="fire"
                        range=ranged
                        type=fire
                        damage=0
                        number=0
                    [/primary_attack]
                [/kill]
            [/do]
        [/for]
        {CLEAR_VARIABLE victims_store}
        {COLOR_ADJUST 50 -15 -15}
        [delay]
            time=100
        [/delay]
        {COLOR_ADJUST 30 -10 -10}
        [delay]
            time=100
        [/delay]
        {COLOR_ADJUST 10 -5 -5}
        [delay]
            time=100
        [/delay]
        {COLOR_ADJUST 0 0 0}
        [change_theme]
            theme=
        [/change_theme]
        [endlevel]
            result=victory
            bonus=yes
            music=silence.ogg
        [/endlevel]
    [/event]

    [event]
        name=dragon_ending
        [lock_view]
        [/lock_view]
        [change_theme]
            theme=Cutscene
        [/change_theme]
        [scroll_to_unit]
            id=Quahgakar
        [/scroll_to_unit]
        [fading_message]
            id=Quahgakar
            message= _ "Breath of Gar-Alagar! Spirit of Morogor! Hear my voice."
            time=5000
            [time_lang]
                ja=5000
            [/time_lang]
        [/fading_message]
        [delay]
            time=1000
        [/delay]
        [fading_message]
            id=Quahgakar
            message= _ "Accept your servant and infuse him with your might!"
            time=4000
            [time_lang]
                ja=4000
            [/time_lang]
        [/fading_message]
        #some sfx here
        [delay]
            time=1000
        [/delay]
        [fading_message]
            id=Quemar
            message= _ "Hear me, a humble servant."
            time=4000
            [time_lang]
                ja=4000
            [/time_lang]
        [/fading_message]
        [delay]
            time=1000
        [/delay]
        [store_unit]
            [filter]
                id=Quemar
            [/filter]
            variable=quemar_store
        [/store_unit]
        {VARIABLE damage_amt $quemar_store.hitpoints}
        {CLEAR_VARIABLE quemar_store}
        {VARIABLE_OP damage_amt sub 30}
        {Q_HIT_Q_ACCEPT ($damage_amt)}
        [fading_message]
            id=Quemar
            message= _ "I walk the path of my ancestors."
            time=4000
            [time_lang]
                ja=4000
            [/time_lang]
        [/fading_message]
        [delay]
            time=500
        [/delay]
        {Q_HIT_Q_ACCEPT 10}
        [fading_message]
            id=Quemar
            message= _ "I walk to the edge of death."
            time=4000
            [time_lang]
                ja=4000
            [/time_lang]
        [/fading_message]
        [delay]
            time=500
        [/delay]
        {Q_HIT_Q_ACCEPT 10}
        [fading_message]
            id=Quemar
            message= _ "And return with new life."
            time=4000
            [time_lang]
                ja=4000
            [/time_lang]
        [/fading_message]
        [delay]
            time=500
        [/delay]
        {Q_HIT_Q_ACCEPT 9}
        {CLEAR_VARIABLE damage_amt}
        [fading_message]
            id=Quahgakar
            message= _ "Open the way to the heart of the fire!"
            time=4000
            [time_lang]
                ja=4000
            [/time_lang]
        [/fading_message]
        [animate_unit]
            flag=lrfireball_attack
            [filter]
                id=Quahgakar
            [/filter]
        [/animate_unit]
        [delay]
            time=1000
        [/delay]
        [if]
            [variable]
                name=disable_flashing
                boolean_equals=no
            [/variable]
            [then]
                {COLOR_ADJUST 3 165 252}
            [/then]
        [/if]
        [scroll_to]
            x,y=25,29
            immediate=yes
        [/scroll_to]
        [delay]
            time=100
        [/delay]
        {COLOR_ADJUST 0 0 0}
        [for]
            start=5
            end=1
            step=-1
            [do]
                [item]
                    x,y=25,29
                    halo=halo/circle-advance-1-$i|.png~O(0.5)~SCALE(0,504)
                    name=magic_bridge
                [/item]
                [redraw]
                [/redraw]
                [delay]
                    time=500
                [/delay]
                [remove_item]
                    x,y=25,29
                    image=magic_bridge
                [/remove_item]
            [/do]
        [/for]
        [item]
            x,y=25,29
            halo=halo/circle-advance-1-1.png~O(0.7)~SCALE(0,504)
            name=magic_bridge
        [/item]
        [redraw]
        [/redraw]
        [store_unit]
            [filter]
                id=Quemar
            [/filter]
            variable=quemar_store
            kill=yes
        [/store_unit]
        {VARIABLE quemar_store.type "Drake High Magus no_death_anim"}
        [move_unit_fake]
            x=25,25,25,25,25,25,25,25
            y=32,31,30,29,28,27,26,25
            type=Drake High Magus
            side=1
        [/move_unit_fake]
        [unstore_unit]
            variable=quemar_store
            x,y=25,25
        [/unstore_unit]
        [remove_item]
            x,y=25,29
            image=magic_bridge
        [/remove_item]
        [for]
            start=1
            end=5
            step=1
            [do]
                [item]
                    x,y=25,29
                    halo=halo/circle-advance-1-$i|.png~O(0.5)~SCALE(0,504)
                    name=magic_bridge
                [/item]
                [redraw]
                [/redraw]
                [delay]
                    time=500
                [/delay]
                [remove_item]
                    x,y=25,29
                    image=magic_bridge
                [/remove_item]
            [/do]
        [/for]
        {CLEAR_VARIABLE quemar_store}
        #{REMOVE_LIFEFORCE_BEAMS}
        [fading_message]
            id=Quemar
            message= _ "I surrender, to be reborn in flame."
            time=4000
            [time_lang]
                ja=4000
            [/time_lang]
        [/fading_message]
        [kill]
            id=Quemar
            animate=yes
            fire_event=no
        [/kill]
        [remove_item]
            x,y=25,25
            image=egg
        [/remove_item]
        [animate_path]
            hex_x=25,25
            hex_y=25,26
            image=halo/blitz-shield-halo-100pct.png
            frames=40
            frame_length=25
        [/animate_path]
        [for]
            start=100
            end=0
            step=-2
            [do]
                [item]
                    x,y=25,26
                    halo=halo/blitz-shield-halo-100pct.png~CROP(0,$i,0,100)
                    name=egg
                [/item]
                [delay]
                    time=25
                [/delay]
                [remove_item]
                    x,y=25,26
                    image=egg
                [/remove_item]
            [/do]
        [/for]
        [scroll_to_unit]
            id=Quahgakar
        [/scroll_to_unit]
        [fading_message]
            id=Quahgakar
            message= _ "Malakar, it is done."
            time=4000
            [time_lang]
                ja=4000
            [/time_lang]
        [/fading_message]
        [delay]
            time=1000
        [/delay]
        {QUAKE rumble.ogg}
        [delay]
            time=4000
        [/delay]
        {MAGIC_FLASHING}
        {QUAKE_BIG rumble.ogg}
        [scroll_to_unit]
            id=Hartholar
        [/scroll_to_unit]
        [fading_message]
            id=Hartholar
            message= _ "Quahgakar, what's happening?"
            time=4000
            [time_lang]
                ja=4000
            [/time_lang]
        [/fading_message]
        [delay]
            time=1000
        [/delay]
        {MAGIC_FLASHING}
        [music]
            name=frantic-old.ogg
            immediate=yes
        [/music]
        [music]
            name=silence.ogg
        [/music]
        [scroll_to_unit]
            id=Quahgakar
        [/scroll_to_unit]
        [fading_message]
            id=Quahgakar
            message= _ "The ritual, it's going out of control!"
            time=5000
            [time_lang]
                ja=5000
            [/time_lang]
        [/fading_message]
        {MAGIC_FLASHING}
        {QUAKE rumble.ogg}
        [scroll_to]
            x,y=25,26
        [/scroll_to]
        [get_zoom]
        [/get_zoom]
        [zoom]
            factor=0.8
        [/zoom]
        {MAGIC_FLASHING}
        [delay]
            time=500
        [/delay]
        [for]
            start=216
            end=2160
            step=216
            [do]
                [item]
                    x,y=25,26
                    halo=halo/deadzone.png~CS(100,120,-60)~SCALE($i,$i)
                    name=pulse
                [/item]
                [delay]
                    time=50
                [/delay]
                [remove_item]
                    x,y=25,26
                    image=pulse
                [/remove_item]
            [/do]
        [/for]
        [harm_unit]
            [filter]
                side=1
            [/filter]
            amount=999
            kill=no
            fire_event=no
        [/harm_unit]
        [redraw]
        [/redraw]
        [delay]
            time=2000
        [/delay]
        [zoom]
            factor=$zoom
        [/zoom]
        {CLEAR_VARIABLE zoom}
        [fading_message]
            id=Quahgakar
            message= _ "The life force needed was much greater than I had imagined... the spell stole what it sought from us!"
            time=10000
            [time_lang]
                ja=10000
            [/time_lang]
        [/fading_message]
        [unlock_view]
        [/unlock_view]
        [unit]
            side=2
            x,y=32,50
            type=Grand Marshal
            id=Yrynyc
            name= _ "Yrynyc"
        [/unit]
        [for]
            start=0
            end=23
            [do]
                [set_variable]
                    name=spawn_type
                    rand="Master at Arms","Iron Mauler","Great Mage","Master Bowman","Halberdier","Royal Guard","Master Bowman","Halberdier","Royal Guard","Pikeman","Swordsman"
                [/set_variable]
                [unit]
                    side=2
                    x,y=32,50
                    type=$spawn_type
                    generate_name=yes
                    random_traits=yes
                [/unit]
            [/do]
        [/for]
        {CLEAR_VARIABLE spawn_type}
        [store_unit]
            [filter]
                id=Malakar
            [/filter]
            kill=no
            variable=malakar_store
        [/store_unit]
        {VARIABLE malakar_x $malakar_store.x}
        {VARIABLE malakar_y $malakar_store.y}
        {CLEAR_VARIABLE malakar_store}
        [unit]
            side=2
            x,y=$malakar_x,$malakar_y
            type=Cavalier
            generate_name=yes
            random_traits=yes
            id=capturer_1
        [/unit]
        [hide_unit]
            id=capturer_1
        [/hide_unit]
        [store_unit]
            [filter]
                id=capturer_1
            [/filter]
            kill=no
            variable=capturer_store
        [/store_unit]
        {VARIABLE capturer_x $capturer_store.x}
        {VARIABLE capturer_y $capturer_store.y}
        [move_unit_fake]
            x=32,$capturer_x
            y=50,$capturer_y
            side=2
            type=Cavalier
        [/move_unit_fake]
        [unhide_unit]
            id=capturer_1
        [/unhide_unit]
        [unit]
            side=2
            x,y=$malakar_x,$malakar_y
            type=Grand Knight
            generate_name=yes
            random_traits=yes
            id=capturer_2
        [/unit]
        [hide_unit]
            id=capturer_2
        [/hide_unit]
        [store_unit]
            [filter]
                id=capturer_2
            [/filter]
            kill=no
            variable=capturer_store
        [/store_unit]
        {VARIABLE capturer_x $capturer_store.x}
        {VARIABLE capturer_y $capturer_store.y}
        [move_unit_fake]
            x=32,$capturer_x
            y=50,$capturer_y
            side=2
            type=Grand Knight
        [/move_unit_fake]
        [unhide_unit]
            id=capturer_2
        [/unhide_unit]
        {CLEAR_VARIABLE malakar_x}
        {CLEAR_VARIABLE malakar_y}
        {CLEAR_VARIABLE capturer_x}
        {CLEAR_VARIABLE capturer_y}
        {CLEAR_VARIABLE capturer_store}
        [change_theme]
            theme=
        [/change_theme]
        [message]
            speaker=capturer_1
            message= _ "We have found the last of the rebels! Shall we kill them?"
        [/message]
        [message]
            speaker=Yrynyc
            message= _ "No. Bind them in iron fetters and muzzle their snouts. I intend to make an example out of them, so all drakes may fear the name of our King!"
        [/message]
        {VARIABLE dragon_ritual yes}
        #preparations for A branch
        [store_unit]
            [filter]
                id=Malakar
            [/filter]
            variable=malakar_store
        [/store_unit]
        {VARIABLE_OP malexp to_variable malakar_store.experience}
        {VARIABLE_OP maltype to_variable malakar_store.type}
        {CLEAR_VARIABLE malakar_store}
        [if]
            [variable]
                name=have_hartholar
                boolean_equals=yes
            [/variable]
            [then]
                {FULL_HEAL id=Hartholar}
                {MAKE_LOYAL_NORMAL Hartholar}
                [store_unit]
                    [filter]
                        id=Hartholar
                    [/filter]
                    variable=hartholar_store
                [/store_unit]
            [/then]
        [/if]
        [if]
            [variable]
                name=have_morlin
                boolean_equals=yes
            [/variable]
            [then]
                {FULL_HEAL (id=Morlin Ka)}
                [store_unit]
                    [filter]
                        id=Morlin Ka
                    [/filter]
                    variable=morlin_store
                [/store_unit]
            [/then]
        [/if]
        [kill]
            side=1
            animate=no
            fire_event=no
        [/kill]
        [disallow_recruit]
            side=1
            type=Drake Burner
        [/disallow_recruit]
        [disallow_recruit]
            side=1
            type=Drake Clasher
        [/disallow_recruit]
        [disallow_recruit]
            side=1
            type=Drake Fighter
        [/disallow_recruit]
        [disallow_recruit]
            side=1
            type=Drake Glider
        [/disallow_recruit]
        [disallow_recruit]
            side=1
            type=Saurian Skirmisher
        [/disallow_recruit]
        [disallow_recruit]
            side=1
            type=Saurian Augur
        [/disallow_recruit]
        [disallow_recruit]
            side=1
            type=Saurian Headhunter
        [/disallow_recruit]
        [disallow_recruit]
            side=1
            type=Saurian Skald
        [/disallow_recruit]
        [disallow_recruit]
            side=1
            type=Saurian Assassin
        [/disallow_recruit]
        [endlevel]
            result=victory
            carryover_report=no
            linger_mode=yes
            bonus=no
            music=silence.ogg
            next_scenario=Rebellion
        [/endlevel]
    [/event]

    {FREEDOM_DEATHS_BRANCHB}

    [event]
        name=die
        [filter]
            id=Quemar,Quahgakar
        [/filter]
        [message]
            speaker=Quahgakar
            message= _ "No! We cannot complete the ritual!"
        [/message]
        [endlevel]
            result=defeat
            music=defeat.ogg,defeat2.ogg
        [/endlevel]
    [/event]

    [event]
        name=attack
        [filter_second]
            type=Drake Magus,Drake High Magus
            side=1
            [filter_wml]
                [variables]
                    is_apprentice=yes
                [/variables]
            [/filter_wml]
        [/filter_second]
        [message]
            speaker=Quahgakar
            message= _ "We must protect the apprentices at all cost! Only with their combined will can we contain the energies we hope to let forth!"
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            type=Drake Magus,Drake High Magus
            side=1
            [filter_wml]
                [variables]
                    is_apprentice=yes
                [/variables]
            [/filter_wml]
        [/filter]
        [message]
            speaker=Quahgakar
            message= _ "No! We cannot complete the ritual!"
        [/message]
        [endlevel]
            result=defeat
            music=defeat.ogg,defeat2.ogg
        [/endlevel]
    [/event]

    [event]
        name=victory
        {CLEAR_VARIABLE num_turns_to_survive}
        {CLEAR_VARIABLE survival_start_turn}
        {CLEAR_VARIABLE disable_flashing}
    [/event]

    {FTF_COMMON}

#undef SMOKE_GFX
#undef PLACE_LIFEFORCE_BEAMS
#undef REMOVE_LIFEFORCE_BEAMS
#undef ERUPTION_STEP
#undef Q_HIT_Q_BASE
#undef Q_HIT_Q
#undef Q_HIT_Q_ACCEPT
#undef MAGIC_FLASHING

[/scenario]
